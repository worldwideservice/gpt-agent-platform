# Alertmanager Configuration
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –∞–ª–µ—Ä—Ç–∞—Ö
#
# –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ù–ê–°–¢–†–û–ô–ö–ï:
# 1. –î–ª—è Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ SMTP –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∏–∂–µ
# 2. –î–ª—è Slack —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –¥–æ–±–∞–≤—å—Ç–µ webhook URL –≤ —Å–µ–∫—Ü–∏—é slack_configs
# 3. –î–ª—è Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ URL –≤ —Å–µ–∫—Ü–∏–∏ webhook_configs

global:
  resolve_timeout: 5m
  # SMTP Configuration (use environment variables)
  # Set these in monitoring/.env file:
  # SMTP_HOST=smtp.gmail.com:587
  # SMTP_FROM=alerts@yourdomain.com
  # SMTP_USER=your-email@gmail.com
  # SMTP_PASS=your-app-password
  smtp_smarthost: ${SMTP_HOST}
  smtp_from: ${SMTP_FROM}
  smtp_auth_username: ${SMTP_USER}
  smtp_auth_password: ${SMTP_PASS}
  smtp_require_tls: true

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤
route:
  receiver: 'default'
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  routes:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
    - match:
        severity: critical
      receiver: 'critical-alerts'
      continue: true
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 5m

# –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true

  - name: 'critical-alerts'
    # Email notifications for critical alerts
    email_configs:
      - to: ${ALERT_EMAIL_TO}
        headers:
          Subject: 'üö® SEV1 CRITICAL: {{ .GroupLabels.alertname }}'
        html: |
          <!DOCTYPE html>
          <html>
          <body style="font-family: Arial, sans-serif;">
            <div style="background-color: #dc3545; color: white; padding: 20px; border-radius: 5px;">
              <h1>üö® CRITICAL ALERT (SEV 1)</h1>
            </div>
            <div style="padding: 20px;">
              <h2>{{ .GroupLabels.alertname }}</h2>
              <p><strong>Severity:</strong> {{ .GroupLabels.severity }}</p>
              <p><strong>Component:</strong> {{ .GroupLabels.component }}</p>
              <p><strong>Description:</strong></p>
              <ul>
              {{ range .Alerts }}
                <li>{{ .Annotations.description }}</li>
              {{ end }}
              </ul>
              <p><strong>Started at:</strong> {{ .Alerts[0].StartsAt }}</p>
              {{ if .Alerts[0].Annotations.runbook }}
              <p><a href="{{ .Alerts[0].Annotations.runbook }}" style="background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">View Runbook</a></p>
              {{ end }}
              {{ if .Alerts[0].Annotations.dashboard }}
              <p><a href="{{ .Alerts[0].Annotations.dashboard }}">View Dashboard</a></p>
              {{ end }}
            </div>
          </body>
          </html>
        send_resolved: true

    # Slack integration (set SLACK_WEBHOOK_URL in .env)
    slack_configs:
      - api_url: ${SLACK_WEBHOOK_URL}
        channel: '#alerts-critical'
        title: 'üö® SEV1 CRITICAL: {{ .GroupLabels.alertname }}'
        title_link: '{{ if .Alerts[0].Annotations.dashboard }}{{ .Alerts[0].Annotations.dashboard }}{{ end }}'
        text: |
          *Component:* {{ .GroupLabels.component }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          {{ if .Alerts[0].Annotations.runbook }}*Runbook:* {{ .Alerts[0].Annotations.runbook }}{{ end }}
        color: 'danger'
        send_resolved: true
        actions:
          - type: button
            text: 'View Dashboard'
            url: '{{ if .Alerts[0].Annotations.dashboard }}{{ .Alerts[0].Annotations.dashboard }}{{ end }}'
          - type: button
            text: 'View Runbook'
            url: '{{ if .Alerts[0].Annotations.runbook }}{{ .Alerts[0].Annotations.runbook }}{{ end }}'

  - name: 'warning-alerts'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true
    # Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # email_configs:
    #   - to: 'team@yourdomain.com'
    #     headers:
    #       Subject: 'Warning: {{ .GroupLabels.alertname }}'

# –ò–Ω–≥–∏–±–∏—Ç–æ—Ä—ã (–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∞–ª–µ—Ä—Ç–æ–≤)
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']

