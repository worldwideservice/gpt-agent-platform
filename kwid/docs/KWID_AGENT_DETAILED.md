# Детальный профиль агента (World Wide Services)

> Данные собраны из `../raw/scrape/forms/ai-agent-edit.snapshot.json` и связанных HTML-страниц  
> Актуально на: 31 января 2025

Документ фиксирует все настройки штатного агента (`id=553`) в панели KWID, чтобы можно было полностью воспроизвести профиль в собственной копии продукта.

---

## 1. Общие сведения

- **Имя:** `АИ ассистент` (пустой пробел в конце — так в исходных данных).
- **Статус:** активен.
- **Тип:** `sales_manager`.
- **LLM модель:** `OpenAI GPT-5` (`llm_model_id = 6`).
- **Системный промпт:** полный текст сохранён в snapshot (см. файл, содержит строгие инструкции отвечать только на английском, шаги диалога, запрет на эмодзи, описание компании и услуг).
- **Задержка ответа:** `response_delay = 45` секунд (используется для имитации «погодите» в интерфейсе).

### Пользовательский ввод
- **Ручная генерация (`manual_generation`):** по умолчанию `false`, но UI содержит скрытый toggle “Проверять перед отправкой” — при включении сообщения появляются в поле ввода для ручной отправки. Требуется записать Livewire payload `data.manual_generation -> true/false`.
- **Copilot (`copilot_enabled`):** выключен (`false`). Тоггл в UI отображается (тот же блок, что и ручная генерация).
- **Fallback message:**  
  ```
  Это сообщение будет показано, когда агент не сможет найти релевантную информацию в базе знаний.
  ```
  Значение хранится в `data.knowledge_base_fallback_message` (в snapshot пустое).

### Знаниевая база
- **`all_knowledge_base = true`** — агент использует все статьи.
- **`knowledgeCategories`** — массив пустой (все категории разрешены). Тоггл “Доступ ко всем категориям” уже задокументирован (`../raw/scrape/actions/agent_toggle_all_knowledge_base.*`).

---

## 2. CRM Kommo — связь с воронками

Параметр `pipeline_settings` описывает, где агент может работать. Структура:

```
"pipeline_settings": {
  "11689563": { "is_active": true,  "all_statuses": true,  "statuses": [] },
  "11689575": { "is_active": true,  "all_statuses": true,  "statuses": [] },
  "11689626": { "is_active": true,  "all_statuses": true,  "statuses": [] },
  "11689630": { "is_active": true,  "all_statuses": true,  "statuses": [] },
  "10672019": { "is_active": false, "all_statuses": true,  "statuses": [] },
  "10672059": { "is_active": false, "all_statuses": true,  "statuses": [] }
}
```

- Первые четыре воронки активны, оставшиеся отключены. На UI для каждой воронки есть отдельный toggle + multiselect «Выберите этапы сделок».
- Все активные воронки используют вариант “Все этапы”. Для реплики нужно обрабатывать два режима: `all_statuses = true` и выбор конкретного списка статусов.
- Livewire команды `mountFormComponentAction('data.nastroiki-voronok', 'sync_pipelines')` подтягивают свежие воронки из Kommo — захвачены в `../raw/scrape/actions/sync_pipelines.*`.

---

## 3. Источники обращений (каналы)

```
"channels": {
  "all_sources": true,
  "sources": []
}
```

- Глобальный переключатель “Все каналы” (`channels-all-switch`) включён.  
- Локальная настройка по каналам (email, whatsapp и т.д.) находится в `ai-agent-edit.html` → `data.sources`. В snapshot `sources` пустой массив, что соответствует “все активны”.
- Тест `tests/e2e/agent-channels.spec.ts` уже фиксирует сценарий включение/выключение email и `all_sources`.

---

## 4. Права чтения/записи в Kommo

### Чтение контактов
```
"contacts_read_settings": ["name", "responsible_user_id", "created_at", "tags", "cf_438092", "cf_491700"]
```

### Запись контактов
```
"contacts_write_settings": [
  { "field_id": "cf_438092", "overwrite": true,
    "prompt": "когда клиент прописал электронный адрес его нужно вписать в поле \"Email\"" }
]
```

### Чтение сделок
```
"leads_read_settings": ["name", "responsible_user_id", "status_id", "cf_564832", "cf_878912"]
```

### Запись сделок
```
"leads_write_settings": [
  { "field_id": "cf_564832", "overwrite": true,
    "prompt": "Когда клиент говорит о услуге которая его интересует нужно из выпадающего списка выбрать услугу" },
  { "field_id": "cf_878912", "overwrite": true,
    "prompt": "когда клиент прописал электронный адрес, в данном поле нужно отметить, что емейл есть " }
]
```

> Для точного воспроизведения нужно выяснить “человеческие” названия полей Kommo (`cf_*`). Они видны в настройках CRM; захватить можно через Kommo API или DOM модалки. Сейчас в snapshot — только технические идентификаторы.

---

## 5. Дополнительные параметры

- **Создание задачи при отсутствии ответа (`knowledge_not_found_task`)** — в текущем агенте отключено (`false`). Payload enable/disable уже есть в `../raw/scrape/actions/agent_toggle_knowledge_not_found_task.*`.
- **Поля `componentFileAttachments`, `mounted*`** — стандартная часть Livewire snapshot (можно игнорировать при репликации UI).
- **`created_at / updated_at`** — реальные таймстемпы в UTC (используются в таблице агентов).

---

## 6. Что ещё собрать для 100% копии

1. **`manual_generation`** — записать Livewire запросы на включение/выключение.
2. **Пайплайны** — поймать ответ Livewire на сохранение, когда включены выборочные статусы (не только `all_statuses`).
3. **Коммо поля** — снять названия полей `cf_*` через Kommo UI/API и добавить расшифровку в документацию.
4. **Fallback message + URL** — если в UI есть опция «Указать ссылку», зафиксировать строку и Livewire payload.

Этот документ можно использовать как единый источник требований при разработке собственной формы редактирования агента. Все значения уже приведены к структуре, которую возвращает Filament/Livewire в KWID.
