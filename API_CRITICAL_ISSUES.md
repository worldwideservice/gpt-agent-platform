# –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ BACKEND API
## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–æ–±–ª–µ–º, —Ç—Ä–µ–±—É—é—â–∏—Ö –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò (MUST FIX BEFORE PRODUCTION)

### 1. –û–¢–°–£–¢–°–¢–í–ò–ï –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
- **–°—Ç–∞—Ç—É—Å**: –í–°–ï endpoints –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–§–∞–π–ª**: `/services/api/src/routes/*.ts` (–≤—Å–µ route files)
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT/Bearer —Ç–æ–∫–µ–Ω–∞
- **–†–∏—Å–∫**: –õ—é–±–æ–π –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å agents, —É–ø—Ä–∞–≤–ª—è—Ç—å CRM –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å JWT middleware, –ø—Ä–æ–≤–µ—Ä—è—Ç—å token –Ω–∞ –≤—Å–µ—Ö protected routes

**–ü—Ä–∏–º–µ—Ä —É—è–∑–≤–∏–º–æ–≥–æ –∫–æ–¥–∞**:
```typescript
fastify.get('/agents', async (request, reply) => {
  const query = listQuerySchema.parse(request.query)
  // –ë–ï–ó –ü–†–û–í–ï–†–ö–ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò!
  const result = await listAgents(supabase, query)
})
```

---

### 2. –û–¢–°–£–¢–°–¢–í–ò–ï –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò (IDOR - Insecure Direct Object References)
- **–°—Ç–∞—Ç—É—Å**: –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç orgId, –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- **–§–∞–π–ª**: 
  - `/services/api/src/routes/agents.ts:50-84`
  - `/services/api/src/routes/crm.ts:237-258`
  - `/services/api/src/routes/kommo.ts:257-267`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –õ—é–±–æ–π –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —á—É–∂–∏–º –¥–∞–Ω–Ω—ã–º —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–±–æ—Ä orgId
- **–†–∏—Å–∫**: Data breach, –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è—Ç—å `request.user.orgId === query.orgId` –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º

**–ê—Ç–∞–∫–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ**:
```bash
# –ü–æ–ª—É—á–∏—Ç—å agents –≤—Å–µ—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
for uuid in $(uuidgen | head -1000000); do
  curl "http://api.example.com/agents?orgId=$uuid" | grep -i agent
done
```

---

### 3. –ù–ï–ë–ï–ó–û–ü–ê–°–ù–ê–Ø CORS –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
- **–°—Ç–∞—Ç—É—Å**: –†–∞–∑—Ä–µ—à–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- **–§–∞–π–ª**: `/services/api/src/server.ts:111`
- **–ü—Ä–æ–±–ª–µ–º–∞**: `origin: true, credentials: true` = `Access-Control-Allow-Origin: *`
- **–†–∏—Å–∫**: CSRF –∞—Ç–∞–∫–∏, XSS exploits
- **–†–µ—à–µ–Ω–∏–µ**: –Ø–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä—è–µ–º—ã—Ö –¥–æ–º–µ–Ω–æ–≤

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```typescript
app.register(cors, { origin: true, credentials: true })
```

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∫–æ–¥**:
```typescript
app.register(cors, {
  origin: ['https://app.example.com', 'https://admin.example.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
})
```

---

### 4. SERVICE_ROLE_KEY –í–ï–ó–î–ï (–æ–±—Ö–æ–¥ RLS)
- **–°—Ç–∞—Ç—É—Å**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –∏—Å–ø–æ–ª—å–∑—É—é—Ç privileged –∫–ª—é—á
- **–§–∞–π–ª**: `/services/api/src/lib/supabase.ts:12`
- **–ü—Ä–æ–±–ª–µ–º–∞**: SERVICE_ROLE_KEY –æ–±—Ö–æ–¥–∏—Ç Row Level Security (RLS) –ø–æ–ª–∏—Ç–∏–∫–∏
- **–†–∏—Å–∫**: –ù–µ—Ç —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î; SQL injection –∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
- **–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å anon key –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ RLS –ø–æ–ª–∏—Ç–∏–∫–∏; –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å authorization checks –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥**:
```typescript
cachedClient = createClient<Database>(url, serviceRoleKey, {
  auth: {
    persistSession: false,
    autoRefreshToken: false,
  },
})
```

---

### 5. –û–¢–°–£–¢–°–¢–í–ò–ï GRACEFUL SHUTDOWN
- **–°—Ç–∞—Ç—É—Å**: –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ SIGTERM/SIGINT —Å–∏–≥–Ω–∞–ª–æ–≤
- **–§–∞–π–ª**: `/services/api/src/server.ts:143-153`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –¥–µ–ø–ª–æ–µ requests –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è —Å 500 –æ—à–∏–±–∫–∞–º–∏
- **–†–∏—Å–∫**: Data loss, corrupted jobs, unhappy users
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å graceful shutdown handlers

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```typescript
async function start() {
  try {
    await app.listen({ port, host })
    app.log.info(`Fastify API listening on http://${host}:${port}`)
  } catch (error) {
    app.log.error({ err: error }, 'Failed to start Fastify API')
    process.exit(1)
  }
}

start()
// –ë–ï–ó SHUTDOWN HANDLERS!
```

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∫–æ–¥**:
```typescript
const gracefulShutdown = async (signal: string) => {
  app.log.info(`Received ${signal}, shutting down gracefully`)
  try {
    await app.close()
    process.exit(0)
  } catch (error) {
    app.log.error({ err: error }, 'Error during graceful shutdown')
    process.exit(1)
  }
}

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'))
process.on('SIGINT', () => gracefulShutdown('SIGINT'))
```

---

### 6. –û–¢–°–£–¢–°–¢–í–ò–ï RATE LIMITING
- **–°—Ç–∞—Ç—É—Å**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—â–∏—Ç–∞ –æ—Ç overload
- **–§–∞–π–ª**: `/services/api/src/server.ts`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç brute-force, DDoS –∞—Ç–∞–∫
- **–†–∏—Å–∫**: –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≤–∞–ª–µ–Ω –∑–∞–ø—Ä–æ—Å–∞–º–∏
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å @fastify/rate-limit plugin

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∫–æ–¥**:
```typescript
import rateLimit from '@fastify/rate-limit'

app.register(rateLimit, {
  max: 100,
  timeWindow: '15 minutes',
  skipOnError: true,
  keyGenerator: (request) => {
    // –ü–æ IP –∞–¥—Ä–µ—Å—É
    return request.ip
  },
})
```

---

## üü† –û–ß–ï–ù–¨ –í–ê–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (HIGH PRIORITY)

### 7. –°–õ–ê–ë–´–ï HEALTH CHECKS
- **–§–∞–π–ª**: `/services/api/src/routes/health.ts`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Redis, Supabase, —Ç–æ–ª—å–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç OK
- **–†–∏—Å–∫**: Load balancer –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –º–µ—Ä—Ç–≤—ã–π –∏–Ω—Å—Ç–∞–Ω—Å
- **–ù—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞**: Redis PING, Supabase connectivity

### 8. WEBHOOK VALIDATION –ë–ï–ó SECRET
- **–§–∞–π–ª**: `/services/api/src/routes/kommo.ts:389-396`
- **–ü—Ä–æ–±–ª–µ–º–∞**: Webhook –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ—Å–ª–∏ KOMMO_WEBHOOK_SECRET –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- **–†–∏—Å–∫**: Fake webhooks, injection –∞—Ç–∞–∫–∏
- **–†–µ—à–µ–Ω–∏–µ**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å

### 9. –ù–ï–¢ REQUEST TIMEOUTS
- **–ü—Ä–æ–±–ª–µ–º–∞**: –î–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç s–µ—Ä–≤–µ—Ä
- **–†–∏—Å–∫**: Hanging requests, slow API
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å timeout –¥–ª—è –≤—Å–µ—Ö requests (30 —Å–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

### 10. –ù–ï–¢ REQUEST SIZE LIMITS
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 1GB JSON payload
- **–†–∏—Å–∫**: OOM (Out of Memory) –∞—Ç–∞–∫–∞
- **–†–µ—à–µ–Ω–∏–µ**: –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å JSON body size –¥–æ 5MB

---

## üü° –í–ê–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (MEDIUM PRIORITY)

### 11. –ù–ï–¢ TOKEN REFRESH LOGIC
- **–§–∞–π–ª**: `/services/api/src/routes/kommo.ts:190-201`
- **–ü—Ä–æ–±–ª–µ–º–∞**: Tokens –∏—Å—Ç–µ–∫–∞—é—Ç, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- **–†–∏—Å–∫**: Failed syncs, broken integrations
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è—Ç—å expires_at –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º, –æ–±–Ω–æ–≤–ª—è—Ç—å token

### 12. WEBHOOK –ë–ï–ó REPLAY PROTECTION
- **–§–∞–π–ª**: `/services/api/src/routes/kommo.ts:384-431`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç duplicate webhooks
- **–†–∏—Å–∫**: Duplicate processing, data inconsistency
- **–†–µ—à–µ–Ω–∏–µ**: –°–æ—Ö—Ä–∞–Ω—è—Ç—å webhook ID, –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è

### 13. WEBHOOK –ë–ï–ó IP WHITELISTING
- **–ü—Ä–æ–±–ª–µ–º–∞**: Webhook –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å –ª—é–±–æ–≥–æ IP
- **–†–∏—Å–∫**: Malicious actors –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å fake webhooks
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è—Ç—å source IP –∞–¥—Ä–µ—Å

### 14. –ù–ï–¢ AUDIT LOGS
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –∑–∞–ø–∏—Å–∏ –∫—Ç–æ —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª
- **–†–∏—Å–∫**: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –Ω–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
- **–†–µ—à–µ–Ω–∏–µ**: –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (create, update, delete)

### 15. –ù–ï–¢ API VERSIONING
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –≤–µ—Ä—Å–∏–π API (/v1/, /v2/)
- **–†–∏—Å–∫**: Breaking changes –ª–æ–º–∞—é—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## SUMMARY TABLE

| ‚Ññ | –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | Time to Fix |
|---|----------|------|--------|-------------|------------|
| 1 | –ù–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ | –≤—Å–µ routes | - | –ö–†–ò–¢–ò–ß–ù–û | 4 —á–∞—Å–∞ |
| 2 | –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | –≤—Å–µ routes | - | –ö–†–ò–¢–ò–ß–ù–û | 3 —á–∞—Å–∞ |
| 3 | –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è CORS | server.ts | 111 | –ö–†–ò–¢–ò–ß–ù–û | 30 –º–∏–Ω—É—Ç |
| 4 | SERVICE_ROLE_KEY –≤–µ–∑–¥–µ | supabase.ts | 12 | –ö–†–ò–¢–ò–ß–ù–û | 8 —á–∞—Å–æ–≤ |
| 5 | –ù–µ—Ç graceful shutdown | server.ts | 143-153 | –ö–†–ò–¢–ò–ß–ù–û | 1 —á–∞—Å |
| 6 | –ù–µ—Ç rate limiting | server.ts | - | –û–ß–ï–ù–¨ –í–ê–ñ–ù–û | 1 —á–∞—Å |
| 7 | –°–ª–∞–±—ã–µ health checks | health.ts | 1-7 | –û–ß–ï–ù–¨ –í–ê–ñ–ù–û | 2 —á–∞—Å–∞ |
| 8 | Webhook –±–µ–∑ secret | kommo.ts | 389 | –í–ê–ñ–ù–û | 30 –º–∏–Ω—É—Ç |
| 9 | –ù–µ—Ç request timeouts | server.ts | - | –í–ê–ñ–ù–û | 1 —á–∞—Å |
| 10 | –ù–µ—Ç size limits | server.ts | - | –í–ê–ñ–ù–û | 1 —á–∞—Å |

---

## –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### Phase 1: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–¥–æ production) - 2-3 –¥–Ω—è
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å JWT authentication middleware
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å orgId authorization checks
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å rate limiting
5. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å graceful shutdown

### Phase 2: –°—Ä–æ—á–Ω–æ (–ø–µ—Ä–≤—ã–π —Å–ø—Ä–∏–Ω—Ç) - 1-2 –Ω–µ–¥–µ–ª–∏
6. ‚úÖ –£–ª—É—á—à–∏—Ç—å health checks
7. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å request timeouts
8. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å request size limits
9. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å token refresh logic
10. ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞—Ç—å webhook secret

### Phase 3: –í–∞–∂–Ω–æ (—Å–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç) - 2-4 –Ω–µ–¥–µ–ª–∏
11. –î–æ–±–∞–≤–∏—Ç—å webhook replay protection
12. –î–æ–±–∞–≤–∏—Ç—å IP whitelisting
13. –î–æ–±–∞–≤–∏—Ç—å audit logs
14. –î–æ–±–∞–≤–∏—Ç—å API versioning
15. –î–æ–±–∞–≤–∏—Ç—å API documentation

---

## –û–¶–ï–ù–ö–ê –†–ò–°–ö–û–í

### –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ production –ë–ï–ó –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: 95%+ –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —á–∞—Å–∞
**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π
- –°–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ agents –∏ CRM –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∞–º–∞ —á–µ—Ä–µ–∑ Kommo API
- CSRF –∞—Ç–∞–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã
- DDoS –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è rate limiting

**–û—Ü–µ–Ω–∫–∞**: üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –ù–ï–ë–ï–ó–û–ü–ê–°–ù–û** - –ù–ï –ó–ê–ü–£–°–ö–ê–¢–¨

---

## –°–°–´–õ–ö–ò –ù–ê –ö–û–î

### –í—Å–µ —Ñ–∞–π–ª—ã API
```
/services/api/src/
‚îú‚îÄ‚îÄ server.ts                      (–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª, 153 —Å—Ç—Ä–æ–∫–∏)
‚îú‚îÄ‚îÄ plugins/
‚îÇ   ‚îî‚îÄ‚îÄ env.ts                     (Validation, 32 —Å—Ç—Ä–æ–∫–∏)
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ health.ts                  (Health check, 7 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ agents.ts                  (Agents API, 98 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ jobs.ts                    (Jobs API, 114 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ crm.ts                     (CRM API, 402 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îî‚îÄ‚îÄ kommo.ts                   (Kommo CRM, 432 —Å—Ç—Ä–æ–∫–∏)
‚îî‚îÄ‚îÄ lib/
    ‚îú‚îÄ‚îÄ crypto.ts                  (Encryption, 40 —Å—Ç—Ä–æ–∫)
    ‚îú‚îÄ‚îÄ supabase.ts                (DB client, 20 —Å—Ç—Ä–æ–∫)
    ‚îú‚îÄ‚îÄ queue/
    ‚îÇ   ‚îú‚îÄ‚îÄ index.ts               (Queue init, 20 —Å—Ç—Ä–æ–∫)
    ‚îÇ   ‚îú‚îÄ‚îÄ enqueue.ts             (Job enqueue, 26 —Å—Ç—Ä–æ–∫)
    ‚îÇ   ‚îî‚îÄ‚îÄ types.ts               (Job types, 60 —Å—Ç—Ä–æ–∫)
    ‚îú‚îÄ‚îÄ repositories/
    ‚îÇ   ‚îú‚îÄ‚îÄ crm.ts                 (CRM queries, 303 —Å—Ç—Ä–æ–∫–∏)
    ‚îÇ   ‚îú‚îÄ‚îÄ kommo.ts               (Kommo queries, 100 —Å—Ç—Ä–æ–∫)
    ‚îÇ   ‚îî‚îÄ‚îÄ agents.ts              (Agent queries, 108 —Å—Ç—Ä–æ–∫)
    ‚îî‚îÄ‚îÄ providers/
        ‚îî‚îÄ‚îÄ kommo.ts               (Kommo provider, 112 —Å—Ç—Ä–æ–∫)
```

Total: ~2028 —Å—Ç—Ä–æ–∫ TypeScript –∫–æ–¥–∞

---

**–°—Ç–∞—Ç—É—Å**: üî¥ NOT PRODUCTION READY
**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**: 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö + 6 –æ—á–µ–Ω—å –≤–∞–∂–Ω—ã—Ö = 11 fixes
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: 2-3 –¥–Ω—è —Ä–∞–±–æ—Ç—ã –æ–ø—ã—Ç–Ω–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
