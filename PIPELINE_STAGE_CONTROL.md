# üéØ –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞ –ø–æ –≤–æ—Ä–æ–Ω–∫–∞–º –∏ —ç—Ç–∞–ø–∞–º

**–î–∞—Ç–∞:** 2025-01-02  
**–¶–µ–ª—å:** –ê–≥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ —Ç–µ—Ö —ç—Ç–∞–ø–∞—Ö –∏ –≤–æ—Ä–æ–Ω–∫–∞—Ö, –≥–¥–µ –æ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω!

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ

**–§–∞–π–ª:** `app/api/crm/webhook/route.ts`

**–ö–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
- ‚úÖ –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook –æ—Ç Kommo –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `pipeline_id` –∏ `status_id` (stage_id)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –í–°–ï –∞–≥–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —ç—Ç–æ–π –≤–æ—Ä–æ–Ω–∫–∏
- ‚úÖ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
  - –í–∫–ª—é—á–µ–Ω –ª–∏ –∞–≥–µ–Ω—Ç –¥–ª—è —ç—Ç–æ–π –≤–æ—Ä–æ–Ω–∫–∏ (`is_active = true`)
  - –ï—Å–ª–∏ `all_stages = true` ‚Üí –∞–≥–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö
  - –ï—Å–ª–∏ `all_stages = false` ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –µ—Å—Ç—å –ª–∏ `stage_id` –≤ `selected_stages`
- ‚úÖ **–ï—Å–ª–∏ –∞–≥–µ–Ω—Ç –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —ç—Ç–∞–ø–∞ ‚Üí —Å–æ–±—ã—Ç–∏–µ –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è!**

**–ö–æ–¥:**
```typescript
// –î–ª—è –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤
for (const lead of leads) {
  const pipelineId = lead.pipeline_id.toString()
  const stageId = lead.status_id.toString()
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–π –≤–æ—Ä–æ–Ω–∫–∏
  const { data: pipelineSettings } = await supabase
    .from('agent_pipeline_settings')
    .select('org_id, agent_id, all_stages, selected_stages')
    .eq('pipeline_id', pipelineId)
    .eq('is_active', true)

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç
  for (const setting of pipelineSettings) {
    let shouldProcess = false
    
    if (setting.all_stages) {
      // –í—Å–µ —ç—Ç–∞–ø—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
      shouldProcess = true
    } else if (selectedStages.includes(stageId)) {
      // –≠—Ç–∞–ø –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö
      shouldProcess = true
    }
    
    if (shouldProcess) {
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
    } else {
      // –ü–†–û–ü–£–°–ö–ê–ï–ú - –∞–≥–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞!
    }
  }
}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Chat API

**–§–∞–π–ª:** `app/api/chat/route.ts`

–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- ‚úÖ –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `isAgentConfiguredForStage`
- ‚úÖ –ï—Å–ª–∏ –∞–≥–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —ç—Ç–∞–ø–∞ ‚Üí `canUseAgent = false`
- ‚úÖ –ê–≥–µ–Ω—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞

### 3. –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ Repository

**–§–∞–π–ª:** `lib/repositories/agent-pipeline-settings.ts`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ `getAgentsForPipelineStage()` - –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–≥–µ–Ω—Ç—ã, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–ø–∞
- ‚úÖ `isAgentConfiguredForStage()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (—É–∂–µ –±—ã–ª–æ)

---

## üîí –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞

### –ê–≥–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –ï–°–õ–ò:

1. ‚úÖ `is_active = true` –¥–ª—è –≤–æ—Ä–æ–Ω–∫–∏
2. ‚úÖ –ò –æ–¥–Ω–æ –∏–∑ —É—Å–ª–æ–≤–∏–π:
   - `all_stages = true` (–≤—Å–µ —ç—Ç–∞–ø—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã)
   - `stage_id` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `selected_stages[]`

### –ê–≥–µ–Ω—Ç –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –ï–°–õ–ò:

1. ‚ùå `is_active = false` –¥–ª—è –≤–æ—Ä–æ–Ω–∫–∏
2. ‚ùå `all_stages = false` –ò `stage_id` –ù–ï–¢ –≤ `selected_stages[]`
3. ‚ùå –í–æ—Ä–æ–Ω–∫–∞ –≤–æ–æ–±—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞

---

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞: `agent_pipeline_settings`

```sql
{
  id: uuid,
  org_id: uuid,
  agent_id: uuid,
  pipeline_id: text,        -- ID –≤–æ—Ä–æ–Ω–∫–∏ –∏–∑ CRM
  is_active: boolean,       -- –í–∫–ª—é—á–µ–Ω–∞ –ª–∏ –≤–æ—Ä–æ–Ω–∫–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞
  all_stages: boolean,     -- –†–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö?
  selected_stages: text[],  -- –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤
  stage_instructions: jsonb, -- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
  created_at: timestamptz,
  updated_at: timestamptz
}
```

---

## üé® UI –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–§–∞–π–ª:** `app/(protected)/manage/[tenantId]/ai-agents/[id]/pipelines/page.tsx`

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- ‚úÖ –ï—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Ä–æ–Ω–æ–∫
- ‚ö†Ô∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `PipelinesClient` –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è:
  - –ó–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –≤–æ—Ä–æ–Ω–æ–∫ –∏–∑ Kommo
  - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç—Ç–∞–ø–æ–≤ –∫–∞–∂–¥–æ–π –≤–æ—Ä–æ–Ω–∫–∏
  - –í—ã–±–æ—Ä–∞ —ç—Ç–∞–ø–æ–≤ (—á–µ–∫–±–æ–∫—Å—ã –∏–ª–∏ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç)
  - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è `all_stages`
  - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è `is_active`

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏–º–µ—Ä 1: –ê–≥–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –≤—Å–µ —ç—Ç–∞–ø—ã

```json
{
  "pipeline_id": "123",
  "is_active": true,
  "all_stages": true,
  "selected_stages": []
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–≥–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤–æ—Ä–æ–Ω–∫–∏ 123 –Ω–∞ –õ–Æ–ë–û–ú —ç—Ç–∞–ø–µ ‚úÖ

---

### –ü—Ä–∏–º–µ—Ä 2: –ê–≥–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —ç—Ç–∞–ø—ã

```json
{
  "pipeline_id": "123",
  "is_active": true,
  "all_stages": false,
  "selected_stages": ["456", "789"]
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- ‚úÖ –ê–≥–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞ —ç—Ç–∞–ø–∞—Ö 456 –∏ 789
- ‚ùå –ê–≥–µ–Ω—Ç –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞ –¥—Ä—É–≥–∏—Ö —ç—Ç–∞–ø–∞—Ö

---

### –ü—Ä–∏–º–µ—Ä 3: –ê–≥–µ–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è –≤–æ—Ä–æ–Ω–∫–∏

```json
{
  "pipeline_id": "123",
  "is_active": false,
  "all_stages": false,
  "selected_stages": ["456"]
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–≥–µ–Ω—Ç –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤–æ—Ä–æ–Ω–∫–∏ 123 –≤–æ–æ–±—â–µ ‚ùå

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ì–æ—Ç–æ–≤–æ:** –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
2. ‚úÖ **–ì–æ—Ç–æ–≤–æ:** –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
3. ‚ö†Ô∏è **–í —Ä–∞–±–æ—Ç–µ:** –£–ª—É—á—à–µ–Ω–∏–µ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ PipelinesClient:
   - –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ—Ä–æ–Ω–æ–∫ –∏–∑ `/api/crm/kommo?action=pipelines`
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ –∫–∞–∂–¥–æ–π –≤–æ—Ä–æ–Ω–∫–∏
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `is_active`, `all_stages`, `selected_stages`
4. üìù **TODO:** –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
5. üìù **TODO:** –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–∏

**–ê–≥–µ–Ω—Ç –ù–ò–ö–û–ì–î–ê –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Å–¥–µ–ª–∫–∏, –µ—Å–ª–∏:**
- ‚ùå –í–æ—Ä–æ–Ω–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (`is_active = false`)
- ‚ùå –≠—Ç–∞–ø –Ω–µ –≤–∫–ª—é—á–µ–Ω (`all_stages = false` –ò —ç—Ç–∞–ø –Ω–µ –≤ `selected_stages[]`)
- ‚ùå –í–æ—Ä–æ–Ω–∫–∞ –≤–æ–æ–±—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –í development —Ä–µ–∂–∏–º–µ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üéØ –ò—Ç–æ–≥

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å—Ç—Ä–æ–≥–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ –≤–æ—Ä–æ–Ω–∫–∞–º –∏ —ç—Ç–∞–ø–∞–º!**

–ê–≥–µ–Ω—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¢–û–õ–¨–ö–û —Ç–∞–º, –≥–¥–µ –≤—ã –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏. –ù–∏–∫–∞–∫–∏—Ö —Å–ª—É—á–∞–π–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —ç—Ç–∞–ø–∞—Ö! ‚úÖ

