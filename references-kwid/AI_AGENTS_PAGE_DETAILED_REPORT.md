# Детальный отчет по странице "Агенты ИИ"

## URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents`

## Title (Заголовок страницы)
"Агенты ИИ - GPT Агент"

---

## Содержание отчета

1. [Общая структура страницы](#общая-структура-страницы)
2. [Страница создания агента](#страница-создания-агента)
3. [Страница редактирования агента](#страница-редактирования-агента)
4. [Вкладки редактирования](#вкладки-редактирования)
5. [Компоненты UI](#компоненты-ui-переиспользуемые-компоненты)
6. [Структура страниц по блокам](#структура-страниц-по-блокам)
7. [Состояния компонентов и взаимодействия](#состояния-компонентов-и-взаимодействия)
8. [Responsive Design](#responsive-design)
9. [Accessibility](#accessibility-доступность)
10. [Валидация и обработка ошибок](#валидация-и-обработка-ошибок)
11. [Схема данных](#схема-данных)
12. [Layout и Spacing](#layout-и-spacing)
13. [Компонентная карта страницы](#компонентная-карта-страницы)
14. [Визуальное разделение секций](#визуальное-разделение-секций)
15. [Цветовая палитра](#цветовая-палитра)
16. [Типографика](#типографика)
17. [Иконки и их расположение](#иконки-и-их-расположение)
18. [Grid система и Layout](#grid-система-и-layout)
19. [Анимации и переходы](#анимации-и-переходы)
20. [Пустые состояния и Edge Cases](#пустые-состояния-и-edge-cases)
21. [Список всех компонентов для реализации](#список-всех-компонентов-для-реализации)
22. [API спецификации](#api-спецификации-детальные)
23. [Детальные состояния загрузки](#детальные-состояния-загрузки)
24. [Валидация форм (детальная)](#валидация-форм-детальная)
25. [Responsive Design (точные breakpoints)](#responsive-design-точные-breakpoints)
26. [Z-index слои](#z-index-слои)
27. [Focus states (детальные)](#focus-states-детальные)
28. [Hover/Active/Pressed states](#hoveractivepressed-states)
29. [Тени и эффекты (точные значения)](#тени-и-эффекты-точные-значения)
30. [Скругления (точные значения)](#скругления-точные-значения)
31. [Шрифты](#шрифты)
32. [Иконки (детальные требования)](#иконки-детальные-требования)
33. [Интеграция с CRM (Kommo)](#интеграция-с-crm-kommo)
34. [Бизнес-логика](#бизнес-логика)
35. [Обработка ошибок (детальная)](#обработка-ошибок-детальная)
36. [Производительность](#производительность)
37. [Безопасность](#безопасность)
38. [Тестирование](#тестирование)
39. [Примеры кода](#примеры-кода)
40. [Логирование и мониторинг](#логирование-и-мониторинг)
41. [Доступность (расширенная)](#доступность-расширенная)
42. [Интернационализация (i18n)](#интернационализация-i18n)
43. [Деплой и окружения](#деплой-и-окружения)
44. [Версионирование API](#версионирование-api)
45. [Документация для пользователей](#документация-для-пользователей)
46. [Технические детали для разработчиков](#технические-детали-для-разработчиков)
47. [Информация для дизайнера](#информация-для-дизайнера)

---

## Общая структура страницы

### Header (Верхняя панель)
- **Глобальный поиск** (ref=e16)
- **Ссылка на тарифы** "30.10.2025" (ref=e18) → `/pricing`
- **Кнопка уведомлений** "Открыть уведомления 3" (ref=e24) - показывает количество непрочитанных уведомлений
- **Меню пользователя** (ref=e34) - аватар пользователя

### Sidebar (Боковая панель)
- Полная структура описана в `SIDEBAR_DETAILED_REPORT.md`
- Активный раздел: "Агенты ИИ" > "Агенты ИИ"

### Main Content (Основной контент)

#### 1. Навигация страницы (Breadcrumbs)
- **Структура:**
  - `navigation` (ref=e41)
    - `list` (ref=e42)
      - `listitem` (ref=e43)
        - `link` "Агенты ИИ" (ref=e44) → `/ai-agents`

#### 2. Заголовок страницы
- **Heading** "Агенты ИИ" (level=1, ref=e53)

#### 3. Кнопка "Создать"
- **Тип:** link
- **URL:** `/ai-agents/create`
- **Текст:** "Создать"
- **Функция:** Переход на отдельную страницу создания агента
- **Расположение:** В правом верхнем углу страницы

#### 4. Поле поиска
- **Тип:** searchbox
- **Placeholder:** "Поиск..."
- **Функция:** Фильтрация агентов по названию
- **Расположение:** Под заголовком страницы

#### 5. Кнопка "Переключить столбцы"
- **Тип:** button
- **Текст:** "Переключить столбцы"
- **Функция:** Открывает Popover/Dropdown для управления видимостью столбцов
- **Расположение:** Рядом с полем поиска

##### 5.1. Dropdown "Переключить столбцы"
- **Тип:** Popover/Dropdown
- **Позиционирование:** Под кнопкой
- **Визуальное оформление:** Белый фон, тень, скругленные углы
- **Структура:**
  - **Заголовок:** "Столбцы"
  - **Чекбоксы:**
    - **"Created at"** (type: checkbox, function: show/hide column, states: checked/unchecked, behavior: toggle on click, immediate application, state persistence)
    - **"Updated at"** (type: checkbox, function: show/hide column, states: checked/unchecked, behavior: toggle on click, immediate application, state persistence)
- **Поведение:** Открывается при клике на кнопку, закрывается при клике вне dropdown или при повторном клике на кнопку

#### 6. Таблица агентов
- **Структура:**
  - **Заголовки столбцов:**
    - "Название" (с возможностью сортировки)
    - "Активно" (переключатель)
    - "Created at" (опционально, управляется через "Переключить столбцы")
    - "Updated at" (опционально, управляется через "Переключить столбцы")
    - "Действия"
  - **Строки данных:**
    - Пример для агента "Менеджер по продажам" (ref=e120)
    - **Переключатель "Активно"** (ref=e115):
      - **Тип:** switch
      - **Состояния:** checked/unchecked
      - **Функция:** Включение/выключение агента
      - **Поведение:** При переключении меняет состояние агента (checked/unchecked), выпадающих списков не появляется
      - **Визуальное оформление:** Переключатель в столбце "Активно"
    - **Действия для каждого агента:**
      - **Кнопка "Изменить"** (ref=e128):
        - **Тип:** link
        - **URL:** `/ai-agents/{id}/edit`
        - **Функция:** Переход на страницу редактирования агента
      - **Кнопка "Копировать"** (ref=e132):
        - **Тип:** button
        - **Функция:** Открывает модальное окно подтверждения копирования
      - **Кнопка "Удалить"** (ref=e136):
        - **Тип:** button
        - **Функция:** Открывает модальное окно подтверждения удаления

##### 6.1. Модальное окно подтверждения копирования "Скопировать агента ИИ?"
- **Тип:** dialog (ref=e352)
- **ARIA:** `aria-modal="true"`
- **Структура:**
  - **Кнопка закрытия:** button (ref=e355) с иконкой "X" (img, ref=e357)
    - **Функция:** Закрытие модального окна без подтверждения
    - **ARIA:** `aria-label="Закрыть"`
  - **Иконка подтверждения:** img (ref=e361)
    - **Функция:** Визуальная индикация действия (например, иконка копирования)
  - **Заголовок:** "Скопировать агента ИИ?" (level=2, ref=e364)
  - **Описание:** paragraph (ref=e365)
    - **Текст:** "Дублирует все настройки. Копия агента будет неактивна, пока вы не включите её."
  - **Кнопки действий:**
    - **"Отменить"** (button, active, ref=e368):
      - **Текст:** "Отменить" (generic, ref=e369)
      - **Функция:** Отмена действия и закрытие модального окна
      - **ARIA:** `aria-label="Отменить"`
      - **Состояние:** active (фокус по умолчанию)
    - **"Подтвердить"** (button, ref=e370):
      - **Текст:** "Подтвердить" (generic, ref=e371)
      - **Функция:** Подтверждение и выполнение копирования агента
      - **ARIA:** `aria-label="Подтвердить"`
- **Поведение:** 
  - Открывается при клике на кнопку "Копировать" в таблице агентов
  - Закрывается при клике на "Отменить", "Закрыть" (X), нажатии Escape, или клике вне модального окна
  - При подтверждении создается копия агента со всеми настройками, но в неактивном состоянии

##### 6.2. Модальное окно подтверждения удаления
- **Тип:** Dialog/Modal
- **Заголовок:** "Удалить агента?"
- **Текст подтверждения:** Описание действия удаления
- **Кнопки:**
  - **"Отменить"** (ref=e368) - закрывает модальное окно
  - **"Удалить"** - выполняет удаление агента
- **Поведение:** Открывается при клике на кнопку "Удалить", закрывается при клике на "Отменить" или вне модального окна

---

## Страница создания агента

### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/create`

### Title (Заголовок страницы)
"Создать Агент ИИ - GPT Агент"

### Структура страницы

#### Header и Sidebar
- Сохраняются Header и Sidebar (описаны выше)

#### Main Content

##### 1. Навигация страницы (Breadcrumbs)
- **Структура:**
  - `navigation` (ref=e41)
    - `list` (ref=e42)
      - `listitem` (ref=e43)
        - `link` "Агенты ИИ" (ref=e44) → `/ai-agents`
      - `listitem` (ref=e45)
        - `generic` "Создать"

##### 2. Заголовок страницы
- **Heading** "Создать Агент ИИ" (level=1)

##### 3. Форма создания агента
- **Поле "Название":**
  - **Тип:** textbox
  - **Label:** "Название" с обязательным маркером "*"
  - **Placeholder:** "Введите название агента"
  - **Валидация:** Обязательное поле
  - **Расположение:** Первое поле формы

##### 4. Кнопки действий
- **"Сохранить"** (ref=e226):
  - **Тип:** button
  - **Функция:** Сохранение нового агента
- **"Отмена"** (ref=e228):
  - **Тип:** button
  - **Функция:** Отмена создания и возврат на страницу списка агентов

---

## Страница редактирования агента

### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/{id}/edit`

### Title (Заголовок страницы)
"Редактирование {Название агента} - GPT Агент"

### Структура страницы

#### Header и Sidebar
- Сохраняются Header и Sidebar (описаны выше)

#### Main Content

##### 1. Навигация страницы (Breadcrumbs)
- **Структура:**
  - `navigation` (ref=e31)
    - `list` (ref=e32)
      - `listitem` (ref=e33)
        - `link` "Агенты ИИ" (ref=e34) → `/ai-agents`
      - `listitem` (ref=e35)
        - `img` (ref=e36)
        - `link` "{Название агента}" (ref=e38) → `/ai-agents/{id}/edit`
      - `listitem` (ref=e39)
        - `img` (ref=e40)
        - `generic` "{Название текущей вкладки}"

##### 2. Заголовок страницы
- **Heading** "Редактирование {Название агента}" (level=1, ref=e43)

##### 3. Кнопка "Удалить"
- **Тип:** button
- **Текст:** "Удалить"
- **Функция:** Открывает модальное окно подтверждения удаления
- **Расположение:** В правом верхнем углу страницы, рядом с заголовком

##### 4. Вкладки (Tabs)
- **Тип:** tablist (ref=e49)
- **Вкладки:**
  1. **"Основные"** (ref=e50) - активна по умолчанию
  2. **"Сделки и контакты"** (ref=e54) → `/ai-agents/{id}/leads-contacts`
  3. **"Триггеры"** (ref=e58) → `/ai-agents/{id}/triggers`
  4. **"Цепочки"** (ref=e62) → `/ai-agents/{id}/sequences`
  5. **"Интеграции"** (ref=e66) → `/ai-agents/{id}/available-integrations`
  6. **"Дополнительно"** (ref=e70) → `/ai-agents/{id}/advanced-settings`
- **Поведение:** При клике на вкладку происходит переход на соответствующую страницу (URL меняется)

---

### Вкладка "Основные"

#### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/{id}/edit`

#### Секция "Профиль агента"

##### 1. Поле "Название"
- **Тип:** textbox
- **Label:** "Название" с обязательным маркером "*"
- **Placeholder:** "Введите название агента"
- **Значение:** Текущее название агента (например, "Менеджер по продажам")
- **Валидация:** Обязательное поле

##### 2. Переключатель "Активно"
- **Тип:** switch
- **Label:** "Активно"
- **Состояния:** checked/unchecked
- **Функция:** Включение/выключение агента
- **Поведение:** При переключении меняет состояние агента, выпадающих списков не появляется
- **Визуальное оформление:** Переключатель с меткой

##### 3. Поле "Инструкции для агента"
- **Тип:** textbox (многострочное)
- **Label:** "Инструкции для агента" с обязательным маркером "*"
- **Placeholder:** "Введите инструкции для агента"
- **Значение:** Текущие инструкции (например, "Вы — полезный помощник.")
- **Валидация:** Обязательное поле
- **Описание:** "Начальные инструкции по тону, стилю и ответам вашего агента. Вы также можете добавить общие сведения о компании, чтобы помочь агенту отвечать более точно."

#### Секция "Взаимодействие"

##### 1. Переключатель "Проверять перед отправкой"
- **Тип:** switch
- **Label:** "Проверять перед отправкой"
- **Состояния:** checked/unchecked
- **Функция:** Включение/выключение режима проверки сообщений перед отправкой
- **Поведение:** При переключении меняет режим работы агента, выпадающих списков не появляется
- **Описание:** "Сообщения не будут отправляться автоматически. Они появятся в поле ввода сообщения для вашего просмотра и ручной отправки."

#### Секция "Настройки воронок"

##### 1. Заголовок и описание
- **Heading** "Настройки воронок" (level=3, ref=e146)
- **Описание:** "Выберите воронки и этапы сделок, в которых агент должен работать"

##### 2. Кнопка "Синхронизировать настройки CRM"
- **Тип:** button
- **Текст:** "Синхронизировать настройки CRM"
- **Функция:** Синхронизация воронок и этапов из CRM
- **Расположение:** Рядом с заголовком секции

##### 3. Список воронок
- **Структура:** Для каждой воронки из CRM:
  - **Заголовок воронки** (heading, level=3, например, "GENERATION LEAD", ref=e172)
  - **Кнопка раскрытия этапов** (ref=e173):
    - **Тип:** button
    - **Функция:** Раскрывает/скрывает список этапов воронки
    - **Состояния:** active/inactive (когда active, показывает этапы)
    - **Визуальное оформление:** Иконка стрелки
    - **Поведение:** При клике раскрывает/скрывает список этапов сделок внутри воронки
  - **Переключатель "Активно"** (ref=e187):
    - **Тип:** switch
    - **Label:** "Активно"
    - **Состояния:** checked/unchecked
    - **Функция:** Включение/выключение работы агента в данной воронке
    - **Поведение:** При переключении меняет состояние, выпадающих списков не появляется
- **Источник данных:** Воронки синхронизируются из CRM через кнопку "Синхронизировать настройки CRM"
- **Примеры воронок из CRM:**
  - "GENERATION LEAD"
  - "WORK VISA IN POLAND"
  - "SEASONAL VISA IN POLAND"
  - "STUDY VISA IN GEORGIA"
  - "AGENT PARTNERSHIP"
  - "PRODUCT VENDORS (PARTNERSHIP)"
- **Этапы воронок:** При раскрытии воронки показываются этапы сделок (stages), которые также синхронизируются из CRM

#### Секция "Каналы"

##### 1. Заголовок и описание
- **Heading** "Каналы" (level=3, ref=e296)
- **Описание:** "Выберите каналы, в которых агент может отвечать"

##### 2. Кнопка "Синхронизировать настройки CRM"
- **Тип:** button
- **Текст:** "Синхронизировать настройки CRM"
- **Функция:** Синхронизация каналов из CRM
- **Расположение:** Рядом с заголовком секции

##### 3. Переключатель "Все каналы"
- **Тип:** switch
- **Label:** "Все каналы"
- **Состояния:** checked/unchecked
- **Функция:** Включение/выключение работы агента во всех каналах
- **Поведение:** 
  - **Когда checked (включено):** Агент работает во всех каналах, поле выбора каналов скрыто
  - **Когда unchecked (выключено):** Появляется поле "Выбрать каналы" с combobox для выбора конкретных каналов
- **ВАЖНО:** При выключении переключателя появляется выпадающий список для выбора каналов!

##### 3.1. Поле "Выбрать каналы" (появляется при unchecked)
- **Тип:** combobox (множественный выбор)
- **Label:** "Выбрать каналы" с обязательным маркером "*" (ref=e536, e537)
- **Placeholder:** "Выбрать вариант"
- **Ref:** e542 (combobox), e544 (textbox), e567 (listbox)
- **Функция:** Множественный выбор каналов из списка
- **Поведение:** Позволяет выбрать несколько каналов из выпадающего списка
- **Источник данных:** Синхронизируется из CRM через кнопку "Синхронизировать настройки CRM"
- **Список каналов из CRM (полный список опций в listbox):**
  - "Instagram (World Wide Services)" [selected by default, ref=e568]
  - "WhatsApp Business (Whats App )" [ref=e569]
  - "Facebook (Worldwideservices)" [ref=e570]
  - "Teletype service (Teletype App)" [ref=e571]
  - "Whatsapp (WhatsApp via Twilio)" [ref=e572]
  - "whatsApp (WhatsApp via Gupshup)" [ref=e573]
  - "RingCentral SMS (RingCentral Text Messaging)" [ref=e574]
  - "Twilio Text Messaging (Twilio Text Messaging)" [ref=e575]
  - "TikTok (TikTok)" [ref=e576]
  - "Live Chat (WORK VISA IN POLAND)" [ref=e577]
  - "Live Chat (Live chat)" [ref=e578]
  - "WhatsApp Lite (WhatsApp Lite)" [ref=e579]
- **Выбранные значения:** Отображаются как теги с кнопкой удаления
- **Визуальное оформление:** Combobox с выпадающим списком (listbox), активное поле ввода (textbox)
- **Состояния:** expanded (когда открыт), active (когда textbox в фокусе)

#### Секция "База знаний"

##### 1. Заголовок
- **Heading** "База знаний" (level=3, ref=e324)

##### 2. Переключатель "Разрешить доступ ко всем категориям"
- **Тип:** switch
- **Label:** "Разрешить доступ ко всем категориям"
- **Состояния:** checked/unchecked
- **Функция:** Включение/выключение доступа агента ко всем категориям базы знаний
- **Поведение:** 
  - **Когда checked (включено):** Агент имеет доступ ко всем категориям, поле выбора категорий скрыто
  - **Когда unchecked (выключено):** Появляется поле "Выбрать категории" с tree selector для выбора конкретных категорий
- **ВАЖНО:** При выключении переключателя появляется выпадающий список (tree selector) для выбора категорий!

##### 2.1. Поле "Выбрать категории" (появляется при unchecked)
- **Тип:** tree selector (иерархический выбор)
- **Label:** "Выбрать категории" с обязательным маркером "*" (ref=e550, e551)
- **Placeholder:** "Выбрать вариант"
- **Ref:** e552 (generic container), e557 (generic wrapper), e559 (textbox "tree-knowledgeCategories-label"), e563 (img icon), e580 (img icon when active), e583 (generic "Общее" с checkbox)
- **Функция:** Множественный выбор категорий из иерархического списка
- **Поведение:** Позволяет выбрать несколько категорий из дерева категорий
- **Источник данных:** Категории из базы знаний (не из CRM)
- **Визуальное оформление:** Textbox с иконкой стрелки, tree selector для иерархического выбора
- **Описание:** "Агент будет получать доступ к знаниям только из этих категорий" (ref=e565)
- **Примеры категорий:**
  - "Общее" (ref=e583) - с checkbox для выбора
- **Состояния:** active (когда textbox в фокусе)

##### 3. Переключатель "Создать задачу, если ответ не найден"
- **Тип:** switch
- **Label:** "Создать задачу, если ответ не найден"
- **Состояния:** checked/unchecked
- **Функция:** Включение/выключение автоматического создания задачи в CRM, если агент не нашел ответ в базе знаний
- **Поведение:** При переключении меняет поведение агента, выпадающих списков не появляется
- **Описание:** "Автоматически создавать задачу в сделке CRM, если в базе знаний не найдена релевантная информация"

##### 4. Поле "Сообщение при отсутствии ответа"
- **Тип:** textbox (многострочное)
- **Label:** "Сообщение при отсутствии ответа"
- **Placeholder:** "У меня недостаточно информации, чтобы ответить на этот вопрос. Я уточню детали и вернусь к вам."
- **Значение:** Текущее сообщение (если задано)
- **Функция:** Сообщение, которое будет показано клиенту, когда агент не сможет найти релевантную информацию
- **Описание:** "Это сообщение будет показано, когда агент не сможет найти релевантную информацию в базе знаний."

##### 5. Ссылка "Открыть базу знаний"
- **Тип:** link
- **URL:** `/knowledge-items`
- **Текст:** "Открыть базу знаний"
- **Функция:** Переход на страницу базы знаний

#### Кнопки действий
- **"Сохранить"** (ref=e365):
  - **Тип:** button
  - **Функция:** Сохранение изменений агента
- **"Отмена"** (ref=e367):
  - **Тип:** button
  - **Функция:** Отмена изменений и возврат на страницу списка агентов

---

### Вкладка "Сделки и контакты"

#### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/{id}/leads-contacts`

#### Title (Заголовок страницы)
"Сделки и контакты - GPT Агент"

#### Секция "Настройки доступа к данным"

##### 1. Заголовок и описание
- **Heading** "Настройки доступа к данным" (level=3, ref=e91)
- **Описание:** "Выберите, какие данные агент может читать и использовать в диалогах"

##### 2. Кнопка "Синхронизировать настройки CRM"
- **Тип:** button
- **Текст:** "Синхронизировать настройки CRM"
- **Функция:** Синхронизация полей сделок и контактов из CRM
- **Расположение:** Рядом с заголовком секции

##### 3. Подсекция "Данные сделки"
- **Заголовок:** "Данные сделки" (level=3, ref=e109)
- **Описание:** "Выберите поля сделки, которые агент может читать"
- **Кнопка раскрытия/сворачивания** (ref=e111):
  - **Тип:** button
  - **Функция:** Раскрывает/скрывает настройки полей сделки
- **Поле "Выберите поля сделки":**
  - **Тип:** combobox (множественный выбор, ref=e127)
  - **Label:** "Выберите поля сделки" (ref=e122)
  - **Placeholder:** "Выберите поля, к которым агент сможет получить доступ..." (ref=e140)
  - **Функция:** Множественный выбор полей сделки из списка
  - **Источник данных:** Поля синхронизируются из CRM через кнопку "Синхронизировать настройки CRM"
  - **Выбранные значения:** Отображаются как теги с кнопкой удаления (например, "Этап сделки" с кнопкой "Remove item: 'status_id'", ref=e134, e135)
  - **Состояния:** expanded (когда открыт), active (когда textbox в фокусе)
  - **Примеры выбранных полей из CRM:**
    - "Название сделки" (name) [ref=e130, e131]
    - "Ответственный пользователь" (responsible_user_id) [ref=e132, e133]
    - "Этап сделки" (status_id) [ref=e134, e135]
    - "Тип услуги" (cf_564832) [ref=e136, e137]
    - "Email" (cf_878912) [ref=e138, e139]
  - **Полный список доступных полей сделки из CRM (в listbox при открытии combobox, ref=e509):**
    - "Бюджет" [ref=e510, selected]
    - "Дата создания" [ref=e511]
    - "Теги" [ref=e512]
    - "Факт (сумма)" [ref=e513]
    - "Остаток (сумма)" [ref=e514]
    - "Остаток к оплате" [ref=e515]
    - "Приоритет" [ref=e516]
    - "Анкета" [ref=e517]
    - "Пол" [ref=e518]
    - "Service Package Type" [ref=e519]
    - "Желаемая вакансия" [ref=e520]
    - "Фактическая вакансия" [ref=e521]
    - "Паспорт валиден" [ref=e522]
    - "Payment Method" [ref=e523]
    - "Vendor" [ref=e524]
    - "Контракт подписан" [ref=e525]
    - "Клиент подан" [ref=e526]
    - "Google drive" [ref=e527]
    - "Продукт" [ref=e528]
    - "Ответ на шаблон WV №0" [ref=e529]
    - "Ответ на шаблон WV №1" [ref=e530]
    - "Ответ на шаблон WV №2" [ref=e531]
    - "Ответ на шаблон WV №3" [ref=e532]
    - "Ответ на шаблон SV №1" [ref=e533]
    - "Ответ на шаблон SV №2" [ref=e534]
    - "Ответ на шаблон SV №3" [ref=e535]
    - "Ответ на шаблон STV №1" [ref=e536]
    - "Ответ на шаблон STV №2" [ref=e537]
    - "Ответ на шаблон STV №3" [ref=e538]
    - "Ответ на шаблон STV №4" [ref=e539]
    - "Ответ на шаблон AG №1" [ref=e540]
    - "Ответ на шаблон AG №2" [ref=e541]
    - "TikTok ad URL" [ref=e542]
    - "TikTok ad name" [ref=e543]
    - "TikTok ad ID" [ref=e544]
    - "Дата рождения" [ref=e545]
    - "Гражданство" [ref=e546]
    - "Паспорт" [ref=e547]
    - "Сумма прописью" [ref=e548]
    - "Дата контракта" [ref=e549]
    - "Дата инвойса" [ref=e550]
    - "Номер контракта" [ref=e551]
    - "Срок оплаты" [ref=e552]
    - "Срок контракта" [ref=e553]
    - "Количество" [ref=e554]
    - "Зарплата в час" [ref=e555]
    - "n_docs" [ref=e556]
    - "utm_content" [ref=e557]
    - "utm_medium" [ref=e558]
    - "utm_campaign" [ref=e559]
  - **Описание:** "Выбирайте только необходимые поля. Дополнительные поля добавляют лишний контекст и могут снизить точность ответов" (ref=e141)

##### 4. Подсекция "Данные контакта"
- **Заголовок:** "Данные контакта" (level=3, ref=e149)
- **Описание:** "Выберите, какие поля контакта агент сможет читать" (ref=e150)
- **Кнопка раскрытия/сворачивания** (ref=e151):
  - **Тип:** button
  - **Функция:** Раскрывает/скрывает настройки полей контакта
- **Поле "Выберите поля контакта":**
  - **Тип:** combobox (множественный выбор, ref=e167)
  - **Label:** "Выберите поля контакта" (ref=e162)
  - **Placeholder:** "Выберите поля, к которым агент сможет получить доступ..." (ref=e182)
  - **Функция:** Множественный выбор полей контакта из списка
  - **Источник данных:** Поля синхронизируются из CRM через кнопку "Синхронизировать настройки CRM"
  - **Выбранные значения:** Отображаются как теги с кнопкой удаления (например, "Имя контакта" с кнопкой "Remove item: 'name'", ref=e170, e171)
  - **Состояния:** expanded (когда открыт), active (когда textbox в фокусе)
  - **Примеры выбранных полей из CRM:**
    - "Имя контакта" (name) [ref=e170, e171]
    - "Ответственный пользователь" (responsible_user_id) [ref=e172, e173]
    - "Дата создания" (created_at) [ref=e174, e175]
    - "Теги" (tags) [ref=e176, e177]
    - "Email" (cf_438092) [ref=e178, e179]
    - "Страна" (cf_491700) [ref=e180, e181]
  - **Описание:** "Выбирайте только необходимые поля. Большее количество полей добавляет дополнительный контекст и может снизить точность ответов." (ref=e183)

#### Секция "Настройки ввода данных"

##### 1. Заголовок и описание
- **Heading** "Настройки ввода данных" (level=3, ref=e191)
- **Описание:** "Настройте, как агент может изменять данные сделок и контактов в зависимости от контекста разговора" (ref=e192)

##### 2. Подсекция "Данные сделки"
- **Заголовок:** "Данные сделки" (level=3, ref=e203)
- **Описание:** "Задайте правила автоматического обновления полей сделки во время разговора" (ref=e204)
- **Кнопка раскрытия/сворачивания** (ref=e205):
  - **Тип:** button
  - **Функция:** Раскрывает/скрывает настройки правил обновления полей сделки
- **Кнопки управления списком полей:**
  - **"Свернуть все"** (ref=e218):
    - **Тип:** button
    - **Текст:** "Свернуть все"
    - **Функция:** Сворачивает все развернутые поля в списке
  - **"Развернуть все"** (ref=e221):
    - **Тип:** button
    - **Текст:** "Развернуть все"
    - **Функция:** Разворачивает все свернутые поля в списке
- **Список полей** (ref=e223):
  - **Структура:** list с listitem для каждого поля
  - **Примеры полей:**
    - **"Тип услуги"** (ref=e225, e233):
      - **Кнопки управления:**
        - **"Переместить"** (ref=e229) - перемещение правила вверх/вниз
        - **"Удалить"** (ref=e236) - удаление правила
        - **"Свернуть"/"Развернуть"** (ref=e242, e561) - сворачивание/разворачивание формы
      - **Развернутое содержимое** (ref=e569):
        - **Поле "Поле"** (обязательное, ref=e466, e469, e470):
          - **Тип:** combobox (ref=e475, e584)
          - **Label:** "Поле" с обязательным маркером "*"
          - **Placeholder:** "Выберите поле для обновления" (ref=e478, e587)
          - **Функция:** Выбор поля сделки для обновления
          - **Источник данных:** Поля синхронизируются из CRM через кнопку "Синхронизировать настройки CRM"
          - **Выбранное значение:** Отображается как тег с кнопкой удаления (например, "Тип услуги" с кнопкой "Remove item: 'cf_564832'", ref=e588)
          - **Список полей:** Все доступные поля сделки из CRM (стандартные и пользовательские поля) - аналогично списку в разделе "Настройки доступа к данным"
        - **Переключатель "Перезаписать существующее значение"** (ref=e483, e593):
          - **Тип:** switch
          - **Label:** "Перезаписать существующее значение" (ref=e485, e595)
          - **Состояния:** checked/unchecked (ref=e484, e594)
          - **Функция:** Определяет, перезаписывать ли существующее значение поля
        - **Поле "Условие обновления"** (обязательное, ref=e488, e598):
          - **Тип:** textbox (ref=e497, e607)
          - **Label:** "Условие обновления" с обязательным маркером "*" (ref=e491, e492, e601, e602)
          - **Placeholder:** "Например: когда клиент упоминает цену"
          - **Значение:** Текущее условие (например, "Когда клиент говорит о услуге которая его интересует нужно из выпадающего списка выбрать услугу")
          - **Функция:** Описание условия, при котором поле должно быть обновлено
    - **"Email"** (ref=e246, e254):
      - Аналогичная структура с кнопками управления и развернутым содержимым
- **Кнопка "Добавить поле"** (ref=e268):
  - **Тип:** button
  - **Текст:** "Добавить поле" (ref=e269)
  - **Функция:** Добавляет новое правило обновления поля сделки
  - **Поведение:** При клике появляется новая форма для настройки правила (аналогична существующим полям)

##### 3. Подсекция "Данные контакта"
- **Заголовок:** "Данные контакта" (level=3, ref=e277)
- **Описание:** "Определите правила автоматического обновления полей контакта во время разговора" (ref=e278)
- **Кнопка раскрытия/сворачивания** (ref=e279):
  - **Тип:** button
  - **Функция:** Раскрывает/скрывает настройки правил обновления полей контакта
- **Список полей** (ref=e290):
  - **Структура:** list с listitem для каждого поля
  - **Примеры полей:**
    - **"Email"** (ref=e292, e300):
      - **Кнопки управления:**
        - **"Переместить"** (ref=e296) - перемещение правила вверх/вниз
        - **"Удалить"** (ref=e303) - удаление правила
        - **"Свернуть"/"Развернуть"** (ref=e309) - сворачивание/разворачивание формы
      - **Развернутое содержимое:**
        - **Поле "Поле"** (обязательное):
          - **Тип:** combobox
          - **Label:** "Поле" с обязательным маркером "*"
          - **Placeholder:** "Выберите поле для обновления"
          - **Функция:** Выбор поля контакта для обновления
          - **Источник данных:** Поля синхронизируются из CRM через кнопку "Синхронизировать настройки CRM"
          - **Выбранное значение:** Отображается как тег с кнопкой удаления
          - **Список полей:** Все доступные поля контакта из CRM (стандартные и пользовательские поля) - аналогично списку в разделе "Настройки доступа к данным"
        - **Переключатель "Перезаписать существующее значение":**
          - **Тип:** switch
          - **Label:** "Перезаписать существующее значение"
          - **Состояния:** checked/unchecked
          - **Функция:** Определяет, перезаписывать ли существующее значение поля
        - **Поле "Условие обновления"** (обязательное):
          - **Тип:** textbox
          - **Label:** "Условие обновления" с обязательным маркером "*"
          - **Placeholder:** "Например: когда клиент упоминает цену"
          - **Функция:** Описание условия, при котором поле должно быть обновлено
- **Кнопка "Добавить поле"** (ref=e314):
  - **Тип:** button
  - **Текст:** "Добавить поле" (ref=e315)
  - **Функция:** Добавляет новое правило обновления поля контакта
  - **Поведение:** При клике появляется новая форма для настройки правила (аналогична существующим полям и форме для сделок)

#### Кнопки действий
- **"Сохранить"** (ref=e318):
  - **Тип:** button
  - **Текст:** "Сохранить" (ref=e319)
  - **Функция:** Сохранение изменений настроек сделок и контактов
- **"Отмена"** (ref=e320):
  - **Тип:** button
  - **Текст:** "Отмена" (ref=e321)
  - **Функция:** Отмена изменений и возврат на предыдущую страницу

---

### Вкладка "Триггеры"

#### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/{id}/triggers`

#### Title (Заголовок страницы)
"Триггеры - GPT Агент"

#### Структура страницы

##### 1. Заголовок и описание
- **Heading** "Триггеры" (level=3, ref=e89)
- **Описание:** "Выполняйте мгновенные действия при соблюдении определённых условий в ходе разговора." (ref=e90)

##### 2. Кнопка "Создать"
- **Тип:** button (ref=e92)
- **Текст:** "Создать" (ref=e93)
- **Функция:** Открывает модальное окно для создания нового триггера
- **Расположение:** Рядом с заголовком секции
- **Ref:** e92, e93

##### 3. Поле поиска
- **Тип:** searchbox (ref=e103)
- **Label:** "Поиск" (ref=e97)
- **Placeholder:** "Поиск"
- **Функция:** Поиск триггеров по названию или условиям
- **Иконка:** img (ref=e100)
- **Ref:** e97, e98, e100, e103

##### 4. Кнопка "Переключить столбцы"
- **Тип:** button (ref=e106)
- **Текст:** "Переключить столбцы" (ref=e107)
- **Иконка:** img (ref=e108)
- **Функция:** Открывает Popover/Dropdown для управления видимостью столбцов таблицы триггеров
- **Ref:** e106, e107, e108

##### 5. Таблица триггеров

###### 5.1. Структура таблицы
- **Тип:** table (ref=e111)
- **Заголовки столбцов** (rowgroup, ref=e112; row, ref=e113):
  - **Checkbox "Выбрать/снять все элементы для массовых действий"** (cell, ref=e114):
    - **Тип:** checkbox (ref=e117, e372, e546)
    - **Label:** "Выбрать/снять все элементы для массовых действий." (ref=e118)
    - **Функция:** Выбор/снятие выбора всех триггеров для массовых действий
  - **"Название"** (cell, ref=e119):
    - **Тип:** generic (ref=e121)
    - **Текст:** "Название"
  - **"Активно"** (cell, ref=e122):
    - **Тип:** button (ref=e123)
    - **Текст:** "Активно" (ref=e124)
    - **Иконка:** img (ref=e125)
    - **Функция:** Сортировка по статусу активности
  - **"Условие"** (cell, ref=e127):
    - **Тип:** generic (ref=e129)
    - **Текст:** "Условие"
  - **"Actions"** (cell, ref=e130)

###### 5.2. Строки данных (rowgroup, ref=e131)
- **Пример строки** (row, ref=e132):
  - **Checkbox** (cell, ref=e133):
    - **Тип:** checkbox (ref=e136)
    - **Label:** "Выбрать/отменить 711 для массовых действий." (ref=e137)
    - **Функция:** Выбор конкретного триггера для массовых действий
  - **Название триггера** (cell, ref=e138):
    - **Тип:** button (ref=e140)
    - **Текст:** "Тип услуги \"AGENT PARTNERSHIP\"" (ref=e145)
    - **Функция:** Клик по названию триггера (возможно, открывает детали или редактирование)
  - **Switch "Активно"** (cell, ref=e146):
    - **Тип:** switch (ref=e151)
    - **Состояние:** checked (включено)
    - **Функция:** Включение/выключение триггера
  - **Условие** (cell, ref=e152):
    - **Тип:** button (ref=e154)
    - **Текст:** "Когда ты понял, что это клиент по продукту AGENT P..." (ref=e159)
    - **Функция:** Клик по условию (возможно, открывает детали)
  - **Actions** (cell, ref=e160):
    - **Кнопка "Изменить"** (ref=e163):
      - **Тип:** button
      - **Иконка:** img (ref=e164)
      - **Текст:** "Изменить" (ref=e167)
      - **Функция:** Открывает модальное окно редактирования триггера
    - **Кнопка "Удалить"** (ref=e168):
      - **Тип:** button
      - **Иконка:** img (ref=e169)
      - **Текст:** "Удалить" (ref=e171)
      - **Функция:** Удаление триггера (возможно, с подтверждением)

##### 6. Пагинация
- **Тип:** navigation (ref=e252)
- **Текст:** "Показано с 1 по 3 из 3" (ref=e253)
- **Combobox "на страницу"** (ref=e260):
  - **Тип:** combobox
  - **Label:** "на страницу" (ref=e258)
  - **Опции:**
    - **"10"** [selected] - по умолчанию
    - **"25"**
    - **"50"**
    - **"100"**
  - **Функция:** Выбор количества триггеров, отображаемых на странице
  - **Ref:** e256, e258, e260

##### 7. Модальное окно "Создать Триггер"

###### 7.1. Заголовок модального окна
- **Heading** "Создать Триггер" (level=2, ref=e384)
- **Кнопка "Закрыть"** (ref=e379):
  - **Тип:** button
  - **Текст:** "Закрыть" (ref=e380)
  - **Иконка:** img (ref=e381)
  - **Функция:** Закрытие модального окна

###### 7.2. Поля формы

**7.2.1. Поле "Название"**
- **Тип:** textbox (ref=e397)
- **Label:** "Название" с обязательным маркером "*" (ref=e392, e393)
- **Placeholder:** "Например, запрос оплаты"
- **Обязательное:** Да
- **Ref:** e389, e392, e393, e397

**7.2.2. Switch "Активно"**
- **Тип:** switch (ref=e403)
- **Label:** "Активно" (ref=e404)
- **Состояние:** checked (включено по умолчанию)
- **Функция:** Включение/выключение триггера
- **Ref:** e402, e403, e404

**7.2.3. Поле "Условие"**
- **Тип:** textbox (ref=e416)
- **Label:** "Условие" с обязательным маркером "*" (ref=e410, e411)
- **Placeholder:** "Например, если клиент просит оплатить"
- **Описание:** "Укажите, когда этот триггер должен срабатывать" (ref=e417)
- **Обязательное:** Да
- **Ref:** e407, e410, e411, e412, e416, e417

**7.2.4. Поле "Действия"**
- **Label:** "Действия" с обязательным маркером "*" (ref=e423, e424)
- **Обязательное:** Да
- **Список действий** (list, ref=e427):
  - **Структура:** Каждый элемент действия (listitem, ref=e429, e515):
    - **Кнопки управления:**
      - **"Переместить"** (ref=e433, e519):
        - **Тип:** button
        - **Иконка:** img (ref=e435, e521)
        - **Текст:** "Переместить" (ref=e434, e520)
        - **Функция:** Перемещение действия вверх/вниз в списке
        - **Состояния:** disabled (когда элемент один или первый/последний)
      - **"Удалить"** (ref=e439, e525):
        - **Тип:** button
        - **Иконка:** img (ref=e441, e527)
        - **Текст:** "Удалить" (ref=e440, e526)
        - **Функция:** Удаление действия из списка
        - **Состояния:** disabled (когда элемент один)
    - **Combobox "Выберите действие"** (ref=e456, e542):
      - **Тип:** combobox
      - **Label:** "Выберите действие" с обязательным маркером "*" (ref=e450, e451, e536, e537)
      - **Placeholder:** "Выбрать вариант" (ref=e459, e545)
      - **Обязательное:** Да
      - **Выпадающий список** (listbox, ref=e499):
        - **Textbox для поиска** (ref=e498):
          - **Placeholder:** "Введите текст для поиска..."
          - **Функция:** Поиск действий в списке
        - **Опции действий:**
          - **"Изменить этап сделки"** [selected] (ref=e500)
          - **"Остановить агентов в этом чате"** (ref=e501)
          - **"Создать задачу"** (ref=e502)
          - **"Запустить Salesbot"** (ref=e503)
          - **"Добавить теги сделки"** (ref=e504)
          - **"Добавить теги контакта"** (ref=e505)
          - **"Добавить примечание к сделке"** (ref=e506)
          - **"Добавить примечание к контакту"** (ref=e507)
          - **"Изменить ответственного"** (ref=e508)
          - **"Отправить файлы"** (ref=e509)
          - **"Отправить вебхук"** (ref=e510)
      - **Источник данных:** Предопределенный список действий (не из CRM)
      - **Ref:** e447, e450, e451, e456, e496, e497, e498, e499, e533, e536, e537, e542, e545
  - **Кнопка "Добавить действие"** (ref=e461):
    - **Тип:** button
    - **Текст:** "Добавить действие" (ref=e462)
    - **Иконка:** img (ref=e511) - появляется при disabled состоянии
    - **Функция:** Добавляет новый элемент действия в список
    - **Поведение:** При клике создается новый listitem с combobox "Выберите действие" и кнопками управления
    - **Состояния:** disabled (когда форма в процессе сохранения)
    - **Ref:** e426, e461, e462, e511

**7.2.5. Поле "Ответное сообщение"**
- **Тип:** textbox (ref=e473)
- **Label:** "Ответное сообщение" (ref=e468)
- **Placeholder:** "Например, я обработал ваш запрос и создал задачу для нашей финансовой команды."
- **Описание:** "Сообщение, возвращаемое при выполнении триггера" (ref=e474)
- **Обязательное:** Нет
- **Ref:** e465, e468, e469, e473, e474

**7.2.6. Поле "Лимит запусков в чате"**
- **Тип:** spinbutton (ref=e484)
- **Label:** "Лимит запусков в чате" (ref=e480)
- **Значение:** "0" (по умолчанию)
- **Единица измерения:** "раз" (ref=e486)
- **Описание:** "Максимальное количество запусков этого триггера в одном чате. Установите 0 для неограниченного количества." (ref=e487)
- **Функция:** Ограничение количества срабатываний триггера в одном чате
- **Ref:** e477, e480, e481, e482, e484, e486, e487

###### 7.3. Кнопки действий (ref=e489)
- **"Создать"** (ref=e490):
  - **Тип:** button
  - **Текст:** "Создать" (ref=e491)
  - **Функция:** Создание триггера и закрытие модального окна
  - **Состояния:** disabled (когда форма невалидна или в процессе сохранения)
- **"Создать и создать еще один"** (ref=e492):
  - **Тип:** button
  - **Текст:** "Создать и создать еще один" (ref=e493)
  - **Функция:** Создание триггера и оставление модального окна открытым для создания следующего
- **"Отменить"** (ref=e494):
  - **Тип:** button
  - **Текст:** "Отменить" (ref=e495)
  - **Функция:** Закрытие модального окна без сохранения
  - **Состояния:** disabled (когда форма в процессе сохранения)

##### 8. Пустое состояние
- **Иконка:** Изображение пустого состояния
- **Heading** "Не найдено Триггеры" (level=4, ref=e116)
- **Описание:** "Создать Триггер для старта."

---

### Вкладка "Цепочки"

#### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/{id}/sequences`

#### Title (Заголовок страницы)
"Цепочки - GPT Агент"

#### Структура страницы

##### 1. Заголовок и описание
- **Heading** "Цепочки" (level=3, ref=e89)
- **Описание:** "Автоматизируйте отправку последующих сообщений и выполнение действий по расписанию."

##### 2. Кнопка "Создать"
- **Тип:** link (визуально как button, ref=e92)
- **Текст:** "Создать"
- **Функция:** Открывает модальное окно "Создать Цепочка"
- **Расположение:** Рядом с заголовком секции

##### 3. Поле поиска
- **Тип:** searchbox (ref=e103)
- **Placeholder:** "Поиск"
- **Функция:** Поиск цепочек по названию или условиям

##### 4. Кнопка "Переключить столбцы"
- **Тип:** button (ref=e106)
- **Текст:** "Переключить столбцы"
- **Функция:** Открывает Popover/Dropdown для управления видимостью столбцов таблицы цепочек

##### 5. Таблица цепочек
- **Тип:** table (ref=e109)
- **Заголовки столбцов:**
  - Checkbox (для массовых действий, ref=e112)
  - Название (ref=e115)
  - Активно (switch, ref=e118)
  - Условие (ref=e121)
  - Actions (ref=e124)
- **Строки данных:** Аналогично таблице триггеров (см. раздел "Триггеры")

##### 6. Пустое состояние
- **Иконка:** Изображение пустого состояния
- **Heading** "Не найдено Цепочки" (level=4, ref=e112, e114, e116, e117)
- **Описание:** "Создать Цепочка для старта."

#### Модальное окно "Создать Цепочка"

##### 1. Общая структура
- **Тип:** dialog (ref=e243)
- **Заголовок:** "Создать Цепочка" (level=2, ref=e243)
- **Кнопка закрытия:** button (ref=e238) с иконкой "X"
- **Кнопки действий:**
  - "Создать" (button, ref=e465)
  - "Отмена" (button, ref=e467)

##### 2. Поля формы

###### 2.1. Поле "Название"
- **Тип:** textbox (ref=e256)
- **Label:** "Название*"
- **Placeholder:** "Например, Follow-up"

###### 2.2. Переключатель "Активно"
- **Тип:** switch (checked, ref=e262)
- **Label:** "Активно"

###### 2.3. Секция "Условия"
- **Заголовок:** "Условия" (level=3, ref=e271)
- **Switch "Любой этап сделки, разрешённый для этого агента ИИ"** (checked, ref=e284)
- **Поле "Не запускать цепочку, когда"** (textbox, ref=e296)
  - **Placeholder:** (предположительно, текст условия)

###### 2.4. Секция "Шаги"
- **Заголовок:** "Шаги" (level=3, ref=e305)
- **Список шагов:** list (ref=e427)
  - **Элемент шага (пример):** listitem (ref=e429)
    - Кнопки управления порядком:
      - "Переместить" (ref=e433)
      - "Переместить вверх" (ref=e434)
      - "Переместить вниз" (ref=e435)
      - "Удалить" (ref=e439)
      - "Свернуть" (ref=e442)
    - **"Время ожидания после предыдущего шага":**
      - **Spinbutton** (ref=e375): Значение (например, "1")
      - **Combobox "Delay unit"** (ref=e375):
        - **Опции:**
          - "Минуты" (selected)
          - "Часы"
          - "Дни"
    - **"Действия*":**
      - **Combobox "Выберите действие"** (ref=e415):
        - **Placeholder:** "Выбрать вариант"
        - **Опции (listbox, ref=e499):**
          - "Изменить этап сделки" (selected, ref=e500)
          - "Остановить агентов в этом чате" (ref=e501)
          - "Создать задачу" (ref=e502)
          - "Запустить Salesbot" (ref=e503)
          - "Добавить теги сделки" (ref=e504)
          - "Добавить теги контакта" (ref=e505)
          - "Добавить примечание к сделке" (ref=e506)
          - "Добавить примечание к контакту" (ref=e507)
          - "Изменить ответственного" (ref=e508)
          - "Отправить файлы" (ref=e509)
          - "Отправить вебхук" (ref=e510)
      - **Кнопка "Добавить действие"** (ref=e434):
        - **Функция:** Добавляет новый элемент действия в список
- **Кнопка "Добавить шаг"** (ref=e437):
  - **Функция:** Добавляет новый шаг в цепочку

###### 2.5. Секция "Рабочие часы"
- **Заголовок:** "Рабочие часы" (level=3, ref=e305)
- **Структура:** (требует дополнительного тестирования)

##### 3. Кнопки действий
- **"Создать"** (button, ref=e465):
  - **Функция:** Создание новой цепочки с указанными настройками
- **"Отмена"** (button, ref=e467):
  - **Функция:** Закрытие модального окна без сохранения

---

### Вкладка "Интеграции"

#### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/{id}/available-integrations`

#### Title (Заголовок страницы)
"Интеграции - GPT Агент"

#### Структура страницы

##### 1. Поле поиска
- **Тип:** searchbox
- **Placeholder:** "Поиск"
- **Функция:** Поиск интеграций по названию

##### 2. Таблица интеграций
- **Структура:**
  - **Заголовки столбцов:**
    - "Интеграция"
    - "Установлено"
    - "Активно"
    - "Actions"
  - **Строки данных:**
    - **Пример 1: "Google Calendar"**
      - **Ссылка на название** (link) → `/ai-agents/{id}/integrations/3/edit`
      - **Иконка "Установлено"** (link) - показывает статус установки
      - **Иконка "Активно"** (link) - показывает статус активности
      - **Кнопка "Настройки"** (link, ref=e162) → `/ai-agents/{id}/integrations/3/edit`
    - **Пример 2: "Kommo"**
      - **Ссылка на название** (link) → `/ai-agents/{id}/integrations/1/edit`
      - **Иконка "Установлено"** (link) - показывает статус установки
      - **Иконка "Активно"** (link) - показывает статус активности
      - **Кнопка "Настройки"** (link, ref=e162) → `/ai-agents/{id}/integrations/1/edit`

#### Страница настройки интеграции Kommo

##### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/{id}/integrations/kommo`
**Примечание:** При тестировании URL вернул 404. Возможно, правильный URL: `/ai-agents/{id}/integrations/1/edit` или `/ai-agents/{id}/integrations/kommo/edit`

##### Title (Заголовок страницы)
"Kommo - GPT Агент"

##### Структура страницы

###### 1. Заголовок страницы
- **Heading** "Kommo" (level=1, ref=e57)

###### 2. Секция "Общие настройки"
- **Заголовок:** "Общие настройки" (level=3, ref=e92)
- **Switch "Активно"** (checked, ref=e101)
  - **Label:** "Активно"
  - **Функция:** Включение/выключение интеграции
- **Кнопка "Синхронизировать настройки CRM"** (ref=e108)
  - **Тип:** button
  - **Текст:** "Синхронизировать настройки CRM"
  - **Функция:** Синхронизация данных из CRM (воронки, каналы, поля сделок, поля контактов)
  - **Поведение:** При клике выполняется синхронизация данных из Kommo CRM

###### 3. Кнопки действий
- **"Сохранить изменения"** (button, ref=e114):
  - **Функция:** Сохранение изменений настроек интеграции
- **"Отменить"** (link, ref=e116):
  - **Функция:** Отмена изменений и возврат на предыдущую страницу

---

### Вкладка "Дополнительно"

#### URL
`https://aai.widgets.wearekwid.com/manage/1000373-worldwideservices/ai-agents/{id}/advanced-settings`

#### Title (Заголовок страницы)
"Расширенные настройки - GPT Агент"

#### Структура страницы

##### 1. Секция "Модель ИИ"

###### 1.1. Заголовок
- **Heading** "Модель ИИ" (level=3, ref=e90)

###### 1.2. Поле "Выберите модель ИИ"
- **Тип:** listbox (combobox, ref=e105)
- **Label:** "Выберите модель ИИ" с обязательным маркером "*" (ref=e100)
- **Placeholder:** "Выберите модель ИИ"
- **Функция:** Выбор модели ИИ для агента
- **Выбранное значение:** Отображается как тег с кнопкой удаления (ref=e292, e293)
  - **Пример:** "OpenAI GPT-5 - Новейшая модель OpenAI с надёжными и естественными ответами"
  - **Кнопка удаления:** "Remove item: '6'" (ref=e293)
- **Опции (listbox, ref=e295):**
  - **"OpenAI GPT-4.1 - Строго следует инструкциям"** (option, ref=e296) - selected (по умолчанию)
  - **"Google Gemini 2.5 Flash - Молниеносная модель от Google"** (option, ref=e297)
  - **"Claude Sonnet 4 - Превосходен в творческом письме"** (option, disabled) - недоступна
  - **"OpenAI GPT-5 - Новейшая модель OpenAI с надёжными и естественными ответами"** (option, ref=e298) - выбрана
- **Описание:** "Выберите, насколько умным вы хотите сделать ИИ. Более продвинутые модели стоят дороже." (ref=e110)

##### 2. Секция "Язык"

###### 2.1. Заголовок
- **Heading** "Язык" (level=3, ref=e118)

###### 2.2. Переключатель "Автоматически определять язык пользователя"
- **Тип:** switch
- **Label:** "Автоматически определять язык пользователя"
- **Состояния:** checked/unchecked
- **Функция:** Включение/выключение автоматического определения языка пользователя
- **Поведение:** При переключении меняет поведение агента, выпадающих списков не появляется

##### 3. Секция "Настройки ответа"

###### 3.1. Заголовок
- **Heading** "Настройки ответа" (level=3, ref=e136)

###### 3.2. Поле "Креативность"
- **Тип:** radio group
- **Label:** "Креативность"
- **Опции:**
  - **"Точный"** (ref=e149):
    - **Тип:** radio
    - **Состояние:** unchecked
    - **Описание:** "последовательный и предсказуемый, может звучать сухо"
  - **"Сбалансированный"** (ref=e154):
    - **Тип:** radio
    - **Состояние:** checked (по умолчанию)
    - **Описание:** "естественный и легко читаемый"
  - **"Креативный"** (ref=e159):
    - **Тип:** radio
    - **Состояние:** unchecked
    - **Описание:** "выразительный и разнообразный"
- **Описание:** "Управляйте стилем ответов агента. Точный: последовательный и предсказуемый, может звучать сухо. Сбалансированный: естественный и легко читаемый. Креативный: выразительный и разнообразный."

###### 3.3. Поле "Задержка ответа (секунд)"
- **Тип:** spinbutton
- **Label:** "Задержка ответа (секунд)"
- **Значение:** "5" (по умолчанию)
- **Функция:** Установка задержки перед отправкой ответа агентом
- **Описание:** "Сколько секунд ждать перед ответом. Рекомендуем установить задержку не менее 30 секунд, чтобы избежать дублирования ответов, если клиент отправит другое сообщение, пока агент отвечает."

#### Кнопки действий
- **"Сохранить"** (ref=e177):
  - **Тип:** button
  - **Функция:** Сохранение изменений расширенных настроек
- **"Отмена"** (ref=e179):
  - **Тип:** button
  - **Функция:** Отмена изменений и возврат на предыдущую страницу

---

## Визуальные детали

### Цветовая схема
- **Фон страницы:** Светлый (белый/светло-серый)
- **Фон элементов:** Белый для карточек и модальных окон
- **Тени:** Мягкие тени для карточек и модальных окон
- **Границы:** Скругленные углы (border-radius)

### Типографика
- **Заголовки:** Жирный шрифт, различные размеры (h1, h3, h4)
- **Текст:** Стандартный размер шрифта
- **Обязательные поля:** Маркер "*" красного цвета

### Анимации
- **Переходы:** Плавные переходы при открытии/закрытии модальных окон и dropdown'ов
- **Hover эффекты:** Изменение цвета при наведении на кнопки и ссылки

---

## Технические детали для разработчиков

### Архитектура страниц
1. **Страница списка агентов:** `/ai-agents` - отображает таблицу всех агентов
2. **Страница создания агента:** `/ai-agents/create` - форма создания нового агента
3. **Страница редактирования агента:** `/ai-agents/{id}/edit` - основная страница редактирования с вкладками
4. **Вкладки редактирования:**
   - Основные: `/ai-agents/{id}/edit` (тот же URL)
   - Сделки и контакты: `/ai-agents/{id}/leads-contacts`
   - Триггеры: `/ai-agents/{id}/triggers`
   - Цепочки: `/ai-agents/{id}/sequences`
   - Интеграции: `/ai-agents/{id}/available-integrations`
   - Дополнительно: `/ai-agents/{id}/advanced-settings`

### Критически важные переключатели с выпадающими списками
1. **"Все каналы"** (вкладка "Основные"):
   - При unchecked → появляется combobox "Выбрать каналы"
2. **"Разрешить доступ ко всем категориям"** (вкладка "Основные"):
   - При unchecked → появляется tree selector "Выбрать категории"

### Состояния элементов
- **Переключатели:** checked/unchecked
- **Кнопки:** active/inactive, disabled/enabled
- **Поля формы:** filled/empty, valid/invalid
- **Модальные окна:** open/closed
- **Dropdown'ы:** open/closed

### Валидация
- **Обязательные поля:** Отмечены маркером "*"
- **Валидация формы:** Проверка обязательных полей перед сохранением

### API endpoints (предполагаемые)
- `GET /api/ai-agents` - получение списка агентов
- `POST /api/ai-agents` - создание нового агента
- `GET /api/ai-agents/{id}` - получение данных агента
- `PUT /api/ai-agents/{id}` - обновление агента
- `DELETE /api/ai-agents/{id}` - удаление агента
- `POST /api/ai-agents/{id}/copy` - копирование агента
- `POST /api/ai-agents/{id}/sync-crm` - синхронизация с CRM (воронки, этапы, каналы, поля сделок, поля контактов)

### Источники данных из CRM системы

#### Воронки и этапы
- **Источник:** Kommo (amoCRM) API
- **Синхронизация:** Через кнопку "Синхронизировать настройки CRM" в секции "Настройки воронок"
- **Данные:** Список всех воронок (pipelines) и их этапов (stages) из CRM
- **Примеры воронок:** "GENERATION LEAD", "WORK VISA IN POLAND", "SEASONAL VISA IN POLAND", "STUDY VISA IN GEORGIA", "AGENT PARTNERSHIP", "PRODUCT VENDORS (PARTNERSHIP)"

#### Каналы
- **Источник:** Kommo (amoCRM) API
- **Синхронизация:** Через кнопку "Синхронизировать настройки CRM" в секции "Каналы"
- **Данные:** Список всех каналов связи из CRM
- **Примеры каналов:**
  - "Instagram (World Wide Services)"
  - "WhatsApp Business (Whats App )"
  - "Facebook (Worldwideservices)"
  - "Teletype service (Teletype App)"
  - "Whatsapp (WhatsApp via Twilio)"
  - "whatsApp (WhatsApp via Gupshup)"
  - "RingCentral SMS (RingCentral Text Messaging)"
  - "Twilio Text Messaging (Twilio Text Messaging)"
  - "TikTok (TikTok)"
  - "Live Chat (WORK VISA IN POLAND)"
  - "Live Chat (Live chat)"
  - "WhatsApp Lite (WhatsApp Lite)"

#### Поля сделок
- **Источник:** Kommo (amoCRM) API
- **Синхронизация:** Через кнопку "Синхронизировать настройки CRM" в секции "Настройки доступа к данным" > "Данные сделки"
- **Данные:** Все доступные поля сделки (стандартные и пользовательские поля)
- **Примеры полей:** "Этап сделки" (status_id), название, сумма, ответственный, и другие поля из CRM

#### Поля контактов
- **Источник:** Kommo (amoCRM) API
- **Синхронизация:** Через кнопку "Синхронизировать настройки CRM" в секции "Настройки доступа к данным" > "Данные контакта"
- **Данные:** Все доступные поля контакта (стандартные и пользовательские поля)
- **Примеры полей:** "Имя контакта" (name), телефон, email, компания, и другие поля из CRM

---

## Компоненты UI (Переиспользуемые компоненты)

### Компонент: Switch (Переключатель)

#### Назначение
Включение/выключение функций и настроек агента.

#### Варианты использования
1. **"Активно"** (агент)
   - Расположение: Секция "Профиль агента", таблица агентов
   - Функция: Включение/выключение работы агента
   - Поведение: Простое переключение состояния, без условной видимости

2. **"Все каналы"**
   - Расположение: Секция "Каналы"
   - Функция: Включение/выключение работы агента во всех каналах
   - **Критическое поведение:** При unchecked → появляется combobox "Выбрать каналы" (обязательное поле)

3. **"Разрешить доступ ко всем категориям"**
   - Расположение: Секция "База знаний"
   - Функция: Включение/выключение доступа ко всем категориям
   - **Критическое поведение:** При unchecked → появляется tree selector "Выбрать категории" (обязательное поле)

4. **"Проверять перед отправкой"**
   - Расположение: Секция "Взаимодействие"
   - Функция: Включение режима проверки сообщений перед отправкой
   - Поведение: Простое переключение состояния

5. **"Создать задачу, если ответ не найден"**
   - Расположение: Секция "База знаний"
   - Функция: Автоматическое создание задачи в CRM при отсутствии ответа
   - Поведение: Простое переключение состояния

6. **"Перезаписать существующее значение"**
   - Расположение: Форма правила обновления поля (сделки/контакты)
   - Функция: Определяет, перезаписывать ли существующее значение поля
   - Поведение: Простое переключение состояния

7. **"Автоматически определять язык пользователя"**
   - Расположение: Вкладка "Дополнительно", секция "Язык"
   - Функция: Включение автоматического определения языка
   - Поведение: Простое переключение состояния

#### Состояния
- **checked:** Включено (активное состояние)
- **unchecked:** Выключено (неактивное состояние)
- **disabled:** Отключено (недоступно для взаимодействия)

#### Визуальное оформление
- Переключатель с меткой слева или справа
- Цветовая индикация состояния (обычно синий/зеленый для checked)
- Плавная анимация переключения

#### Accessibility
- `role="switch"`
- `aria-checked` для указания состояния
- `aria-label` или связанная метка через `aria-labelledby`
- Поддержка клавиатуры: Space/Enter для переключения

---

### Компонент: Combobox (Множественный выбор)

#### Назначение
Выбор одного или нескольких значений из списка с возможностью поиска и фильтрации.

#### Варианты использования
1. **"Выбрать каналы"**
   - Расположение: Секция "Каналы" (появляется при unchecked "Все каналы")
   - Тип: Множественный выбор
   - Обязательное поле: Да (*)
   - Источник данных: CRM (синхронизация через кнопку)
   - Особенности: Отображение выбранных значений как теги с кнопкой удаления

2. **"Выберите поля сделки"**
   - Расположение: Вкладка "Сделки и контакты", секция "Настройки доступа к данным"
   - Тип: Множественный выбор
   - Обязательное поле: Нет
   - Источник данных: CRM (поля сделки)
   - Особенности: Теги с кнопкой удаления, пример: "Этап сделки" (status_id)

3. **"Выберите поля контакта"**
   - Расположение: Вкладка "Сделки и контакты", секция "Настройки доступа к данным"
   - Тип: Множественный выбор
   - Обязательное поле: Нет
   - Источник данных: CRM (поля контакта)
   - Особенности: Теги с кнопкой удаления, пример: "Имя контакта" (name)

4. **"Поле"** (в правилах обновления)
   - Расположение: Форма правила обновления поля (сделки/контакты)
   - Тип: Одиночный выбор
   - Обязательное поле: Да (*)
   - Источник данных: CRM (поля сделки или контакта в зависимости от контекста)
   - Особенности: Выбор одного поля для правила

5. **"Выберите модель ИИ"**
   - Расположение: Вкладка "Дополнительно", секция "Модель ИИ"
   - Тип: Одиночный выбор
   - Обязательное поле: Да (*)
   - Источник данных: Локальная БД (список доступных моделей)
   - Особенности: Отображение выбранного значения как тег с описанием

#### Структура компонента
- **Input field:** Поле ввода с placeholder
- **Dropdown/Listbox:** Выпадающий список опций
- **Tags:** Отображение выбранных значений как теги
- **Remove button:** Кнопка удаления на каждом теге
- **Search/Filter:** Поиск и фильтрация в списке (если доступно)

#### Состояния
- **default:** Пустое поле с placeholder
- **focused:** Активное поле ввода
- **expanded:** Открытый список опций
- **selected:** Выбранные значения отображаются как теги
- **disabled:** Недоступно для взаимодействия
- **error:** Ошибка валидации (красная рамка, сообщение об ошибке)

#### Визуальное оформление
- Белый фон поля ввода
- Скругленные углы
- Тень при открытом dropdown
- Теги с цветным фоном и иконкой удаления
- Иконка стрелки для открытия списка

#### Accessibility
- `role="combobox"`
- `aria-expanded` для состояния dropdown
- `aria-autocomplete="list"` для множественного выбора
- `aria-required` для обязательных полей
- `aria-describedby` для описаний и ошибок
- Поддержка клавиатуры: Arrow keys для навигации, Enter для выбора, Escape для закрытия

---

### Компонент: Tree Selector

#### Назначение
Иерархический выбор категорий из базы знаний с поддержкой вложенных структур.

#### Использование
- **"Выбрать категории"**
  - Расположение: Секция "База знаний" (появляется при unchecked "Разрешить доступ ко всем категориям")
  - Тип: Множественный иерархический выбор
  - Обязательное поле: Да (*)
  - Источник данных: Локальная БД (категории базы знаний)
  - Особенности: Поддержка вложенных категорий, визуализация иерархии

#### Структура компонента
- **Input field:** Поле ввода с placeholder "Выбрать вариант"
- **Tree view:** Древовидная структура категорий
- **Checkboxes:** Чекбоксы для выбора категорий
- **Expand/Collapse:** Кнопки раскрытия/сворачивания узлов дерева
- **Selected values:** Отображение выбранных категорий (если доступно)

#### Состояния
- **default:** Пустое поле
- **expanded:** Открытое дерево категорий
- **selected:** Выбранные категории отмечены
- **disabled:** Недоступно для взаимодействия

#### Визуальное оформление
- Textbox с иконкой стрелки
- Древовидная структура с отступами для вложенности
- Чекбоксы для выбора
- Описание: "Агент будет получать доступ к знаниям только из этих категорий"

#### Accessibility
- `role="tree"`
- `aria-expanded` для узлов дерева
- `aria-selected` для выбранных элементов
- Поддержка клавиатуры: Arrow keys для навигации, Space для выбора, Enter для раскрытия

---

### Компонент: Modal/Dialog

#### Назначение
Подтверждение критических действий (удаление, копирование).

#### Варианты использования
1. **Подтверждение копирования агента**
   - Триггер: Кнопка "Копировать" в таблице агентов
   - Заголовок: "Копировать агента?"
   - Текст: Описание действия копирования
   - Кнопки: "Отменить", "Копировать"

2. **Подтверждение удаления агента**
   - Триггер: Кнопка "Удалить" (в таблице или на странице редактирования)
   - Заголовок: "Удалить агента?"
   - Текст: Описание действия удаления
   - Кнопки: "Отменить", "Удалить"

3. **Подтверждение удаления категории**
   - Триггер: Кнопка "Удалить" на странице категорий
   - Заголовок: "Удалить категорию?"
   - Текст: Описание действия удаления
   - Кнопки: "Отменить", "Удалить"

#### Структура компонента
- **Overlay:** Затемненный фон (backdrop)
- **Dialog container:** Контейнер модального окна
- **Header:** Заголовок модального окна
- **Body:** Текст подтверждения
- **Footer:** Кнопки действий

#### Состояния
- **closed:** Скрыто
- **opening:** Анимация открытия
- **open:** Видимо и активно
- **closing:** Анимация закрытия

#### Визуальное оформление
- Белый фон контейнера
- Скругленные углы
- Тень для глубины
- Затемненный overlay (обычно 50% прозрачности черного)
- Кнопка "Отменить" - вторичная (outline)
- Кнопка действия - первичная (filled, может быть красной для удаления)

#### Accessibility
- `role="dialog"`
- `aria-modal="true"`
- `aria-labelledby` для заголовка
- `aria-describedby` для описания
- Фокус на первую интерактивную кнопку при открытии
- Закрытие по Escape
- Фокус возвращается к триггеру при закрытии

---

### Компонент: Tabs (Вкладки)

#### Назначение
Навигация между разделами редактирования агента.

#### Вкладки
1. **"Основные"** - `/ai-agents/{id}/edit`
2. **"Сделки и контакты"** - `/ai-agents/{id}/leads-contacts`
3. **"Триггеры"** - `/ai-agents/{id}/triggers`
4. **"Цепочки"** - `/ai-agents/{id}/sequences`
5. **"Интеграции"** - `/ai-agents/{id}/available-integrations`
6. **"Дополнительно"** - `/ai-agents/{id}/advanced-settings`

#### Поведение
- При клике на вкладку происходит переход на соответствующую страницу (URL меняется)
- Активная вкладка визуально выделена
- Иконка для каждой вкладки

#### Состояния
- **active:** Активная вкладка (текущая страница)
- **inactive:** Неактивная вкладка
- **hover:** Наведение курсора
- **disabled:** Отключенная вкладка (если применимо)

#### Визуальное оформление
- Горизонтальное расположение вкладок
- Подчеркивание или цветной фон для активной вкладки
- Иконка + текст для каждой вкладки
- Плавный переход при переключении

#### Accessibility
- `role="tablist"` для контейнера
- `role="tab"` для каждой вкладки
- `role="tabpanel"` для контента
- `aria-selected` для активной вкладки
- `aria-controls` для связи вкладки с панелью
- Поддержка клавиатуры: Arrow keys для навигации, Enter/Space для активации

---

### Компонент: Form (Форма)

#### Назначение
Сбор и валидация данных для создания/редактирования агента.

#### Структура
- **Form fields:** Поля ввода различных типов
- **Labels:** Метки полей с обязательными маркерами (*)
- **Descriptions:** Описания и подсказки под полями
- **Validation messages:** Сообщения об ошибках валидации
- **Action buttons:** Кнопки "Сохранить" и "Отмена"

#### Типы полей
- **Textbox:** Однострочный ввод (название)
- **Textarea:** Многострочный ввод (инструкции, сообщения)
- **Combobox:** Выбор из списка
- **Tree Selector:** Иерархический выбор
- **Switch:** Переключатель
- **Radio Group:** Группа радиокнопок (креативность)
- **Spinbutton:** Числовой ввод (задержка ответа)

#### Валидация
- Обязательные поля помечены "*"
- Проверка при отправке формы
- Отображение ошибок под полями
- Блокировка кнопки "Сохранить" при наличии ошибок

#### Accessibility
- `role="form"`
- `aria-required` для обязательных полей
- `aria-invalid` для полей с ошибками
- `aria-describedby` для описаний и сообщений об ошибках
- Логический порядок табуляции

---

## Структура страниц по блокам

### Страница списка агентов (`/ai-agents`)

#### Блок 1: Заголовок и действия
**Расположение:** Верхняя часть страницы

**Элементы:**
- Breadcrumbs: "Агенты ИИ"
- Заголовок страницы: "Агенты ИИ" (h1)
- Кнопка "Создать" (link, правый верхний угол)
- Поле поиска (searchbox)
- Кнопка "Переключить столбцы" (button)

**Функциональность:**
- Поиск фильтрует агентов по названию в реальном времени
- "Переключить столбцы" открывает dropdown для управления видимостью столбцов

---

#### Блок 2: Таблица агентов
**Расположение:** Основная область страницы

**Структура:**
- **Заголовки столбцов:**
  - Checkbox для массового выбора
  - "Название" (с возможностью сортировки)
  - "Активно" (переключатель)
  - "Модель ИИ" (ссылка на редактирование)
  - "Created at" (опционально)
  - "Updated at" (опционально)
  - "Actions" (действия)

- **Строки данных:**
  - Checkbox для выбора строки
  - Название агента (ссылка на редактирование)
  - Переключатель "Активно"
  - Модель ИИ (ссылка на редактирование)
  - Дата создания (если видима)
  - Дата обновления (если видима)
  - Действия: "Изменить", "Копировать", "Удалить"

**Функциональность:**
- Переключатель "Активно" меняет состояние агента сразу (без подтверждения)
- Кнопка "Копировать" открывает модальное окно подтверждения
- Кнопка "Удалить" открывает модальное окно подтверждения
- Кнопка "Изменить" переходит на страницу редактирования

---

#### Блок 3: Пагинация
**Расположение:** Нижняя часть таблицы

**Элементы:**
- Текст: "Показано с X по Y из Z"
- Dropdown "на страницу": 10, 25, 50, 100
- Кнопки навигации: "Предыдущая страница", "Следующая страница"

**Функциональность:**
- Изменение количества записей на странице
- Навигация между страницами

---

### Страница редактирования агента (`/ai-agents/{id}/edit`)

#### Блок 1: Заголовок и навигация
**Расположение:** Верхняя часть страницы

**Элементы:**
- Breadcrumbs: "Агенты ИИ" > "{Название агента}" > "{Текущая вкладка}"
- Заголовок страницы: "Редактирование {Название агента}" (h1)
- Кнопка "Удалить" (button, правый верхний угол)
- Вкладки (Tabs): Основные, Сделки и контакты, Триггеры, Цепочки, Интеграции, Дополнительно

**Функциональность:**
- Breadcrumbs позволяют вернуться на предыдущие уровни
- Кнопка "Удалить" открывает модальное окно подтверждения
- Вкладки переключают между разделами (меняется URL)

---

#### Блок 2: Секция "Профиль агента"
**Расположение:** Вкладка "Основные", первая секция

**Элементы:**
- Иконка секции
- Заголовок: "Профиль агента" (h3)
- Поле "Название" (textbox, обязательное)
- Переключатель "Активно"
- Поле "Инструкции для агента" (textarea, обязательное)
- Описание под полем инструкций

**Функциональность:**
- Валидация обязательных полей
- Сохранение изменений при нажатии "Сохранить"

---

#### Блок 3: Секция "Взаимодействие"
**Расположение:** Вкладка "Основные", вторая секция

**Элементы:**
- Иконка секции
- Заголовок: "Взаимодействие" (h3)
- Переключатель "Проверять перед отправкой"
- Описание под переключателем

**Функциональность:**
- Переключение режима работы агента

---

#### Блок 4: Секция "Настройки воронок"
**Расположение:** Вкладка "Основные", третья секция

**Элементы:**
- Иконка секции
- Заголовок: "Настройки воронок" (h3)
- Описание секции
- Кнопка "Синхронизировать настройки CRM"
- Список воронок:
  - Заголовок воронки (h3)
  - Кнопка раскрытия этапов
  - Переключатель "Активно"

**Функциональность:**
- Кнопка синхронизации обновляет список воронок и этапов из CRM
- Кнопка раскрытия показывает/скрывает этапы воронки
- Переключатель включает/выключает работу агента в воронке

---

#### Блок 5: Секция "Каналы"
**Расположение:** Вкладка "Основные", четвертая секция

**Элементы:**
- Иконка секции
- Заголовок: "Каналы" (h3)
- Описание секции
- Кнопка "Синхронизировать настройки CRM"
- Переключатель "Все каналы"
- Combobox "Выбрать каналы" (условный, появляется при unchecked)

**Функциональность:**
- Кнопка синхронизации обновляет список каналов из CRM
- Переключатель "Все каналы" управляет видимостью combobox
- При unchecked combobox становится обязательным полем

---

#### Блок 6: Секция "База знаний"
**Расположение:** Вкладка "Основные", пятая секция

**Элементы:**
- Иконка секции
- Заголовок: "База знаний" (h3)
- Переключатель "Разрешить доступ ко всем категориям"
- Tree selector "Выбрать категории" (условный, появляется при unchecked)
- Переключатель "Создать задачу, если ответ не найден"
- Описание под переключателем
- Поле "Сообщение при отсутствии ответа" (textarea)
- Описание под полем
- Ссылка "Открыть базу знаний"

**Функциональность:**
- Переключатель "Разрешить доступ ко всем категориям" управляет видимостью tree selector
- При unchecked tree selector становится обязательным полем
- Ссылка переходит на страницу базы знаний

---

#### Блок 7: Действия формы
**Расположение:** Нижняя часть страницы (sticky или fixed)

**Элементы:**
- Кнопка "Сохранить" (primary)
- Кнопка "Отмена" (secondary)

**Функциональность:**
- "Сохранить" валидирует и сохраняет все изменения
- "Отмена" возвращает на предыдущую страницу без сохранения

---

### Вкладка "Сделки и контакты" (`/ai-agents/{id}/leads-contacts`)

#### Блок 1: Секция "Настройки доступа к данным"
**Элементы:**
- Иконка секции
- Заголовок: "Настройки доступа к данным" (h3)
- Описание секции
- Кнопка "Синхронизировать настройки CRM"
- Подсекция "Данные сделки":
  - Заголовок (h3)
  - Описание
  - Кнопка раскрытия/сворачивания
  - Combobox "Выберите поля сделки"
- Подсекция "Данные контакта":
  - Заголовок (h3)
  - Описание
  - Кнопка раскрытия/сворачивания
  - Combobox "Выберите поля контакта"

**Функциональность:**
- Кнопка синхронизации обновляет поля из CRM
- Кнопки раскрытия показывают/скрывают настройки полей
- Combobox позволяют выбрать множественные поля

---

#### Блок 2: Секция "Настройки ввода данных"
**Элементы:**
- Иконка секции
- Заголовок: "Настройки ввода данных" (h3)
- Описание секции
- Подсекция "Данные сделки":
  - Заголовок (h3)
  - Описание
  - Кнопка раскрытия/сворачивания
  - Кнопка "Добавить поле"
  - Формы правил обновления полей (динамические)
- Подсекция "Данные контакта":
  - Заголовок (h3)
  - Описание
  - Кнопка раскрытия/сворачивания
  - Кнопка "Добавить поле"
  - Формы правил обновления полей (динамические)

**Функциональность:**
- Кнопка "Добавить поле" создает новую форму правила
- Формы правил можно перемещать, удалять, сворачивать
- Каждая форма содержит: поле выбора, переключатель, условие обновления

---

## Состояния компонентов и взаимодействия

### Условная видимость компонентов

#### Правило 1: Переключатель "Все каналы"
- **Когда checked:** 
  - Combobox "Выбрать каналы" скрыт
  - Агент работает во всех каналах
- **Когда unchecked:** 
  - Combobox "Выбрать каналы" становится видимым
  - Combobox становится обязательным полем (*)
  - Агент работает только в выбранных каналах

#### Правило 2: Переключатель "Разрешить доступ ко всем категориям"
- **Когда checked:** 
  - Tree selector "Выбрать категории" скрыт
  - Агент имеет доступ ко всем категориям
- **Когда unchecked:** 
  - Tree selector "Выбрать категории" становится видимым
  - Tree selector становится обязательным полем (*)
  - Агент имеет доступ только к выбранным категориям

### Взаимодействия между компонентами

#### Синхронизация CRM
**Кнопка "Синхронизировать настройки CRM"** обновляет следующие данные:

1. **В секции "Настройки воронок":**
   - Список всех воронок (pipelines)
   - Список этапов (stages) для каждой воронки

2. **В секции "Каналы":**
   - Список всех каналов связи

3. **В секции "Настройки доступа к данным":**
   - Список полей сделок (стандартные и пользовательские)
   - Список полей контактов (стандартные и пользовательские)

**Поведение:**
- При клике показывается индикатор загрузки
- После успешной синхронизации обновляются все связанные combobox и списки
- При ошибке показывается уведомление об ошибке

#### Динамическое добавление правил
**Кнопка "Добавить поле"** в секции "Настройки ввода данных":

- Создает новую форму правила
- Форма содержит:
  - Кнопки управления (переместить, удалить, свернуть)
  - Поле выбора (combobox, обязательное)
  - Переключатель "Перезаписать существующее значение"
  - Поле "Условие обновления" (textbox, обязательное)
- Можно добавить несколько правил
- Правила можно переупорядочивать

#### Раскрытие/сворачивание секций
**Кнопки раскрытия/сворачивания:**

- В секции "Настройки воронок": раскрывает/скрывает этапы воронки
- В секции "Настройки доступа к данным": раскрывает/скрывает настройки полей
- В секции "Настройки ввода данных": раскрывает/скрывает формы правил
- Состояние (раскрыто/свернуто) может сохраняться в localStorage

### Состояния загрузки

#### Синхронизация CRM
- **Loading:** Кнопка показывает индикатор загрузки (spinner)
- **Success:** Уведомление об успешной синхронизации
- **Error:** Уведомление об ошибке с описанием

#### Сохранение формы
- **Loading:** Кнопка "Сохранить" показывает индикатор загрузки
- **Disabled:** Кнопки "Сохранить" и "Отмена" становятся недоступными
- **Success:** Уведомление об успешном сохранении
- **Error:** Отображение ошибок валидации под полями

---

## Responsive Design

### Breakpoints
- **Desktop:** > 1024px (полная функциональность)
- **Tablet:** 768px - 1024px (адаптированная верстка)
- **Mobile:** < 768px (мобильная версия)

### Адаптация компонентов

#### Таблица агентов
**Desktop:**
- Полная таблица со всеми столбцами
- Все действия видны
- Горизонтальная прокрутка не требуется

**Tablet:**
- Некоторые столбцы могут быть скрыты по умолчанию
- Действия в dropdown меню
- Горизонтальная прокрутка при необходимости

**Mobile:**
- Таблица преобразуется в карточки
- Каждая карточка содержит:
  - Название агента
  - Переключатель "Активно"
  - Модель ИИ
  - Действия (dropdown меню)
- Вертикальная прокрутка

---

#### Форма редактирования
**Desktop:**
- Все секции видны одновременно
- Вертикальная прокрутка при необходимости
- Кнопки действий внизу страницы (sticky или fixed)

**Tablet:**
- Секции могут быть в аккордеоне
- Кнопки действий внизу страницы (sticky)

**Mobile:**
- Секции в аккордеоне (свернуты по умолчанию)
- Кнопки действий внизу страницы (fixed, всегда видимы)
- Полноэкранный режим для модальных окон

---

#### Вкладки (Tabs)
**Desktop:**
- Горизонтальные вкладки в одну строку
- Все вкладки видны

**Tablet:**
- Горизонтальные вкладки с возможностью прокрутки
- Или dropdown меню для вкладок

**Mobile:**
- Dropdown меню для выбора вкладки
- Или вертикальное меню (sidebar)
- Текущая вкладка отображается в заголовке

---

#### Combobox и Tree Selector
**Desktop:**
- Dropdown открывается под полем
- Полная ширина списка

**Tablet:**
- Dropdown открывается под полем
- Адаптированная ширина

**Mobile:**
- Dropdown может открываться в модальном окне
- Полноэкранный режим для tree selector
- Улучшенная навигация для touch-устройств

---

#### Модальные окна
**Desktop:**
- Центрированное модальное окно
- Ширина: ~500px

**Tablet:**
- Центрированное модальное окно
- Ширина: ~90% экрана

**Mobile:**
- Полноэкранное модальное окно
- Кнопка закрытия в заголовке

---

## Accessibility (Доступность)

### ARIA атрибуты

#### Переключатели (Switch)
- `role="switch"`
- `aria-checked="true|false"` - состояние переключателя
- `aria-label` или связанная метка через `aria-labelledby`
- `aria-describedby` для описаний (если есть)

#### Combobox
- `role="combobox"`
- `aria-expanded="true|false"` - состояние dropdown
- `aria-autocomplete="list"` - для множественного выбора
- `aria-required="true"` - для обязательных полей
- `aria-invalid="true|false"` - для полей с ошибками
- `aria-describedby` - для описаний и сообщений об ошибках
- `aria-controls` - связь с listbox

#### Tree Selector
- `role="tree"`
- `aria-expanded="true|false"` - для узлов дерева
- `aria-selected="true|false"` - для выбранных элементов
- `aria-level` - уровень вложенности
- `aria-setsize` - количество элементов на уровне
- `aria-posinset` - позиция элемента на уровне

#### Модальные окна
- `role="dialog"`
- `aria-modal="true"`
- `aria-labelledby` - связь с заголовком
- `aria-describedby` - связь с описанием
- `aria-label` для кнопки закрытия

#### Вкладки (Tabs)
- `role="tablist"` - для контейнера вкладок
- `role="tab"` - для каждой вкладки
- `role="tabpanel"` - для контента вкладки
- `aria-selected="true|false"` - для активной вкладки
- `aria-controls` - связь вкладки с панелью
- `aria-labelledby` - связь панели с вкладкой

#### Формы
- `role="form"`
- `aria-required="true"` - для обязательных полей
- `aria-invalid="true|false"` - для полей с ошибками
- `aria-describedby` - для описаний и сообщений об ошибках

### Keyboard Navigation

#### Общая навигация
- **Tab:** Переход между интерактивными элементами
- **Shift+Tab:** Обратный переход
- **Enter/Space:** Активация кнопок и переключателей
- **Escape:** Закрытие модальных окон и dropdown'ов

#### Переключатели (Switch)
- **Space/Enter:** Переключение состояния
- Фокус визуально выделен

#### Combobox
- **Arrow Down/Up:** Открытие dropdown и навигация по опциям
- **Enter:** Выбор опции
- **Escape:** Закрытие dropdown
- **Backspace:** Удаление последнего выбранного значения (если применимо)

#### Tree Selector
- **Arrow Right:** Раскрытие узла
- **Arrow Left:** Сворачивание узла
- **Arrow Down/Up:** Навигация по узлам
- **Space:** Выбор/снятие выбора узла
- **Enter:** Раскрытие/сворачивание узла

#### Вкладки (Tabs)
- **Arrow Left/Right:** Навигация между вкладками
- **Home/End:** Переход к первой/последней вкладке
- **Enter/Space:** Активация вкладки

#### Модальные окна
- **Escape:** Закрытие модального окна
- **Tab:** Навигация внутри модального окна (зациклена)
- Фокус ловушка (focus trap) - фокус не выходит за пределы модального окна

### Screen Readers

#### Изображения и иконки
- Все изображения имеют `alt` текст
- Декоративные изображения: `alt=""`
- Иконки имеют `aria-label` или скрыты через `aria-hidden="true"`

#### Состояния компонентов
- Состояния объявляются screen reader'ом:
  - "Переключатель включен/выключен"
  - "Combobox открыт/закрыт"
  - "Выбрано X элементов"
  - "Обязательное поле"
  - "Ошибка валидации"

#### Навигация
- Breadcrumbs объявляются как навигационная цепочка
- Вкладки объявляются как группа вкладок
- Таблица объявляется с количеством строк и столбцов

---

## Валидация и обработка ошибок

### Валидация полей

#### Обязательные поля
Все обязательные поля помечены маркером "*" красного цвета.

**Список обязательных полей:**

1. **Страница создания агента:**
   - "Название" (*)

2. **Вкладка "Основные":**
   - "Название" (*)
   - "Инструкции для агента" (*)
   - "Выбрать каналы" (*) - если "Все каналы" unchecked
   - "Выбрать категории" (*) - если "Разрешить доступ ко всем категориям" unchecked

3. **Вкладка "Сделки и контакты":**
   - "Поле" (*) - в форме правила обновления
   - "Условие обновления" (*) - в форме правила обновления

4. **Вкладка "Дополнительно":**
   - "Выберите модель ИИ" (*)

#### Типы валидации

**Текстовые поля:**
- **Название агента:**
  - Обязательное
  - Минимум 1 символ
  - Максимум: определяется на бэкенде
  - Сообщение об ошибке: "Название обязательно для заполнения"

- **Инструкции для агента:**
  - Обязательное
  - Минимум 1 символ
  - Сообщение об ошибке: "Инструкции обязательны для заполнения"

- **Условие обновления:**
  - Обязательное (в форме правила)
  - Минимум 1 символ
  - Сообщение об ошибке: "Условие обновления обязательно для заполнения"

**Выбор из списка:**
- **Выбрать каналы:**
  - Обязательное (если "Все каналы" unchecked)
  - Минимум 1 выбранный канал
  - Сообщение об ошибке: "Необходимо выбрать хотя бы один канал"

- **Выбрать категории:**
  - Обязательное (если "Разрешить доступ ко всем категориям" unchecked)
  - Минимум 1 выбранная категория
  - Сообщение об ошибке: "Необходимо выбрать хотя бы одну категорию"

- **Поле (в правиле):**
  - Обязательное
  - Сообщение об ошибке: "Необходимо выбрать поле"

- **Выберите модель ИИ:**
  - Обязательное
  - Сообщение об ошибке: "Необходимо выбрать модель ИИ"

**Числовые поля:**
- **Задержка ответа:**
  - Необязательное
  - Минимум: 0
  - Максимум: определяется на бэкенде
  - По умолчанию: 5
  - Сообщение об ошибке: "Значение должно быть положительным числом"

### Сообщения об ошибках

#### Отображение ошибок
- **Расположение:** Под полем с ошибкой
- **Стиль:** Красный цвет текста
- **Иконка:** Иконка ошибки (опционально)
- **Формат:** "Поле обязательно для заполнения" или конкретное сообщение

#### Валидация формы
- Проверка всех обязательных полей при нажатии "Сохранить"
- Если есть ошибки:
  - Отображение всех ошибок одновременно
  - Прокрутка к первой ошибке
  - Фокус на первое поле с ошибкой
  - Блокировка отправки формы

### Обработка ошибок API

#### Ошибки синхронизации CRM
- **Тип:** Toast notification (временное уведомление)
- **Расположение:** Верхний правый угол экрана
- **Содержание:** "Ошибка синхронизации с CRM. Попробуйте еще раз."
- **Действия:** Кнопка "Повторить" (опционально)
- **Длительность:** 5 секунд или до закрытия пользователем

#### Ошибки сохранения
- **Тип:** Отображение в форме
- **Расположение:** Под соответствующими полями
- **Содержание:** Конкретное сообщение об ошибке от API
- **Примеры:**
  - "Название агента уже существует"
  - "Недостаточно прав для сохранения"
  - "Ошибка подключения к серверу"

#### Ошибки удаления
- **Тип:** Модальное окно с ошибкой
- **Расположение:** Центр экрана
- **Содержание:** Сообщение об ошибке
- **Действия:** Кнопка "Закрыть"

---

## Схема данных

### Модель агента

```typescript
interface Agent {
  id: number;
  name: string; // Обязательное
  active: boolean;
  instructions: string; // Обязательное
  checkBeforeSend: boolean;
  
  // Настройки воронок
  funnels: FunnelConfig[];
  
  // Настройки каналов
  channels: ChannelConfig;
  
  // Настройки базы знаний
  knowledgeBase: KnowledgeBaseConfig;
  
  // Настройки доступа к данным
  dataAccess: DataAccessConfig;
  
  // Настройки ввода данных
  dataInput: DataInputConfig;
  
  // Расширенные настройки
  advanced: AdvancedSettings;
  
  // Метаданные
  modelId: number; // ID модели ИИ
  createdAt: Date;
  updatedAt: Date;
}
```

### Модель конфигурации воронок

```typescript
interface FunnelConfig {
  funnelId: number; // ID воронки из CRM
  funnelName: string; // Название воронки
  active: boolean; // Работает ли агент в этой воронке
  stages: StageConfig[]; // Этапы воронки (опционально, если нужно детальное управление)
}

interface StageConfig {
  stageId: number; // ID этапа из CRM
  stageName: string; // Название этапа
  active: boolean; // Работает ли агент на этом этапе
}
```

### Модель конфигурации каналов

```typescript
interface ChannelConfig {
  allChannels: boolean; // Работает ли агент во всех каналах
  selectedChannels: number[]; // ID выбранных каналов (если allChannels = false)
}
```

### Модель конфигурации базы знаний

```typescript
interface KnowledgeBaseConfig {
  allCategories: boolean; // Доступ ко всем категориям
  selectedCategories: number[]; // ID выбранных категорий (если allCategories = false)
  createTaskIfNotFound: boolean; // Создавать задачу, если ответ не найден
  notFoundMessage: string; // Сообщение при отсутствии ответа
}
```

### Модель конфигурации доступа к данным

```typescript
interface DataAccessConfig {
  dealFields: number[]; // ID полей сделки, к которым агент имеет доступ
  contactFields: number[]; // ID полей контакта, к которым агент имеет доступ
}
```

### Модель конфигурации ввода данных

```typescript
interface DataInputConfig {
  dealRules: FieldUpdateRule[]; // Правила обновления полей сделки
  contactRules: FieldUpdateRule[]; // Правила обновления полей контакта
}

interface FieldUpdateRule {
  id: number; // ID правила (для существующих)
  fieldId: number; // ID поля из CRM
  fieldName: string; // Название поля (для отображения)
  overwriteExisting: boolean; // Перезаписывать существующее значение
  condition: string; // Условие обновления (текстовое описание)
  order: number; // Порядок правила
}
```

### Модель расширенных настроек

```typescript
interface AdvancedSettings {
  modelId: number; // ID модели ИИ (обязательное)
  autoDetectLanguage: boolean; // Автоматически определять язык
  creativity: 'precise' | 'balanced' | 'creative'; // Креативность
  responseDelay: number; // Задержка ответа в секундах (по умолчанию 5)
}
```

### Модель данных из CRM

```typescript
interface CRMData {
  // Воронки
  funnels: CRMFunnel[];
  
  // Каналы
  channels: CRMChannel[];
  
  // Поля сделок
  dealFields: CRMField[];
  
  // Поля контактов
  contactFields: CRMField[];
}

interface CRMFunnel {
  id: number;
  name: string;
  stages: CRMStage[];
}

interface CRMStage {
  id: number;
  name: string;
  pipelineId: number;
}

interface CRMChannel {
  id: number;
  name: string; // Например: "Instagram (World Wide Services)"
  type: string; // Тип канала
}

interface CRMField {
  id: number; // Или string для пользовательских полей
  name: string; // Название поля
  type: string; // Тип поля (text, number, date, etc.)
  isCustom: boolean; // Пользовательское поле
}
```

---

## Информация для дизайнера

### Компоненты UI
1. **Таблица:** Строки с данными, заголовки столбцов, действия
2. **Переключатели (Switch):** Включение/выключение функций
3. **Combobox:** Множественный выбор с тегами
4. **Tree Selector:** Иерархический выбор категорий
5. **Модальные окна:** Подтверждение действий (копирование, удаление)
6. **Вкладки (Tabs):** Навигация между разделами редактирования
7. **Формы:** Поля ввода, валидация, кнопки действий
8. **Dropdown'ы:** Выпадающие списки для фильтрации и выбора

### Responsive design
- **Desktop:** Полная функциональность, все элементы видимы
- **Mobile:** Адаптивная верстка (требуется дополнительное тестирование)

### Accessibility
- **ARIA labels:** Для всех интерактивных элементов
- **Keyboard navigation:** Поддержка навигации с клавиатуры
- **Screen readers:** Поддержка чтения с экрана

---

## Layout и Spacing

### Общая структура страницы
- **Максимальная ширина контента:** 1200px (центрирован)
- **Отступы от краев:** 24px (desktop), 16px (tablet), 12px (mobile)
- **Отступ между Header и Main Content:** 24px
- **Отступ между Sidebar и Main Content:** 24px

### Разделение секций
- **Отступ между секциями:** 32px (вертикальный)
- **Визуальное разделение секций:**
  - Каждая секция в отдельной карточке (card)
  - Фон карточки: белый (#FFFFFF)
  - Тень: `box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1)`
  - Скругление углов: `border-radius: 8px`
  - Внутренние отступы карточки: `padding: 24px`
  - Граница: `border: 1px solid #E5E7EB` (опционально)

### Отступы внутри секций
- **Отступ между заголовком секции и содержимым:** 16px
- **Отступ между полями формы:** 20px (вертикальный)
- **Отступ между label и input:** 8px
- **Отступ между input и description:** 4px
- **Отступ между description и следующим полем:** 16px

### Отступы для подсекций
- **Отступ подсекции от родительской секции:** 24px
- **Визуальное разделение подсекций:**
  - Левая граница: `border-left: 2px solid #E5E7EB` (опционально)
  - Отступ слева: `padding-left: 16px` (если есть граница)

---

## Компонентная карта страницы

### Полный список компонентов на странице "Агенты ИИ"

#### Страница списка агентов (`/ai-agents`)
1. **Breadcrumbs** - навигационная цепочка
2. **Heading (h1)** - "Агенты ИИ"
3. **Link (Button)** - "Создать"
4. **Searchbox** - поле поиска
5. **Button** - "Переключить столбцы"
6. **Popover/Dropdown** - меню переключения столбцов
7. **Checkbox** - в dropdown (2 шт: "Created at", "Updated at")
8. **Table** - таблица агентов
   - **Table Header** - заголовки столбцов
   - **Table Row** - строки данных (динамические)
   - **Checkbox** - в каждой строке
   - **Link** - название агента
   - **Switch** - переключатель "Активно"
   - **Link** - модель ИИ
   - **Link** - "Изменить"
   - **Button** - "Копировать"
   - **Button** - "Удалить"
9. **Modal/Dialog** - подтверждение копирования
10. **Modal/Dialog** - подтверждение удаления
11. **Pagination** - пагинация
    - **Combobox** - "на страницу"
    - **Button** - "Предыдущая страница"
    - **Button** - "Следующая страница"

#### Страница создания агента (`/ai-agents/create`)
1. **Breadcrumbs** - навигационная цепочка
2. **Heading (h1)** - "Создать Агент ИИ"
3. **Form** - форма создания
   - **Textbox** - "Название" (required)
4. **Button Group** - действия формы
   - **Button (Primary)** - "Сохранить"
   - **Button (Secondary)** - "Отмена"

#### Страница редактирования (`/ai-agents/{id}/edit`)
1. **Breadcrumbs** - навигационная цепочка
2. **Heading (h1)** - "Редактирование {Название}"
3. **Button (Danger)** - "Удалить"
4. **Tabs** - вкладки (6 шт: "Основные", "Сделки и контакты", "Триггеры", "Цепочки", "Интеграции", "Дополнительно")
5. **Card/Section** - секция "Профиль агента"
   - **Icon** - иконка секции
   - **Heading (h3)** - "Профиль агента"
   - **Textbox** - "Название"
   - **Switch** - "Активно"
   - **Textarea** - "Инструкции для агента"
   - **Paragraph** - описание
6. **Card/Section** - секция "Взаимодействие"
   - **Icon** - иконка секции
   - **Heading (h3)** - "Взаимодействие"
   - **Switch** - "Проверять перед отправкой"
   - **Paragraph** - описание
7. **Card/Section** - секция "Настройки воронок"
   - **Icon** - иконка секции
   - **Heading (h3)** - "Настройки воронок"
   - **Paragraph** - описание
   - **Button** - "Синхронизировать настройки CRM"
   - **Accordion/Expandable** - список воронок (динамический)
     - **Heading (h3)** - название воронки
     - **Button** - раскрытие этапов
     - **Switch** - "Активно"
8. **Card/Section** - секция "Каналы"
   - **Icon** - иконка секции
   - **Heading (h3)** - "Каналы"
   - **Paragraph** - описание
   - **Button** - "Синхронизировать настройки CRM"
   - **Switch** - "Все каналы"
   - **Combobox** - "Выбрать каналы" (условный, появляется при unchecked)
9. **Card/Section** - секция "База знаний"
   - **Icon** - иконка секции
   - **Heading (h3)** - "База знаний"
   - **Switch** - "Разрешить доступ ко всем категориям"
   - **Tree Selector** - "Выбрать категории" (условный, появляется при unchecked)
   - **Switch** - "Создать задачу, если ответ не найден"
   - **Textarea** - "Сообщение при отсутствии ответа"
   - **Link** - "Открыть базу знаний"
10. **Button Group** - действия формы
    - **Button (Primary)** - "Сохранить"
    - **Button (Secondary)** - "Отмена"

#### Вкладка "Сделки и контакты" (`/ai-agents/{id}/leads-contacts`)
1. **Tabs** - навигация по вкладкам
2. **Card/Section** - секция "Настройки доступа к данным"
   - **Icon** - иконка секции (Eye)
   - **Heading (h3)** - "Настройки доступа к данным"
   - **Paragraph** - описание
   - **Button** - "Синхронизировать настройки CRM"
   - **Subsection "Данные сделки"**
     - **Icon** - иконка подсекции (Briefcase)
     - **Heading (h4)** - "Данные сделки"
     - **Paragraph** - описание
     - **Button** - раскрытие/сворачивание
     - **Combobox** - "Выберите поля сделки" (multiple selection)
   - **Subsection "Данные контакта"**
     - **Icon** - иконка подсекции (User)
     - **Heading (h4)** - "Данные контакта"
     - **Paragraph** - описание
     - **Button** - раскрытие/сворачивание
     - **Combobox** - "Выберите поля контакта" (multiple selection)
3. **Card/Section** - секция "Настройки ввода данных"
   - **Icon** - иконка секции (Edit/Input)
   - **Heading (h3)** - "Настройки ввода данных"
   - **Paragraph** - описание
   - **Subsection "Данные сделки"**
     - **Icon** - иконка подсекции (Briefcase)
     - **Heading (h4)** - "Данные сделки"
     - **Paragraph** - описание
     - **Button** - раскрытие/сворачивание
     - **Button** - "Добавить поле"
     - **Rule Form** - форма правила (динамическая, добавляется по кнопке)
       - **Button** - перемещение правила (up/down)
       - **Button** - удаление правила
       - **Button** - сворачивание правила
       - **Combobox** - "Поле" (required)
       - **Switch** - "Перезаписать существующее значение"
       - **Textbox** - "Условие обновления" (required)
   - **Subsection "Данные контакта"**
     - Аналогичная структура
4. **Button Group** - действия формы
   - **Button (Primary)** - "Сохранить"
   - **Button (Secondary)** - "Отмена"

#### Вкладка "Триггеры" (`/ai-agents/{id}/triggers`)
1. **Tabs** - навигация по вкладкам
2. **Heading (h3)** - "Триггеры"
3. **Paragraph** - описание
4. **Button (Primary)** - "Создать"
5. **Searchbox** - поле поиска
6. **Button** - "Переключить столбцы"
7. **Empty State** - пустое состояние
   - **Icon** - иллюстрация
   - **Heading (h4)** - "Не найдено Триггеры"
   - **Paragraph** - описание
   - **Button (Primary)** - "Создать"

#### Вкладка "Цепочки" (`/ai-agents/{id}/sequences`)
1. **Tabs** - навигация по вкладкам
2. **Heading (h3)** - "Цепочки"
3. **Paragraph** - описание
4. **Button (Primary)** - "Создать"
5. **Searchbox** - поле поиска
6. **Button** - "Переключить столбцы"
7. **Empty State** - пустое состояние
   - **Icon** - иллюстрация
   - **Heading (h4)** - "Не найдено Цепочки"
   - **Paragraph** - описание
   - **Button (Primary)** - "Создать"

#### Вкладка "Интеграции" (`/ai-agents/{id}/available-integrations`)
1. **Tabs** - навигация по вкладкам
2. **Searchbox** - поле поиска интеграций
3. **Table** - таблица интеграций
   - **Table Header** - заголовки: "Интеграция", "Установлено", "Активно", "Actions"
   - **Table Row** - строки данных
     - **Link** - название интеграции
     - **Icon** - иконка установлено/не установлено
     - **Icon** - иконка активно/не активно
     - **Button** - "Настройки"

#### Вкладка "Дополнительно" (`/ai-agents/{id}/advanced-settings`)
1. **Tabs** - навигация по вкладкам
2. **Card/Section** - секция "Модель ИИ"
   - **Heading (h3)** - "Модель ИИ"
   - **Combobox** - "Выберите модель ИИ" (required)
   - **Paragraph** - описание
3. **Card/Section** - секция "Язык"
   - **Heading (h3)** - "Язык"
   - **Switch** - "Автоматически определять язык пользователя"
4. **Card/Section** - секция "Настройки ответа"
   - **Heading (h3)** - "Настройки ответа"
   - **Radio Group** - "Креативность" (3 опции: "Точный", "Сбалансированный", "Креативный")
   - **Spinbutton** - "Задержка ответа (секунд)"
   - **Paragraph** - описание
5. **Button Group** - действия формы
   - **Button (Primary)** - "Сохранить"
   - **Button (Secondary)** - "Отмена"

---

## Визуальное разделение секций

### Структура секции
Каждая секция представляет собой отдельную карточку (card) со следующими характеристиками:

#### Визуальные параметры карточки секции
- **Фон:** #FFFFFF (белый)
- **Тень:** 
  - `box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1)`
  - `box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05)` (при hover)
- **Граница:** 
  - `border: 1px solid #E5E7EB` (светло-серый)
  - `border-radius: 8px`
- **Внутренние отступы:** 
  - `padding: 24px` (desktop)
  - `padding: 20px` (tablet)
  - `padding: 16px` (mobile)
- **Отступ снизу:** `margin-bottom: 32px`

#### Заголовок секции
- **Структура:**
  - Иконка секции (слева)
  - Заголовок (h3) - жирный, размер: 18px
  - Описание (paragraph) - обычный, размер: 14px, цвет: #6B7280
- **Отступы:**
  - `margin-bottom: 16px` (между заголовком и содержимым)
  - `gap: 12px` (между иконкой и текстом)

#### Кнопка синхронизации CRM
- **Расположение:** Справа от заголовка секции
- **Выравнивание:** По правому краю
- **Отступ:** `margin-left: auto`

#### Подсекции
- **Визуальное разделение:**
  - Отступ сверху: `margin-top: 24px`
  - Левая граница (опционально): `border-left: 2px solid #E5E7EB`
  - Отступ слева: `padding-left: 16px` (если есть граница)
- **Кнопка раскрытия/сворачивания:**
  - Расположение: Справа от заголовка подсекции
  - Иконка: Chevron (стрелка вверх/вниз)

---

## Цветовая палитра

### Основные цвета
- **Фон страницы:** #F9FAFB (светло-серый)
- **Фон карточек:** #FFFFFF (белый)
- **Фон overlay:** rgba(0, 0, 0, 0.5) (50% прозрачности черного)

### Цвета текста
- **Основной текст:** #111827 (темно-серый, почти черный)
- **Вторичный текст:** #6B7280 (серый)
- **Текст описаний:** #9CA3AF (светло-серый)
- **Текст ошибок:** #DC2626 (красный)
- **Текст успеха:** #10B981 (зеленый)

### Цвета границ
- **Основная граница:** #E5E7EB (светло-серый)
- **Граница при фокусе:** #3B82F6 (синий)
- **Граница ошибки:** #DC2626 (красный)

### Цвета кнопок
- **Primary (Сохранить):**
  - Фон: #3B82F6 (синий)
  - Текст: #FFFFFF (белый)
  - Hover: #2563EB (темно-синий)
  - Disabled: #9CA3AF (серый)
- **Secondary (Отмена):**
  - Фон: прозрачный
  - Текст: #6B7280 (серый)
  - Граница: #E5E7EB (светло-серый)
  - Hover: #F3F4F6 (светло-серый фон)
- **Danger (Удалить):**
  - Фон: #DC2626 (красный)
  - Текст: #FFFFFF (белый)
  - Hover: #B91C1C (темно-красный)

### Цвета переключателей (Switch)
- **Checked:**
  - Фон: #10B981 (зеленый) или #3B82F6 (синий)
  - Тумблер: #FFFFFF (белый)
- **Unchecked:**
  - Фон: #D1D5DB (серый)
  - Тумблер: #FFFFFF (белый)

### Цвета тегов (Tags)
- **Фон тега:** #DBEAFE (светло-синий)
- **Текст тега:** #1E40AF (темно-синий)
- **Иконка удаления:** #6B7280 (серый)
- **Hover иконки удаления:** #DC2626 (красный)

### Цвета вкладок (Tabs)
- **Активная вкладка:**
  - Текст: #3B82F6 (синий)
  - Подчеркивание: #3B82F6 (синий, 2px)
- **Неактивная вкладка:**
  - Текст: #6B7280 (серый)
  - Hover: #111827 (темно-серый)

### Цвета состояний
- **Success:** #10B981 (зеленый)
- **Error:** #DC2626 (красный)
- **Warning:** #F59E0B (оранжевый)
- **Info:** #3B82F6 (синий)

---

## Типографика

### Шрифт
- **Семейство:** System font stack или кастомный шрифт
- **Базовый размер:** 16px
- **Line height:** 1.5 (24px)

### Заголовки
- **H1 (Заголовок страницы):**
  - Размер: 32px
  - Вес: 700 (bold)
  - Line height: 1.2
  - Цвет: #111827
  - Margin-bottom: 24px

- **H3 (Заголовок секции):**
  - Размер: 18px
  - Вес: 600 (semi-bold)
  - Line height: 1.3
  - Цвет: #111827
  - Margin-bottom: 16px

- **H4 (Заголовок подсекции):**
  - Размер: 16px
  - Вес: 600 (semi-bold)
  - Line height: 1.4
  - Цвет: #111827
  - Margin-bottom: 12px

### Текст
- **Основной текст:**
  - Размер: 16px
  - Вес: 400 (regular)
  - Line height: 1.5
  - Цвет: #111827

- **Вторичный текст (описания):**
  - Размер: 14px
  - Вес: 400 (regular)
  - Line height: 1.5
  - Цвет: #6B7280

- **Мелкий текст (подсказки):**
  - Размер: 12px
  - Вес: 400 (regular)
  - Line height: 1.4
  - Цвет: #9CA3AF

### Labels (Метки полей)
- **Размер:** 14px
- **Вес:** 500 (medium)
- **Цвет:** #111827
- **Margin-bottom:** 8px

### Placeholder
- **Размер:** 16px
- **Цвет:** #9CA3AF

### Обязательный маркер (*)
- **Размер:** 14px
- **Цвет:** #DC2626 (красный)
- **Расположение:** Справа от label или как superscript

---

## Иконки и их расположение

### Размеры иконок
- **Иконки секций:** 20px × 20px
- **Иконки в кнопках:** 16px × 16px
- **Иконки в таблице:** 16px × 16px
- **Иконки в dropdown:** 12px × 12px
- **Иконки в тегах:** 12px × 12px

### Иконки по секциям

#### Секция "Профиль агента"
- **Иконка секции:** User/Profile icon (20px)

#### Секция "Взаимодействие"
- **Иконка секции:** Message/Chat icon (20px)

#### Секция "Настройки воронок"
- **Иконка секции:** Funnel/Pipeline icon (20px)
- **Иконка раскрытия этапов:** Chevron Down/Up (16px)

#### Секция "Каналы"
- **Иконка секции:** Channel/Connection icon (20px)
- **Иконка синхронизации:** Refresh/Reload icon (16px)

#### Секция "База знаний"
- **Иконка секции:** Book/Knowledge icon (20px)

#### Секция "Настройки доступа к данным"
- **Иконка секции:** Eye icon (20px)
- **Иконка подсекции "Данные сделки":** Briefcase icon (16px)
- **Иконка подсекции "Данные контакта":** User icon (16px)
- **Иконка раскрытия:** Chevron Down/Up (16px)

#### Секция "Настройки ввода данных"
- **Иконка секции:** Edit/Input icon (20px)
- **Иконка подсекции "Данные сделки":** Briefcase icon (16px)
- **Иконка подсекции "Данные контакта":** User icon (16px)
- **Иконка раскрытия:** Chevron Down/Up (16px)

#### Общие иконки
- **Удаление тега:** X icon (12px)
- **Dropdown arrow:** Chevron Down (12px)
- **Кнопка закрытия модального окна:** X icon (20px)
- **Кнопка действий в таблице:** Menu/Dots icon (16px)

---

## Grid система и Layout

### Общая структура
- **Container:** max-width: 1200px, margin: 0 auto
- **Grid columns:** 12 колонок (desktop)
- **Gap между колонками:** 24px

### Расположение элементов

#### Header
- **Высота:** 64px (fixed)
- **Padding:** 16px 24px
- **Grid:** Flexbox или Grid для выравнивания элементов

#### Sidebar
- **Ширина:** 256px (desktop, expanded)
- **Ширина:** 64px (collapsed)
- **Position:** fixed, left: 0
- **Height:** 100vh

#### Main Content
- **Margin-left:** 256px (когда sidebar expanded)
- **Margin-left:** 64px (когда sidebar collapsed)
- **Padding:** 24px
- **Max-width:** 1200px

#### Секции формы
- **Ширина:** 100% (desktop)
- **Max-width:** 800px (для форм редактирования)
- **Расположение:** Вертикальный стек (flex-direction: column)
- **Gap:** 32px между секциями

#### Кнопки действий формы
- **Расположение:** Flexbox, justify-content: flex-end
- **Gap:** 12px между кнопками
- **Position:** sticky или fixed внизу страницы
- **Padding:** 16px 24px
- **Фон:** белый с тенью сверху

---

## Анимации и переходы

### Длительности
- **Быстрые переходы:** 150ms (hover эффекты)
- **Стандартные переходы:** 200ms (открытие/закрытие dropdown)
- **Медленные переходы:** 300ms (модальные окна)

### Easing функции
- **Стандартный:** ease-in-out
- **Bounce:** cubic-bezier(0.68, -0.55, 0.265, 1.55) (для модальных окон)
- **Smooth:** cubic-bezier(0.4, 0, 0.2, 1)

### Анимации компонентов

#### Dropdown/Popover
- **Открытие:** 
  - opacity: 0 → 1 (200ms)
  - transform: translateY(-8px) → translateY(0)
  - easing: ease-out
- **Закрытие:**
  - opacity: 1 → 0 (150ms)
  - transform: translateY(0) → translateY(-8px)
  - easing: ease-in

#### Модальное окно
- **Открытие:**
  - overlay: opacity 0 → 0.5 (200ms)
  - dialog: scale(0.95) → scale(1) (300ms)
  - easing: cubic-bezier(0.68, -0.55, 0.265, 1.55)
- **Закрытие:**
  - overlay: opacity 0.5 → 0 (150ms)
  - dialog: scale(1) → scale(0.95) (200ms)
  - easing: ease-in

#### Switch
- **Переключение:** 200ms
- **Easing:** ease-in-out

#### Раскрытие/сворачивание секций
- **Длительность:** 300ms
- **Easing:** ease-in-out
- **Свойства:** max-height, opacity

---

## Пустые состояния и Edge Cases

### Пустое состояние таблицы агентов
- **Когда:** Нет агентов в системе
- **Отображение:**
  - Иконка: пустое состояние (иллюстрация)
  - Заголовок: "Не найдено Агенты ИИ" (h4)
  - Описание: "Создать Агент для старта."
  - Кнопка: "Создать" (primary)

### Пустое состояние триггеров/цепочек
- **Когда:** Нет созданных триггеров/цепочек
- **Отображение:**
  - Иконка: пустое состояние
  - Заголовок: "Не найдено Триггеры/Цепочки" (h4)
  - Описание: "Создать Триггер/Цепочка для старта."
  - Кнопка: "Создать" (primary)

### Состояние загрузки
- **Индикатор загрузки:**
  - Тип: Spinner или Skeleton loader
  - Расположение: Центр области контента
  - Размер: 40px × 40px (spinner)
  - Цвет: #3B82F6 (синий)

### Ошибка загрузки данных
- **Отображение:**
  - Иконка: Alert/Error icon
  - Заголовок: "Ошибка загрузки данных"
  - Описание: Конкретное сообщение об ошибке
  - Кнопка: "Повторить" (primary)

### Ошибка синхронизации CRM
- **Тип:** Toast notification
- **Расположение:** Верхний правый угол
- **Содержание:** "Ошибка синхронизации с CRM. Проверьте подключение."
- **Действие:** Кнопка "Повторить"

---

## Список всех компонентов для реализации

### Базовые компоненты (переиспользуемые)

1. **Button**
   - Варианты: Primary, Secondary, Danger, Ghost
   - Размеры: Small, Medium, Large
   - Состояния: Default, Hover, Active, Disabled, Loading

2. **Input/Textbox**
   - Варианты: Text, Number, Email, Password
   - Состояния: Default, Focus, Error, Disabled
   - С поддержкой иконок (left/right)

3. **Textarea**
   - С автоизменением размера (опционально)
   - Счетчик символов (опционально)

4. **Switch**
   - Состояния: Checked, Unchecked, Disabled
   - С меткой (left/right)

5. **Combobox**
   - Одиночный выбор
   - Множественный выбор с тегами
   - С поиском/фильтрацией
   - С группировкой опций

6. **Tree Selector**
   - Иерархический выбор
   - Множественный выбор
   - С поиском

7. **Modal/Dialog**
   - С overlay
   - С заголовком и footer
   - Размеры: Small, Medium, Large, Fullscreen

8. **Tabs**
   - Горизонтальные
   - Вертикальные (для mobile)
   - С иконками

9. **Table**
   - С сортировкой
   - С пагинацией
   - С выбором строк
   - Responsive (карточки на mobile)

10. **Card/Section**
    - С заголовком
    - С иконкой
    - С описанием
    - С действиями (кнопки справа)

11. **Accordion/Expandable**
    - Раскрытие/сворачивание
    - С иконкой состояния

12. **Breadcrumbs**
    - С разделителями
    - С иконками

13. **Pagination**
    - С информацией о количестве
    - С dropdown "на страницу"
    - С кнопками навигации

14. **Toast/Notification**
    - Типы: Success, Error, Warning, Info
    - С кнопкой закрытия
    - Автоматическое закрытие

15. **Spinner/Loader**
    - Размеры: Small, Medium, Large
    - Варианты: Circular, Dots, Skeleton

16. **Tag/Badge**
    - С кнопкой удаления
    - Размеры: Small, Medium
    - Цветовые варианты

17. **Radio Group**
    - Горизонтальное расположение
    - Вертикальное расположение
    - С описаниями

18. **Spinbutton**
    - С кнопками увеличения/уменьшения
    - С валидацией min/max

19. **Searchbox**
    - С иконкой поиска
    - С кнопкой очистки
    - С автодополнением (опционально)

20. **Dropdown/Popover**
    - Позиционирование: Top, Bottom, Left, Right
    - С закрытием при клике вне
    - С поддержкой клавиатуры

---

---

## API спецификации (детальные)

### Базовый URL
- **Production:** `https://aai.widgets.wearekwid.com/api`
- **Development:** `http://localhost:3000/api`

### Аутентификация
- **Тип:** Bearer Token (JWT)
- **Header:** `Authorization: Bearer {token}`
- **Refresh Token:** Через `/api/auth/refresh`
- **Expiration:** Access token - 15 минут, Refresh token - 7 дней

### Формат запросов/ответов
- **Content-Type:** `application/json`
- **Accept:** `application/json`
- **Кодировка:** UTF-8

### Endpoints для страницы "Агенты ИИ"

#### 1. Получение списка агентов
```
GET /api/ai-agents
Query Parameters:
  - page: number (default: 1)
  - limit: number (default: 10, max: 100)
  - search: string (optional, поиск по названию)
  - sort: string (optional, "name" | "created_at" | "updated_at")
  - order: "asc" | "desc" (default: "desc")

Response 200:
{
  "data": [
    {
      "id": "string",
      "name": "string",
      "isActive": boolean,
      "model": "string",
      "createdAt": "ISO 8601",
      "updatedAt": "ISO 8601"
    }
  ],
  "pagination": {
    "page": number,
    "limit": number,
    "total": number,
    "totalPages": number
  }
}
```

#### 2. Создание агента
```
POST /api/ai-agents
Body:
{
  "name": "string" (required, min: 1, max: 255)
}

Response 201:
{
  "data": {
    "id": "string",
    "name": "string",
    "isActive": false,
    "createdAt": "ISO 8601",
    "updatedAt": "ISO 8601"
  }
}

Error 400:
{
  "error": "ValidationError",
  "message": "Название обязательно",
  "fields": {
    "name": ["Название обязательно"]
  }
}
```

#### 3. Получение агента
```
GET /api/ai-agents/{id}

Response 200:
{
  "data": {
    "id": "string",
    "name": "string",
    "isActive": boolean,
    "instructions": "string",
    "checkBeforeSending": boolean,
    "funnelConfigs": [...],
    "channelConfigs": [...],
    "knowledgeBaseConfig": {...},
    "dataAccessConfig": {...},
    "dataInputConfig": {...},
    "advancedSettings": {...},
    "createdAt": "ISO 8601",
    "updatedAt": "ISO 8601"
  }
}

Error 404:
{
  "error": "NotFoundError",
  "message": "Агент не найден"
}
```

#### 4. Обновление агента
```
PUT /api/ai-agents/{id}
Body: (все поля опциональны, отправляются только измененные)
{
  "name": "string",
  "isActive": boolean,
  "instructions": "string",
  "checkBeforeSending": boolean,
  "funnelConfigs": [...],
  "channelConfigs": [...],
  "knowledgeBaseConfig": {...},
  "dataAccessConfig": {...},
  "dataInputConfig": {...},
  "advancedSettings": {...}
}

Response 200:
{
  "data": {
    "id": "string",
    ... (обновленные данные)
  }
}
```

#### 5. Удаление агента
```
DELETE /api/ai-agents/{id}

Response 204: No Content

Error 404:
{
  "error": "NotFoundError",
  "message": "Агент не найден"
}
```

#### 6. Копирование агента
```
POST /api/ai-agents/{id}/copy
Body:
{
  "name": "string" (optional, default: "{original_name} (копия)
}

Response 201:
{
  "data": {
    "id": "string",
    "name": "string",
    ... (скопированные данные)
  }
}
```

#### 7. Синхронизация с CRM
```
POST /api/ai-agents/{id}/sync-crm
Body:
{
  "type": "funnels" | "channels" | "dealFields" | "contactFields" | "all"
}

Response 200:
{
  "data": {
    "funnels": [...],
    "channels": [...],
    "dealFields": [...],
    "contactFields": [...]
  }
}

Error 503:
{
  "error": "ServiceUnavailable",
  "message": "CRM недоступен. Проверьте подключение."
}
```

### Коды ошибок
- **200** - Успешный запрос
- **201** - Ресурс создан
- **204** - Успешное удаление (нет контента)
- **400** - Ошибка валидации
- **401** - Не авторизован
- **403** - Доступ запрещен
- **404** - Ресурс не найден
- **409** - Конфликт (например, дубликат)
- **422** - Ошибка обработки данных
- **429** - Слишком много запросов (Rate Limit)
- **500** - Внутренняя ошибка сервера
- **503** - Сервис недоступен

### Rate Limiting
- **Общие запросы:** 100 запросов в минуту на IP
- **Синхронизация CRM:** 10 запросов в минуту на пользователя
- **Создание/обновление:** 30 запросов в минуту на пользователя
- **Headers ответа:**
  - `X-RateLimit-Limit`: лимит запросов
  - `X-RateLimit-Remaining`: оставшиеся запросы
  - `X-RateLimit-Reset`: время сброса лимита (Unix timestamp)

---

## Детальные состояния загрузки

### Skeleton Loaders

#### Таблица агентов
- **Структура:** 5-10 строк с skeleton элементами
- **Высота строки:** 56px
- **Анимация:** pulse (2s infinite)
- **Цвет:** #E5E7EB (светло-серый)
- **Расположение:** Заменяет таблицу во время загрузки

#### Форма редактирования агента
- **Секции:** Skeleton для каждой секции (card)
- **Поля:** Skeleton для каждого поля (высота: 40px для input, 80px для textarea)
- **Кнопки:** Skeleton для кнопок (высота: 40px, ширина: 120px)
- **Анимация:** pulse (2s infinite)

#### Dropdown/Combobox
- **Skeleton:** Прямоугольник с закругленными углами
- **Высота:** 40px
- **Ширина:** 100% контейнера
- **Анимация:** pulse

### Spinner'ы

#### Размеры
- **Small:** 16px × 16px (для кнопок)
- **Medium:** 24px × 24px (для форм)
- **Large:** 40px × 40px (для страниц)

#### Позиционирование
- **В кнопке:** Центр кнопки, заменяет текст
- **В форме:** Центр формы, overlay поверх контента
- **На странице:** Центр viewport

#### Цвета
- **Primary:** #3B82F6 (синий)
- **Secondary:** #6B7280 (серый)
- **Success:** #10B981 (зеленый)
- **Error:** #DC2626 (красный)

#### Анимация
- **Тип:** Rotating (360deg, 1s linear infinite)
- **Easing:** linear

### Прогресс-бары

#### Для синхронизации CRM
- **Тип:** Linear progress bar
- **Высота:** 4px
- **Цвет:** #3B82F6 (синий)
- **Фон:** #E5E7EB (светло-серый)
- **Анимация:** indeterminate (бесконечная анимация)
- **Расположение:** Под кнопкой "Синхронизировать настройки CRM"

#### Для сохранения формы
- **Тип:** Linear progress bar
- **Высота:** 2px
- **Цвет:** #3B82F6 (синий)
- **Расположение:** Верх формы (sticky)

### Оптимистичные обновления UI

#### Переключатель "Активно"
- **Действие:** Немедленное изменение состояния в UI
- **Отправка:** Асинхронный запрос на сервер
- **Откат:** При ошибке возврат к предыдущему состоянию + toast уведомление

#### Удаление тега из combobox
- **Действие:** Немедленное удаление из UI
- **Отправка:** При сохранении формы
- **Откат:** При ошибке валидации возврат тега

---

## Валидация форм (детальная)

### Правила валидации по полям

#### Поле "Название" (агента)
- **Обязательное:** Да
- **Минимальная длина:** 1 символ
- **Максимальная длина:** 255 символов
- **Паттерн:** Любые символы (включая пробелы, спецсимволы)
- **Валидация в реальном времени:** Нет (только при blur)
- **Сообщение об ошибке:**
  - Пустое: "Название обязательно"
  - Слишком длинное: "Название не должно превышать 255 символов"

#### Поле "Инструкции для агента"
- **Обязательное:** Да
- **Минимальная длина:** 10 символов
- **Максимальная длина:** 10000 символов
- **Валидация в реальном времени:** Нет (только при blur)
- **Сообщение об ошибке:**
  - Пустое: "Инструкции обязательны"
  - Слишком короткое: "Инструкции должны содержать минимум 10 символов"
  - Слишком длинное: "Инструкции не должны превышать 10000 символов"

#### Поле "Выбрать каналы" (combobox)
- **Обязательное:** Только если switch "Все каналы" = unchecked
- **Минимальное количество:** 1 канал
- **Валидация:** При submit формы
- **Сообщение об ошибке:** "Выберите хотя бы один канал"

#### Поле "Выбрать категории" (tree selector)
- **Обязательное:** Только если switch "Разрешить доступ ко всем категориям" = unchecked
- **Минимальное количество:** 1 категория
- **Валидация:** При submit формы
- **Сообщение об ошибке:** "Выберите хотя бы одну категорию"

#### Поле "Выберите поля сделки/контакта" (combobox)
- **Обязательное:** Нет
- **Максимальное количество:** Нет ограничений
- **Валидация:** Нет (опциональное поле)

#### Поле "Поле" (в правиле обновления данных)
- **Обязательное:** Да
- **Валидация:** При добавлении правила
- **Сообщение об ошибке:** "Выберите поле"

#### Поле "Условие обновления"
- **Обязательное:** Да
- **Минимальная длина:** 1 символ
- **Максимальная длина:** 500 символов
- **Валидация:** При добавлении правила
- **Сообщение об ошибке:** "Условие обновления обязательно"

#### Поле "Задержка ответа (секунд)"
- **Обязательное:** Нет (есть значение по умолчанию: 5)
- **Тип:** number
- **Минимальное значение:** 0
- **Максимальное значение:** 3600 (1 час)
- **Валидация в реальном времени:** Да (при изменении)
- **Сообщение об ошибке:**
  - Не число: "Введите число"
  - Меньше 0: "Задержка не может быть отрицательной"
  - Больше 3600: "Задержка не может превышать 3600 секунд"

### Кросс-полевая валидация

#### Зависимость: "Все каналы" и "Выбрать каналы"
- **Условие:** Если "Все каналы" = checked, поле "Выбрать каналы" не валидируется
- **Условие:** Если "Все каналы" = unchecked, поле "Выбрать каналы" обязательно

#### Зависимость: "Разрешить доступ ко всем категориям" и "Выбрать категории"
- **Условие:** Если "Разрешить доступ ко всем категориям" = checked, поле "Выбрать категории" не валидируется
- **Условие:** Если "Разрешить доступ ко всем категориям" = unchecked, поле "Выбрать категории" обязательно

### Валидация при submit
- **Проверка всех обязательных полей:** Да
- **Блокировка кнопки "Сохранить":** При наличии ошибок
- **Отображение ошибок:** Под каждым полем с ошибкой
- **Прокрутка к первой ошибке:** Да (smooth scroll)

### Валидация на сервере
- **Дублирование:** Проверка уникальности названия агента
- **Существование:** Проверка существования выбранных категорий, каналов, полей
- **Права доступа:** Проверка прав пользователя на редактирование агента

---

## Responsive Design (точные breakpoints)

### Breakpoints
- **Mobile:** 0px - 640px
- **Tablet:** 641px - 1024px
- **Desktop:** 1025px - 1440px
- **Large Desktop:** 1441px+

### Медиа-запросы (CSS)
```css
/* Mobile */
@media (max-width: 640px) { ... }

/* Tablet */
@media (min-width: 641px) and (max-width: 1024px) { ... }

/* Desktop */
@media (min-width: 1025px) { ... }

/* Large Desktop */
@media (min-width: 1441px) { ... }
```

### Адаптация компонентов

#### Header
- **Mobile:** 
  - Высота: 56px
  - Глобальный поиск: скрыт (иконка поиска вместо поля)
  - Уведомления: только иконка
  - Меню пользователя: только аватар
- **Tablet:** 
  - Высота: 64px
  - Глобальный поиск: сокращенное поле (200px)
- **Desktop:** 
  - Полная функциональность

#### Sidebar
- **Mobile:** 
  - Скрыт по умолчанию
  - Overlay при открытии
  - Ширина: 280px
  - Position: fixed, z-index: 50
- **Tablet:** 
  - Collapsed по умолчанию (64px)
  - Expandable при клике
- **Desktop:** 
  - Expanded по умолчанию (256px)

#### Таблица агентов
- **Mobile:** 
  - Преобразование в карточки (card layout)
  - Каждая строка = карточка
  - Вертикальное расположение данных
  - Действия: dropdown menu
- **Tablet:** 
  - Горизонтальная прокрутка таблицы
  - Скрытие некоторых столбцов
- **Desktop:** 
  - Полная таблица

#### Форма редактирования
- **Mobile:** 
  - Padding: 16px
  - Секции: без карточек (только разделители)
  - Кнопки: full-width, stack вертикально
- **Tablet:** 
  - Padding: 20px
  - Секции: карточки
  - Кнопки: inline (рядом)
- **Desktop:** 
  - Padding: 24px
  - Max-width: 800px (центрирован)

#### Tabs
- **Mobile:** 
  - Горизонтальная прокрутка
  - Иконки + текст (сокращенный)
- **Tablet:** 
  - Все вкладки видимы
  - Иконки + текст
- **Desktop:** 
  - Все вкладки видимы
  - Полный текст

#### Combobox/Tree Selector
- **Mobile:** 
  - Full-width
  - Dropdown: full-screen modal
- **Tablet:** 
  - Full-width
  - Dropdown: popover (позиционирование автоматическое)
- **Desktop:** 
  - Full-width
  - Dropdown: popover

#### Модальные окна
- **Mobile:** 
  - Full-screen
  - Padding: 16px
- **Tablet:** 
  - Max-width: 500px
  - Центрирован
- **Desktop:** 
  - Max-width: 600px
  - Центрирован

### Touch-friendly размеры
- **Минимальный размер кликабельной области:** 44px × 44px
- **Отступы между кнопками:** 12px (mobile), 8px (desktop)
- **Размер текста:** минимум 16px (для предотвращения zoom на iOS)

---

## Z-index слои

### Порядок наложения (от нижнего к верхнему)

1. **Base (0):** Основной контент страницы
2. **Sidebar (10):** Боковая панель (fixed)
3. **Header (20):** Верхняя панель (fixed)
4. **Dropdown/Popover (30):** Выпадающие списки
5. **Sticky elements (40):** Sticky кнопки действий формы
6. **Modal overlay (50):** Overlay модальных окон
7. **Modal (60):** Модальные окна
8. **Toast/Notification (70):** Уведомления
9. **Tooltip (80):** Подсказки
10. **Loading overlay (90):** Overlay загрузки (full-screen)

### Конкретные значения

```css
:root {
  --z-base: 0;
  --z-sidebar: 10;
  --z-header: 20;
  --z-dropdown: 30;
  --z-sticky: 40;
  --z-modal-overlay: 50;
  --z-modal: 60;
  --z-toast: 70;
  --z-tooltip: 80;
  --z-loading: 90;
}
```

---

## Focus states (детальные)

### Визуальные индикаторы фокуса

#### Input/Textbox
- **Outline:** 2px solid #3B82F6
- **Outline-offset:** 2px
- **Border:** 1px solid #3B82F6 (при фокусе)
- **Box-shadow:** 0 0 0 3px rgba(59, 130, 246, 0.1)

#### Textarea
- **Аналогично Input/Textbox**

#### Combobox
- **Аналогично Input/Textbox**
- **Dropdown:** Открывается при фокусе (опционально, настраивается)

#### Switch
- **Outline:** 2px solid #3B82F6
- **Outline-offset:** 2px
- **Box-shadow:** 0 0 0 3px rgba(59, 130, 246, 0.1)

#### Button
- **Outline:** 2px solid #3B82F6
- **Outline-offset:** 2px
- **Box-shadow:** 0 0 0 3px rgba(59, 130, 246, 0.1)

#### Link
- **Underline:** 2px solid #3B82F6
- **Text-decoration:** underline (при фокусе)

#### Radio/Checkbox
- **Outline:** 2px solid #3B82F6
- **Outline-offset:** 2px
- **Box-shadow:** 0 0 0 3px rgba(59, 130, 246, 0.1)

### Порядок табуляции

1. Header элементы (поиск, уведомления, меню)
2. Sidebar навигация
3. Breadcrumbs
4. Заголовок страницы
5. Кнопка "Создать"
6. Поле поиска
7. Кнопка "Переключить столбцы"
8. Таблица (если есть)
9. Форма (поля по порядку)
10. Кнопки действий формы

### Keyboard shortcuts

#### Глобальные
- **Ctrl/Cmd + K:** Открыть глобальный поиск
- **Ctrl/Cmd + /** : Открыть помощь
- **Esc:** Закрыть модальное окно/dropdown

#### В форме
- **Tab:** Следующее поле
- **Shift + Tab:** Предыдущее поле
- **Enter:** Submit формы (если валидна)
- **Esc:** Отмена/закрытие формы

---

## Hover/Active/Pressed states

### Кнопки

#### Primary Button
- **Hover:**
  - Фон: #2563EB (темно-синий)
  - Box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1)
  - Transform: translateY(-1px)
- **Active:**
  - Фон: #1D4ED8 (еще темнее)
  - Box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1)
  - Transform: translateY(0)
- **Transition:** 150ms ease-in-out

#### Secondary Button
- **Hover:**
  - Фон: #F3F4F6 (светло-серый)
  - Граница: #D1D5DB (темнее)
- **Active:**
  - Фон: #E5E7EB (серый)
- **Transition:** 150ms ease-in-out

#### Danger Button
- **Hover:**
  - Фон: #B91C1C (темно-красный)
  - Box-shadow: 0 4px 6px rgba(220, 38, 38, 0.2)
- **Active:**
  - Фон: #991B1B (еще темнее)
- **Transition:** 150ms ease-in-out

### Ссылки
- **Hover:**
  - Цвет: #2563EB (темно-синий)
  - Text-decoration: underline
- **Active:**
  - Цвет: #1D4ED8 (еще темнее)
- **Transition:** 150ms ease-in-out

### Карточки (Cards)
- **Hover:**
  - Box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05)
  - Transform: translateY(-2px)
- **Transition:** 200ms ease-in-out

### Строки таблицы
- **Hover:**
  - Фон: #F9FAFB (светло-серый)
- **Transition:** 150ms ease-in-out

### Теги (Tags)
- **Hover (иконка удаления):**
  - Цвет: #DC2626 (красный)
  - Background: rgba(220, 38, 38, 0.1)
- **Transition:** 150ms ease-in-out

### Switch
- **Hover (unchecked):**
  - Фон: #9CA3AF (светло-серый)
- **Hover (checked):**
  - Фон: #059669 (темно-зеленый) или #2563EB (темно-синий)
- **Transition:** 200ms ease-in-out

---

## Тени и эффекты (точные значения)

### Box-shadow

#### Карточки секций
- **Default:** `0 1px 3px rgba(0, 0, 0, 0.1)`
- **Hover:** `0 4px 6px rgba(0, 0, 0, 0.05)`

#### Модальные окна
- **Shadow:** `0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)`

#### Dropdown/Popover
- **Shadow:** `0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)`

#### Кнопки
- **Default (Primary):** `0 1px 2px rgba(0, 0, 0, 0.05)`
- **Hover (Primary):** `0 4px 6px rgba(0, 0, 0, 0.1)`
- **Active (Primary):** `0 2px 4px rgba(0, 0, 0, 0.1)`

#### Header
- **Shadow:** `0 1px 3px rgba(0, 0, 0, 0.1)`

#### Sticky кнопки действий формы
- **Shadow:** `0 -4px 6px -1px rgba(0, 0, 0, 0.1)`

### Backdrop blur
- **Modal overlay:** `backdrop-filter: blur(4px)`
- **Sidebar overlay (mobile):** `backdrop-filter: blur(8px)`

---

## Скругления (точные значения)

### Border-radius

#### Карточки секций
- **Значение:** `8px`

#### Модальные окна
- **Значение:** `12px`

#### Кнопки
- **Значение:** `6px`

#### Input/Textbox/Textarea
- **Значение:** `6px`

#### Combobox
- **Значение:** `6px`

#### Теги (Tags)
- **Значение:** `4px`

#### Dropdown/Popover
- **Значение:** `8px`

#### Switch
- **Значение:** `9999px` (полностью круглый)

#### Avatar
- **Значение:** `50%` (круглый)

---

## Шрифты

### Семейство шрифтов
- **Primary:** System font stack
- **Fallback:** `-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif`
- **Monospace (для кода):** `"SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace`

### Font-display
- **Стратегия:** `font-display: swap`
- **Причина:** Приоритет отображения текста над загрузкой шрифта

### Загрузка шрифтов
- **Метод:** System fonts (не требуется загрузка)
- **Если кастомные шрифты:** Preload критичных шрифтов, subset для русского языка

---

## Иконки (детальные требования)

### Библиотека
- **Рекомендуемая:** Lucide React (или Heroicons)
- **Формат:** SVG компоненты
- **Размеры:** 16px, 20px, 24px (основные)

### Иконки по контексту

#### Секции (20px)
- User/Profile
- Message/Chat
- Funnel/Pipeline
- Channel/Connection
- Book/Knowledge
- Eye
- Edit/Input

#### Кнопки (16px)
- Refresh/Reload
- Chevron Down/Up
- X (закрытие)
- Menu/Dots
- Search
- Plus (создание)

#### Теги (12px)
- X (удаление)

#### Dropdown (12px)
- Chevron Down

### Требования к иконкам
- **Цвет:** Наследуется от текста (currentColor)
- **Stroke width:** 2px (для line icons)
- **Accessibility:** `aria-hidden="true"` для декоративных иконок

---

## Интеграция с CRM (Kommo)

### OAuth 2.0 Flow

#### Шаг 1: Получение authorization code
```
GET https://www.kommo.com/oauth2/authorize
Query Parameters:
  - client_id: string (ваш client_id)
  - redirect_uri: string (ваш redirect_uri)
  - response_type: "code"
  - scope: string (запрашиваемые права)
```

#### Шаг 2: Обмен code на access token
```
POST https://www.kommo.com/oauth2/access_token
Body:
  - client_id: string
  - client_secret: string
  - grant_type: "authorization_code"
  - code: string (из шага 1)
  - redirect_uri: string
```

#### Шаг 3: Использование access token
```
Header: Authorization: Bearer {access_token}
```

### Kommo API Endpoints

#### Получение воронок (Pipelines)
```
GET https://{subdomain}.kommo.com/api/v4/leads/pipelines
Response:
{
  "_embedded": {
    "pipelines": [
      {
        "id": number,
        "name": "string",
        "sort": number,
        "is_main": boolean,
        "_embedded": {
          "statuses": [
            {
              "id": number,
              "name": "string",
              "sort": number,
              "color": "string"
            }
          ]
        }
      }
    ]
  }
}
```

#### Получение каналов
```
GET https://{subdomain}.kommo.com/api/v4/channels
Response:
{
  "_embedded": {
    "channels": [
      {
        "id": number,
        "name": "string",
        "type": "string",
        "account_id": number
      }
    ]
  }
}
```

#### Получение полей сделок
```
GET https://{subdomain}.kommo.com/api/v4/leads/custom_fields
Response:
{
  "_embedded": {
    "custom_fields": [
      {
        "id": number,
        "name": "string",
        "type": "string",
        "code": "string"
      }
    ]
  }
}
```

#### Получение полей контактов
```
GET https://{subdomain}.kommo.com/api/v4/contacts/custom_fields
Response: (аналогично полям сделок)
```

### Синхронизация

#### Стратегия
- **Ручная синхронизация:** По кнопке "Синхронизировать настройки CRM"
- **Автоматическая синхронизация:** Каждые 24 часа (опционально)
- **Webhooks:** Для реального времени (опционально)

#### Обработка ошибок
- **Недоступен CRM:** Toast уведомление + кнопка "Повторить"
- **Истек токен:** Автоматический refresh token
- **Нет прав:** Сообщение пользователю о необходимости обновить права

### Webhooks (опционально)

#### События для подписки
- Изменение воронки/этапа
- Изменение канала
- Изменение полей сделок/контактов

#### Endpoint для webhooks
```
POST /api/webhooks/kommo
Body:
{
  "event": "string",
  "data": {...}
}
```

---

## Бизнес-логика

### Правила работы системы

#### Агент активен/неактивен
- **Когда активен:** Агент обрабатывает сообщения в CRM
- **Когда неактивен:** Агент не обрабатывает сообщения
- **Изменение:** Немедленное (без перезапуска)

#### Настройки воронок
- **Логика:** Агент работает только в выбранных воронках и этапах
- **Если воронка неактивна:** Агент не обрабатывает сделки в этой воронке
- **Если этап неактивен:** Агент не обрабатывает сделки на этом этапе

#### Настройки каналов
- **"Все каналы" = checked:** Агент работает во всех каналах
- **"Все каналы" = unchecked:** Агент работает только в выбранных каналах

#### База знаний
- **"Разрешить доступ ко всем категориям" = checked:** Агент имеет доступ ко всем статьям
- **"Разрешить доступ ко всем категориям" = unchecked:** Агент имеет доступ только к выбранным категориям

#### Настройки доступа к данным
- **Логика:** Агент может читать только выбранные поля сделок/контактов
- **Оптимизация:** Меньше полей = меньше контекста = более точные ответы

#### Настройки ввода данных
- **Логика:** Агент может обновлять поля сделок/контактов по правилам
- **Правило:** Поле + Условие обновления + Перезаписать существующее значение
- **Порядок правил:** Важен (обрабатываются сверху вниз)

#### Проверка перед отправкой
- **Когда включено:** Агент отправляет ответ только после подтверждения пользователем
- **Когда выключено:** Агент отправляет ответ автоматически

#### Создание задачи, если ответ не найден
- **Когда включено:** Если агент не нашел ответ в базе знаний, создается задача для менеджера
- **Сообщение:** Используется "Сообщение при отсутствии ответа"

#### Модель ИИ
- **Влияние:** Выбор модели влияет на качество и скорость ответов
- **Рекомендации:** GPT-4 для точности, GPT-3.5 для скорости

#### Креативность
- **Точный:** Последовательные и предсказуемые ответы
- **Сбалансированный:** Естественные и легко читаемые ответы (рекомендуется)
- **Креативный:** Выразительные и разнообразные ответы

#### Задержка ответа
- **Логика:** Агент ждет указанное количество секунд перед отправкой ответа
- **Рекомендация:** Минимум 30 секунд для избежания дублирования

---

## Обработка ошибок (детальная)

### Типы ошибок

#### Ошибки валидации (400)
- **Отображение:** Под каждым полем с ошибкой
- **Формат:** Красный текст, иконка ошибки
- **Пример:** "Название обязательно"

#### Ошибки авторизации (401)
- **Действие:** Редирект на страницу входа
- **Toast:** "Сессия истекла. Пожалуйста, войдите снова."

#### Ошибки доступа (403)
- **Toast:** "У вас нет прав для выполнения этого действия."
- **Действие:** Редирект на предыдущую страницу

#### Ошибки "Не найдено" (404)
- **Toast:** "Ресурс не найден."
- **Действие:** Редирект на список агентов

#### Ошибки сервера (500)
- **Toast:** "Произошла ошибка сервера. Попробуйте позже."
- **Действие:** Кнопка "Повторить" в toast

#### Ошибки сети
- **Toast:** "Ошибка сети. Проверьте подключение к интернету."
- **Действие:** Кнопка "Повторить" в toast

#### Ошибки синхронизации CRM (503)
- **Toast:** "CRM недоступен. Проверьте подключение."
- **Действие:** Кнопка "Повторить" в секции синхронизации

### Retry логика

#### Автоматический retry
- **Количество попыток:** 3
- **Задержка:** Экспоненциальная (1s, 2s, 4s)
- **Типы ошибок:** Только сетевые ошибки и 500

#### Ручной retry
- **Кнопка "Повторить":** В toast уведомлениях
- **Кнопка "Повторить":** В секции синхронизации CRM

### Fallback UI

#### При ошибке загрузки списка агентов
- **Отображение:** Пустое состояние с сообщением об ошибке
- **Кнопка:** "Повторить"

#### При ошибке загрузки данных агента
- **Отображение:** Skeleton loader + сообщение об ошибке
- **Кнопка:** "Повторить"

#### При ошибке сохранения
- **Отображение:** Ошибки под полями + toast
- **Действие:** Форма остается открытой, данные не теряются

---

## Производительность

### Требования к времени загрузки
- **First Contentful Paint (FCP):** < 1.5s
- **Largest Contentful Paint (LCP):** < 2.5s
- **Time to Interactive (TTI):** < 3.5s
- **Cumulative Layout Shift (CLS):** < 0.1

### Оптимизации

#### Code Splitting
- **Стратегия:** Route-based code splitting
- **Динамические импорты:** Для тяжелых компонентов (графики, редакторы)

#### Lazy Loading
- **Компоненты:** Модальные окна, dropdown'ы (загружаются при открытии)
- **Изображения:** Lazy loading для всех изображений
- **Таблицы:** Virtual scrolling для больших списков (> 100 строк)

#### Кэширование
- **API запросы:** React Query с staleTime: 5 минут
- **Статические ресурсы:** Cache-Control: max-age=31536000
- **Service Worker:** Для офлайн-доступа (опционально)

#### Оптимизация изображений
- **Формат:** WebP с fallback на PNG/JPG
- **Размеры:** Responsive images (srcset)
- **Lazy loading:** Нативный lazy loading

#### Bundle Size
- **Целевой размер:** < 200KB (gzipped) для initial bundle
- **Tree shaking:** Удаление неиспользуемого кода
- **Минификация:** Production build с минификацией

---

## Безопасность

### CSRF защита
- **Метод:** CSRF токены в формах
- **Header:** `X-CSRF-Token` для AJAX запросов
- **Валидация:** На сервере для всех state-changing запросов

### XSS защита
- **Sanitization:** Все пользовательские данные санитизируются перед отображением
- **React:** Автоматическое экранирование в JSX
- **DangerouslySetInnerHTML:** Только для доверенного контента с санитизацией

### Валидация
- **Клиент:** Для UX (быстрая обратная связь)
- **Сервер:** Обязательна для всех данных (безопасность)
- **Типы данных:** Строгая валидация типов (Zod/Yup)

### Sanitization данных
- **Входные данные:** Санитизация всех строковых полей
- **SQL Injection:** Параметризованные запросы (Prisma ORM)
- **NoSQL Injection:** Валидация и санитизация для MongoDB (если используется)

### Rate Limiting
- **Реализация:** На уровне API (см. раздел API спецификации)
- **Защита от DDoS:** Cloudflare или аналогичный сервис

### Secrets Management
- **API ключи:** В environment variables
- **Токены:** В secure httpOnly cookies или localStorage с шифрованием
- **CRM credentials:** Шифрование в базе данных

---

## Тестирование

### Unit тесты

#### Что тестировать
- **Валидация форм:** Правила валидации для каждого поля
- **Бизнес-логика:** Условия и зависимости между полями
- **Утилиты:** Функции форматирования, преобразования данных
- **Компоненты:** Рендеринг, пропсы, состояния

#### Инструменты
- **Фреймворк:** Jest + React Testing Library
- **Покрытие:** Минимум 80% для критичных компонентов

### Integration тесты

#### Что тестировать
- **API endpoints:** Запросы/ответы, обработка ошибок
- **Интеграция с CRM:** Синхронизация данных
- **Формы:** Полный цикл submit с валидацией

#### Инструменты
- **Фреймворк:** Jest + Supertest (для API)

### E2E тесты

#### Критические сценарии
1. **Создание агента:** От открытия формы до сохранения
2. **Редактирование агента:** Изменение настроек и сохранение
3. **Синхронизация CRM:** Нажатие кнопки синхронизации и получение данных
4. **Валидация формы:** Проверка обязательных полей
5. **Удаление агента:** Подтверждение и удаление

#### Инструменты
- **Фреймворк:** Playwright или Cypress
- **Браузеры:** Chrome, Firefox, Safari

### Accessibility тесты

#### Что тестировать
- **ARIA атрибуты:** Наличие и корректность
- **Keyboard navigation:** Полная навигация с клавиатуры
- **Screen readers:** Совместимость с NVDA/JAWS
- **Цветовой контраст:** WCAG AA минимум

#### Инструменты
- **axe-core:** Автоматическое тестирование
- **WAVE:** Проверка доступности
- **Lighthouse:** Accessibility score

---

## Примеры кода

### TypeScript интерфейсы

```typescript
// Типы для агента
interface Agent {
  id: string;
  name: string;
  isActive: boolean;
  instructions: string;
  checkBeforeSending: boolean;
  funnelConfigs: FunnelConfig[];
  channelConfigs: ChannelConfig[];
  knowledgeBaseConfig: KnowledgeBaseConfig;
  dataAccessConfig: DataAccessConfig;
  dataInputConfig: DataInputConfig;
  advancedSettings: AdvancedSettings;
  createdAt: string;
  updatedAt: string;
}

interface FunnelConfig {
  funnelId: number;
  funnelName: string;
  isActive: boolean;
  stages: StageConfig[];
}

interface StageConfig {
  stageId: number;
  stageName: string;
  isActive: boolean;
}

interface ChannelConfig {
  allChannels: boolean;
  selectedChannels: number[];
}

interface KnowledgeBaseConfig {
  allCategories: boolean;
  selectedCategories: string[];
  createTaskIfNotFound: boolean;
  messageIfNotFound: string;
}

interface DataAccessConfig {
  dealFields: number[];
  contactFields: number[];
}

interface DataInputConfig {
  dealRules: FieldUpdateRule[];
  contactRules: FieldUpdateRule[];
}

interface FieldUpdateRule {
  fieldId: number;
  overwriteExisting: boolean;
  condition: string;
}

interface AdvancedSettings {
  model: string;
  autoDetectLanguage: boolean;
  creativity: "precise" | "balanced" | "creative";
  responseDelay: number;
}
```

### React компонент (пример)

```typescript
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const agentSchema = z.object({
  name: z.string().min(1, "Название обязательно").max(255, "Название не должно превышать 255 символов"),
  instructions: z.string().min(10, "Инструкции должны содержать минимум 10 символов").max(10000),
  isActive: z.boolean(),
});

type AgentFormData = z.infer<typeof agentSchema>;

export function AgentForm({ agentId }: { agentId?: string }) {
  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm<AgentFormData>({
    resolver: zodResolver(agentSchema),
    defaultValues: agentId ? async () => {
      const response = await fetch(`/api/ai-agents/${agentId}`);
      const { data } = await response.json();
      return data;
    } : undefined,
  });

  const onSubmit = async (data: AgentFormData) => {
    try {
      const url = agentId ? `/api/ai-agents/${agentId}` : '/api/ai-agents';
      const method = agentId ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Ошибка сохранения');
      }

      // Успех
      window.location.href = '/ai-agents';
    } catch (error) {
      // Обработка ошибки
      console.error(error);
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <div>
        <label htmlFor="name">
          Название <span aria-label="обязательное поле">*</span>
        </label>
        <input
          id="name"
          {...register('name')}
          aria-invalid={errors.name ? 'true' : 'false'}
          aria-describedby={errors.name ? 'name-error' : undefined}
        />
        {errors.name && (
          <span id="name-error" role="alert">
            {errors.name.message}
          </span>
        )}
      </div>

      <div>
        <label htmlFor="instructions">
          Инструкции для агента <span aria-label="обязательное поле">*</span>
        </label>
        <textarea
          id="instructions"
          {...register('instructions')}
          aria-invalid={errors.instructions ? 'true' : 'false'}
        />
        {errors.instructions && (
          <span id="instructions-error" role="alert">
            {errors.instructions.message}
          </span>
        )}
      </div>

      <button type="submit" disabled={isSubmitting}>
        {isSubmitting ? 'Сохранение...' : 'Сохранить'}
      </button>
    </form>
  );
}
```

---

## Логирование и мониторинг

### Что логировать

#### Уровни логов
- **Error:** Критические ошибки, требующие немедленного внимания
- **Warn:** Предупреждения, потенциальные проблемы
- **Info:** Информационные сообщения о важных событиях
- **Debug:** Детальная информация для отладки (только в development)

#### События для логирования

##### Пользовательские действия
- Создание агента
- Редактирование агента
- Удаление агента
- Копирование агента
- Изменение настроек агента
- Синхронизация с CRM
- Сохранение формы

##### Ошибки
- Ошибки валидации
- Ошибки API запросов
- Ошибки синхронизации CRM
- Ошибки сохранения данных
- Ошибки загрузки данных

##### Производительность
- Время загрузки страниц
- Время выполнения API запросов
- Время синхронизации CRM
- Размеры ответов API

##### Безопасность
- Попытки несанкционированного доступа
- Неудачные попытки авторизации
- Подозрительная активность

### Формат логов

#### Структура лога
```json
{
  "timestamp": "2025-01-26T10:30:00Z",
  "level": "error",
  "message": "Ошибка синхронизации CRM",
  "userId": "user-123",
  "agentId": "agent-456",
  "action": "sync-crm",
  "error": {
    "code": "CRM_UNAVAILABLE",
    "message": "CRM недоступен",
    "stack": "..."
  },
  "metadata": {
    "userAgent": "...",
    "ip": "192.168.1.1",
    "requestId": "req-789"
  }
}
```

### Мониторинг

#### Метрики производительности
- **Response Time:** Время ответа API (p50, p95, p99)
- **Error Rate:** Процент ошибок от общего количества запросов
- **Throughput:** Количество запросов в секунду
- **Database Query Time:** Время выполнения запросов к БД

#### Метрики бизнес-логики
- **Количество активных агентов**
- **Количество синхронизаций CRM в день**
- **Среднее время синхронизации CRM**
- **Количество созданных/обновленных агентов**

#### Алерты
- **Error Rate > 5%:** Критический алерт
- **Response Time > 2s:** Предупреждение
- **CRM недоступен > 5 минут:** Критический алерт
- **Database connection errors:** Критический алерт

### Инструменты
- **Логирование:** Winston, Pino, или встроенное логирование Next.js
- **Мониторинг:** Sentry для ошибок, Datadog/New Relic для метрик
- **Аналитика:** Mixpanel, Amplitude для пользовательских событий

---

## Доступность (расширенная)

### ARIA атрибуты для каждого компонента

#### Switch (Переключатель)
```html
<button
  role="switch"
  aria-checked="true"
  aria-labelledby="switch-label"
  aria-describedby="switch-description"
  tabindex="0"
>
```

#### Combobox
```html
<div
  role="combobox"
  aria-expanded="false"
  aria-haspopup="listbox"
  aria-required="true"
  aria-invalid="false"
  aria-describedby="combobox-description combobox-error"
>
  <input
    aria-autocomplete="list"
    aria-controls="listbox-id"
    aria-activedescendant="option-1"
  />
  <ul role="listbox" id="listbox-id">
    <li role="option" id="option-1" aria-selected="true">...</li>
  </ul>
</div>
```

#### Tree Selector
```html
<div role="tree" aria-label="Выбрать категории">
  <div
    role="treeitem"
    aria-expanded="true"
    aria-level="1"
    aria-setsize="5"
    aria-posinset="1"
    aria-selected="false"
  >
    <span>Категория</span>
    <ul role="group">
      <li role="treeitem" aria-level="2" aria-selected="true">...</li>
    </ul>
  </div>
</div>
```

#### Modal/Dialog
```html
<div
  role="dialog"
  aria-modal="true"
  aria-labelledby="dialog-title"
  aria-describedby="dialog-description"
>
  <h2 id="dialog-title">Удалить агента?</h2>
  <p id="dialog-description">Это действие нельзя отменить.</p>
</div>
```

#### Form
```html
<form role="form" aria-label="Форма редактирования агента">
  <label for="name">
    Название
    <span aria-label="обязательное поле">*</span>
  </label>
  <input
    id="name"
    aria-required="true"
    aria-invalid="false"
    aria-describedby="name-description name-error"
  />
  <span id="name-description">Введите название агента</span>
  <span id="name-error" role="alert" aria-live="polite">...</span>
</form>
```

### Screen Reader Announcements

#### Динамические обновления
- **Изменение состояния переключателя:** "Переключатель 'Активно' включен"
- **Выбор в combobox:** "Выбрано: Instagram, WhatsApp Business"
- **Ошибка валидации:** "Ошибка: Название обязательно"
- **Успешное сохранение:** "Агент успешно сохранен"
- **Синхронизация CRM:** "Синхронизация с CRM начата... Синхронизация завершена"

#### Использование aria-live
- **aria-live="polite":** Для не критичных обновлений (ошибки валидации, успешное сохранение)
- **aria-live="assertive":** Для критичных обновлений (ошибки синхронизации, критические ошибки)

### Keyboard Navigation (полная карта)

#### Глобальная навигация
- **Tab:** Переход к следующему элементу
- **Shift + Tab:** Переход к предыдущему элементу
- **Ctrl/Cmd + K:** Открыть глобальный поиск
- **Esc:** Закрыть модальное окно/dropdown

#### В таблице
- **Arrow Up/Down:** Навигация по строкам
- **Arrow Left/Right:** Навигация по ячейкам
- **Enter:** Активация действия в строке
- **Space:** Выбор строки (checkbox)

#### В форме
- **Tab:** Следующее поле
- **Shift + Tab:** Предыдущее поле
- **Enter:** Submit формы (если валидна)
- **Esc:** Отмена/закрытие формы

#### В combobox
- **Arrow Down:** Открыть dropdown и перейти к первой опции
- **Arrow Up/Down:** Навигация по опциям
- **Enter:** Выбрать опцию
- **Escape:** Закрыть dropdown
- **Backspace:** Удалить последний выбранный тег

#### В tree selector
- **Arrow Right:** Раскрыть узел
- **Arrow Left:** Свернуть узел
- **Arrow Down/Up:** Навигация по узлам
- **Space:** Выбрать/снять выбор узла
- **Enter:** Раскрыть/свернуть узел

#### В модальном окне
- **Tab:** Навигация внутри модального окна (зациклена)
- **Shift + Tab:** Обратная навигация (зациклена)
- **Escape:** Закрыть модальное окно
- **Focus trap:** Фокус не выходит за пределы модального окна

### Цветовой контраст (WCAG)

#### Минимальные требования (WCAG AA)
- **Обычный текст:** Контраст минимум 4.5:1
- **Крупный текст (18px+):** Контраст минимум 3:1
- **Интерактивные элементы:** Контраст минимум 3:1

#### Проверенные комбинации
- **Основной текст (#111827) на белом (#FFFFFF):** 16.6:1 ✅
- **Вторичный текст (#6B7280) на белом:** 4.7:1 ✅
- **Primary кнопка (#3B82F6) на белом:** 4.5:1 ✅
- **Ошибка (#DC2626) на белом:** 5.1:1 ✅

### Focus Management

#### Focus trap в модальных окнах
- При открытии: фокус на первую интерактивную кнопку
- При закрытии: фокус возвращается к триггеру
- Tab зациклен внутри модального окна

#### Focus после динамических обновлений
- После успешного сохранения: фокус на кнопку "Сохранить" или сообщение об успехе
- После ошибки валидации: фокус на первое поле с ошибкой
- После добавления правила: фокус на новое поле "Поле"

---

## Интернационализация (i18n)

### Структура переводов

#### Организация файлов
```
locales/
  ru/
    common.json
    ai-agents.json
    validation.json
    errors.json
  en/
    common.json
    ai-agents.json
    validation.json
    errors.json
```

#### Пример структуры `ai-agents.json`
```json
{
  "pageTitle": "Агенты ИИ",
  "create": "Создать",
  "edit": "Редактирование",
  "delete": "Удалить",
  "sections": {
    "profile": {
      "title": "Профиль агента",
      "name": "Название",
      "instructions": "Инструкции для агента"
    },
    "channels": {
      "title": "Каналы",
      "allChannels": "Все каналы",
      "selectChannels": "Выбрать каналы"
    }
  },
  "validation": {
    "nameRequired": "Название обязательно",
    "instructionsRequired": "Инструкции обязательны"
  }
}
```

### Форматы дат/времени

#### Локаль: ru-RU
- **Дата:** DD.MM.YYYY (например, 26.01.2025)
- **Время:** HH:mm (например, 14:30)
- **Дата и время:** DD.MM.YYYY, HH:mm

#### Локаль: en-US
- **Дата:** MM/DD/YYYY (например, 01/26/2025)
- **Время:** h:mm A (например, 2:30 PM)
- **Дата и время:** MM/DD/YYYY, h:mm A

### Форматы чисел/валют

#### Числа
- **ru-RU:** 1 234,56 (пробел как разделитель тысяч, запятая как десятичный разделитель)
- **en-US:** 1,234.56 (запятая как разделитель тысяч, точка как десятичный разделитель)

#### Валюты (если применимо)
- **ru-RU:** 1 234,56 ₽
- **en-US:** $1,234.56

### Библиотека
- **Рекомендуемая:** `next-intl` или `react-i18next`
- **Определение языка:** Из заголовка Accept-Language или настройки пользователя

---

## Деплой и окружения

### Environment Variables

#### Обязательные переменные
```env
# API
NEXT_PUBLIC_API_URL=https://aai.widgets.wearekwid.com/api
API_SECRET_KEY=...

# Database
DATABASE_URL=postgresql://...

# Authentication
JWT_SECRET=...
JWT_REFRESH_SECRET=...

# CRM Integration
KOMMO_CLIENT_ID=...
KOMMO_CLIENT_SECRET=...
KOMMO_REDIRECT_URI=...

# AI Services
OPENROUTER_API_KEY=...
OPENAI_API_KEY=...

# Storage
S3_BUCKET_NAME=...
S3_ACCESS_KEY=...
S3_SECRET_KEY=...

# Monitoring
SENTRY_DSN=...
DATADOG_API_KEY=...
```

#### Опциональные переменные
```env
# Feature Flags
ENABLE_ANALYTICS=true
ENABLE_CRASH_REPORTING=true

# Performance
ENABLE_CACHE=true
CACHE_TTL=300

# Development
NODE_ENV=production
LOG_LEVEL=info
```

### Build процесс

#### Команды
```bash
# Development
npm run dev

# Production Build
npm run build

# Start Production Server
npm start

# Linting
npm run lint

# Type Checking
npm run type-check

# Testing
npm run test
```

#### Оптимизации production build
- Минификация JavaScript и CSS
- Tree shaking неиспользуемого кода
- Code splitting по роутам
- Оптимизация изображений
- Gzip/Brotli compression

### CI/CD Pipeline

#### Этапы pipeline
1. **Lint:** Проверка кода линтером
2. **Type Check:** Проверка TypeScript типов
3. **Unit Tests:** Запуск unit тестов
4. **Build:** Сборка production версии
5. **E2E Tests:** Запуск E2E тестов (опционально)
6. **Deploy:** Деплой на staging/production

#### Пример GitHub Actions
```yaml
name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check
      - run: npm run test
      - run: npm run build
      - run: npm run deploy
```

### Feature Flags

#### Использование
- Включение/выключение новых функций без деплоя
- A/B тестирование
- Постепенный rollout новых функций

#### Пример реализации
```typescript
const features = {
  newAgentUI: process.env.NEXT_PUBLIC_FEATURE_NEW_AGENT_UI === 'true',
  advancedSettings: process.env.NEXT_PUBLIC_FEATURE_ADVANCED_SETTINGS === 'true',
};
```

---

## Версионирование API

### Стратегия версионирования
- **Метод:** URL versioning (`/api/v1/ai-agents`)
- **Формат:** Semantic versioning (v1, v2, v3)

### Backward Compatibility

#### Правила
- **Новые поля:** Добавляются без изменения существующих
- **Удаление полей:** Только в новой major версии
- **Изменение типов:** Только в новой major версии
- **Новые endpoints:** Добавляются без влияния на существующие

#### Deprecation Policy
- **Уведомление:** За 3 месяца до удаления
- **Deprecation header:** `X-API-Deprecated: true`
- **Warning header:** `X-API-Deprecation-Warning: "This endpoint will be removed in v2"`

### Версионирование ответов
```json
{
  "version": "1.0",
  "data": {...},
  "deprecated": false
}
```

---

## Документация для пользователей

### Tooltips и подсказки

#### Интерактивные подсказки
- **Иконка вопроса (?):** Рядом с полями, требующими объяснения
- **Hover tooltip:** Появляется при наведении на иконку
- **Содержание:** Краткое объяснение назначения поля

#### Примеры tooltips
- **"Инструкции для агента":** "Начальные инструкции по тону, стилю и ответам вашего агента. Вы также можете добавить общие сведения о компании."
- **"Проверять перед отправкой":** "Сообщения не будут отправляться автоматически. Они появятся в поле ввода сообщения для вашего просмотра и ручной отправки."
- **"Выбрать каналы":** "Выберите каналы связи, в которых агент будет работать. Если не выбрано, агент будет работать во всех каналах."

### Help тексты

#### Описания под полями
- **Расположение:** Под полем ввода
- **Стиль:** Мелкий серый текст
- **Пример:** "Выбирайте только необходимые поля. Дополнительные поля добавляют лишний контекст и могут снизить точность ответов."

### Onboarding flow

#### Первый вход
1. **Приветственный экран:** Объяснение основных функций платформы
2. **Создание первого агента:** Пошаговый мастер с подсказками
3. **Синхронизация CRM:** Инструкция по подключению CRM
4. **База знаний:** Объяснение важности базы знаний

#### Интерактивные туры
- **Tour по странице агентов:** Объяснение основных элементов
- **Tour по редактированию агента:** Пошаговое объяснение настроек
- **Tour по синхронизации CRM:** Как синхронизировать данные

### Справочная документация

#### Разделы документации
1. **Начало работы:** Быстрый старт, создание первого агента
2. **Настройка агента:** Детальное описание всех настроек
3. **Интеграция с CRM:** Подключение и синхронизация
4. **База знаний:** Создание и управление знаниями
5. **Триггеры и цепочки:** Автоматизация действий
6. **Часто задаваемые вопросы:** FAQ по основным вопросам

#### Формат
- **Markdown файлы** в репозитории
- **Встроенная документация** в интерфейсе (модальные окна, sidebar)
- **Видео туториалы** (опционально)

---

**Дата создания отчета:** 2025-11-11
**Дата последнего обновления:** 2025-01-26
**Версия:** 4.0

