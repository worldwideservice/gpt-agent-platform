# üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Kommo CRM

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Kommo CRM (—Ä–∞–Ω–µ–µ amoCRM) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.

### üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

1. **–°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ (Leads)**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–¥–µ–ª–∫–∏
   - –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º –≤–æ—Ä–æ–Ω–∫–∏
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–π

2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ (Contacts)**
   - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
   - –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π

3. **–†–∞–±–æ—Ç–∞ —Å –≤–æ—Ä–æ–Ω–∫–∞–º–∏ (Pipelines)**
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–æ—Ä–æ–Ω–æ–∫
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ –≤–æ—Ä–æ–Ω–∫–∏
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º

4. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏**
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
   - –ê–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ

5. **Webhooks**
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∏–∑ CRM –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–¥–µ–ª–æ–∫ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
   - –¢—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π CRM

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
‚îú‚îÄ‚îÄ lib/crm/
‚îÇ   ‚îî‚îÄ‚îÄ kommo.ts                    # –ö–ª–∞—Å—Å KommoAPI —Å –º–µ—Ç–æ–¥–∞–º–∏
‚îú‚îÄ‚îÄ app/api/crm/
‚îÇ   ‚îú‚îÄ‚îÄ kommo/route.ts             # API endpoint –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ webhook/route.ts           # Webhook –¥–ª—è —Å–æ–±—ã—Ç–∏–π CRM
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useKommo.ts                # React hook –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CRM
‚îî‚îÄ‚îÄ components/crm/
    ‚îî‚îÄ‚îÄ CRMSync.tsx                # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env.local`:

```env
# Kommo CRM Configuration
KOMMO_DOMAIN=your-domain
KOMMO_CLIENT_ID=your-client-id
KOMMO_CLIENT_SECRET=your-client-secret
KOMMO_REDIRECT_URI=https://your-domain.com/api/crm/callback
KOMMO_ACCESS_TOKEN=your-access-token
KOMMO_REFRESH_TOKEN=your-refresh-token
KOMMO_WEBHOOK_SECRET=your-webhook-secret
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ Kommo

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Kommo: **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é**
2. –ü–æ–ª—É—á–∏—Ç–µ `Client ID` –∏ `Client Secret`
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `Redirect URI`
4. –ü–æ–ª—É—á–∏—Ç–µ `Access Token` —á–µ—Ä–µ–∑ OAuth 2.0

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook

1. –í Kommo: **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Webhooks**
2. –î–æ–±–∞–≤—å—Ç–µ URL: `https://your-domain.com/api/crm/webhook`
3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
   - –°–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏
   - –°–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

## üíª –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –í Server Component

```typescript
import { KommoAPI } from '@/lib/crm/kommo'

const kommo = new KommoAPI({
  domain: process.env.KOMMO_DOMAIN!,
  clientId: process.env.KOMMO_CLIENT_ID!,
  clientSecret: process.env.KOMMO_CLIENT_SECRET!,
  redirectUri: process.env.KOMMO_REDIRECT_URI!,
  accessToken: process.env.KOMMO_ACCESS_TOKEN!,
})

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
const lead = await kommo.createLead({
  name: '–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞',
  price: 10000,
})

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ—Ä–æ–Ω–æ–∫
const pipelines = await kommo.getPipelines()
```

### –í Client Component —Å —Ö—É–∫–æ–º

```typescript
'use client'

import { useKommo } from '@/hooks/useKommo'

const MyComponent = () => {
  const { createLead, loading, error } = useKommo()

  const handleCreateLead = async () => {
    const lead = await createLead({
      name: '–ö–ª–∏–µ–Ω—Ç –∏–∑ —á–∞—Ç–∞',
      price: 5000,
    })
    
    if (lead) {
      console.log('–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞:', lead.id)
    }
  }

  return (
    <button onClick={handleCreateLead} disabled={loading}>
      {loading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É'}
    </button>
  )
}
```

### –ß–µ—Ä–µ–∑ API endpoint

```typescript
// POST /api/crm/kommo
const response = await fetch('/api/crm/kommo', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    action: 'create_lead',
    data: {
      name: '–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞',
      price: 10000,
    },
  }),
})

const result = await response.json()
```

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –∏–∑ —á–∞—Ç–∞

```typescript
// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
const handleChatMessage = async (message: string, userName: string) => {
  const { createLead, createContact } = useKommo()
  
  // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç
  const contact = await createContact({
    name: userName,
    custom_fields_values: [
      {
        field_id: 123, // ID –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ CRM
        values: [{ value: '+79991234567' }],
      },
    ],
  })
  
  // –°–æ–∑–¥–∞–µ–º —Å–¥–µ–ª–∫—É
  if (contact) {
    await createLead({
      name: `–õ–∏–¥ –∏–∑ —á–∞—Ç–∞: ${userName}`,
      price: 0,
      _embedded: {
        contacts: [{ id: contact.id! }],
      },
    })
  }
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏

```typescript
const qualifyLead = async (leadId: number, isQualified: boolean) => {
  const { updateLead } = useKommo()
  
  await updateLead(leadId, {
    status_id: isQualified ? 142 : 143, // ID —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ CRM
  })
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–π –æ –¥–∏–∞–ª–æ–≥–µ

```typescript
const saveChatHistory = async (leadId: number, messages: string[]) => {
  const { addNote } = useKommo()
  
  const chatLog = messages.join('\n')
  await addNote(leadId, `–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n${chatLog}`)
}
```

### 4. Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

```typescript
// –í app/api/crm/webhook/route.ts

async function handleLeadEvent(data: any) {
  const { status, id } = data.status[0]
  
  // –ï—Å–ª–∏ —Å–¥–µ–ª–∫–∞ –ø–µ—Ä–µ—à–ª–∞ –Ω–∞ —ç—Ç–∞–ø "–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã"
  if (status.id === 142) {
    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å AI-–∞–≥–µ–Ω—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
    await activateAgentForLead(id)
  }
  
  // –ï—Å–ª–∏ —Å–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞
  if (status.id === 143) {
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ
    await sendThankYouEmail(id)
  }
}
```

## üìä –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### KommoLead (–°–¥–µ–ª–∫–∞)

```typescript
interface KommoLead {
  id?: number
  name: string                    // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
  price?: number                  // –°—É–º–º–∞ —Å–¥–µ–ª–∫–∏
  status_id?: number             // ID —Å—Ç–∞—Ç—É—Å–∞
  pipeline_id?: number           // ID –≤–æ—Ä–æ–Ω–∫–∏
  responsible_user_id?: number   // ID –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
  custom_fields_values?: Array<{
    field_id: number
    values: Array<{ value: string }>
  }>
}
```

### KommoContact (–ö–æ–Ω—Ç–∞–∫—Ç)

```typescript
interface KommoContact {
  id?: number
  name: string
  first_name?: string
  last_name?: string
  custom_fields_values?: Array<{
    field_id: number
    values: Array<{ value: string }>
  }>
}
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–•—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è**
   - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Ç–æ–∫–µ–Ω—ã –≤ Git
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env.local` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

2. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–¥–ø–∏—Å—å webhook**
   - –í–∫–ª—é—á–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É `X-Kommo-Signature`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `KOMMO_WEBHOOK_SECRET`

3. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ API endpoints**
   - –î–æ–±–∞–≤—å—Ç–µ middleware –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ 401 (Unauthorized)

```typescript
// Token –∏—Å—Ç—ë–∫, –æ–±–Ω–æ–≤–∏—Ç–µ –µ–≥–æ
const { access_token, refresh_token } = await kommo.refreshAccessToken()

// –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
process.env.KOMMO_ACCESS_TOKEN = access_token
process.env.KOMMO_REFRESH_TOKEN = refresh_token
```

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL webhook –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Kommo
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –ø—É–±–ª–∏—á–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏

### –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—è custom_fields

```typescript
// –ü–æ–ª—É—á–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –∏–∑ CRM
const response = await fetch(
  `https://${domain}.amocrm.ru/api/v4/leads/custom_fields`,
  {
    headers: { Authorization: `Bearer ${accessToken}` }
  }
)
const fields = await response.json()
console.log(fields)
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
- –ö–æ–Ω–≤–µ—Ä—Å–∏—é –∏–∑ —á–∞—Ç–∞ –≤ —Å–¥–µ–ª–∫—É
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ CRM
- –û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

–¢–æ–∫–µ–Ω—ã Kommo –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 24 —á–∞—Å–∞. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:

```typescript
// lib/crm/token-manager.ts
export class TokenManager {
  async getValidToken() {
    const expiresAt = await db.settings.get('kommo_token_expires_at')
    
    if (Date.now() > expiresAt) {
      // –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
      const { access_token, refresh_token } = await kommo.refreshAccessToken()
      
      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
      await db.settings.set('kommo_access_token', access_token)
      await db.settings.set('kommo_refresh_token', refresh_token)
      await db.settings.set('kommo_token_expires_at', Date.now() + 86400000)
      
      return access_token
    }
    
    return await db.settings.get('kommo_access_token')
  }
}
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Kommo API](https://www.amocrm.ru/developers/content/crm_platform/platform-abilities)
- [OAuth 2.0 –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è](https://www.amocrm.ru/developers/content/oauth/step-by-step)
- [Webhooks –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://www.amocrm.ru/developers/content/crm_platform/webhooks)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–í–µ—Ä—Å–∏—è API:** v4  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –û–∫—Ç—è–±—Ä—å 2024

