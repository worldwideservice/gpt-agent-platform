# Архитектура страниц платформы GPT Agent

## Общая структура

Платформа использует структуру маршрутизации с tenant-id в формате `/manage/[tenantId]/...`, где `tenantId` = `{numericId}-{slug}`.

---

## ПУБЛИЧНЫЕ СТРАНИЦЫ (доступны без авторизации)

### 1. `/` - Landing Page (Главная страница)
**Назначение:** Публичная страница для ознакомления с сервисом, привлечения новых пользователей
**Файл:** `app/page.tsx`
**Описание:**
- Отображает информацию о платформе
- Hero секция с призывом к действию
- Описание преимуществ и возможностей
- Ссылки на регистрацию и вход
- Навигация: Тарифы, Поддержка, Демо
- **НЕ редиректит** авторизованных пользователей (публичная для всех)

### 2. `/login` - Страница входа
**Назначение:** Авторизация существующих пользователей
**Файл:** `app/(auth)/login/page.tsx` + `LoginClient.tsx`
**Описание:**
- Форма входа (email + password)
- После успешного входа → редирект на `/manage/[tenantId]`
- Ссылки на восстановление пароля и регистрацию
- Демо-учетные данные в режиме разработки

### 3. `/register` - Страница регистрации
**Назначение:** Регистрация новых пользователей
**Файл:** `app/(auth)/register/page.tsx` + `RegisterClient.tsx`
**Описание:**
- Форма регистрации (имя, email, пароль)
- Создание организации автоматически при регистрации
- После регистрации → редирект на `/login?registered=true`

### 4. `/reset-password/request` - Запрос восстановления пароля
**Назначение:** Запрос ссылки для восстановления пароля
**Файл:** `app/(auth)/reset-password/request/page.tsx`
**Описание:**
- Форма для ввода email
- Отправка ссылки восстановления на email

### 5. `/reset-password/[token]` - Подтверждение сброса пароля
**Назначение:** Установка нового пароля по токену из email
**Файл:** `app/(auth)/reset-password/[token]/page.tsx`
**Описание:**
- Валидация токена
- Форма для ввода нового пароля
- После смены пароля → редирект на `/login`

### 6. `/demo` - Демо страница
**Назначение:** Демонстрация возможностей платформы
**Файл:** `app/demo/page.tsx`
**Описание:**
- Демонстрационный контент (если есть)

### 7. `/pricing` - Публичная страница тарифов
**Назначение:** Просмотр тарифных планов без авторизации
**Файл:** `app/pricing/page.tsx` (публичная) и `app/(protected)/manage/[tenantId]/pricing/page.tsx` (управление подпиской)
**Описание:**
- Список доступных тарифов
- Описание возможностей каждого плана
- Призыв к регистрации
- Переключатель ежемесячной/годовой оплаты и выбор лимита ответов

### 8. `/support` - Центр поддержки
**Назначение:** Доступ к руководствам, FAQ и контактам поддержки
**Файл:** `app/support/page.tsx` + статьи в `app/support/articles/*`
**Описание:**
- Основные разделы: Начало работы, Видеоуроки, Документация, FAQ
- Подробные статьи: `getting-started`, `video-library`, `documentation`, `billing-faq`
- CTA для регистрации и входа
- Контакты службы поддержки, Telegram-бот и форма записи на консультацию

---

## ЗАЩИЩЕННЫЕ СТРАНИЦЫ (требуют авторизации)

### СТАРЫЕ ПУТИ (редиректы на новые с tenant-id)

#### 9. `/(protected)/page.tsx` - Главная защищенная страница (РЕДИРЕКТ)
**Назначение:** Редирект на `/manage/[tenantId]`
**Файл:** `app/(protected)/page.tsx`
**Логика:** Получает tenant-id из сессии и редиректит на дашборд

#### 10. `/(protected)/agents/page.tsx` - Список агентов (РЕДИРЕКТ)
**Назначение:** Редирект на `/manage/[tenantId]/ai-agents`
**Файл:** `app/(protected)/agents/page.tsx`

#### 11. `/(protected)/chat/page.tsx` - Тестовый чат (РЕДИРЕКТ)
**Назначение:** Редирект на `/manage/[tenantId]/test-chat`
**Файл:** `app/(protected)/chat/page.tsx`

#### 12. `/(protected)/knowledge-base/page.tsx` - База знаний (РЕДИРЕКТ)
**Назначение:** Редирект на `/manage/[tenantId]/knowledge-categories`
**Файл:** `app/(protected)/knowledge-base/page.tsx`

#### 13. `/(protected)/knowledge-base/categories/page.tsx` - Категории (РЕДИРЕКТ)
**Назначение:** Редирект на `/manage/[tenantId]/knowledge-categories`
**Файл:** `app/(protected)/knowledge-base/categories/page.tsx`

#### 14. `/(protected)/knowledge-base/articles/page.tsx` - Статьи (РЕДИРЕКТ)
**Назначение:** Редирект на `/manage/[tenantId]/knowledge-items`
**Файл:** `app/(protected)/knowledge-base/articles/page.tsx`

#### 15. `/(protected)/account/page.tsx` - Настройки аккаунта (РЕДИРЕКТ)
**Назначение:** Редирект на `/manage/[tenantId]/account-settings`
**Файл:** `app/(protected)/account/page.tsx`

#### 16. `/(protected)/pricing/page.tsx` - Тарифы (РЕДИРЕКТ)
**Назначение:** Редирект на `/manage/[tenantId]/pricing`
**Файл:** `app/(protected)/pricing/page.tsx`

#### 17. `/(protected)/support/page.tsx` - Поддержка
**Назначение:** Редиректит на новый центр поддержки `/manage/[tenantId]/support`
**Файл:** `app/(protected)/support/page.tsx` (редирект), `app/(protected)/manage/[tenantId]/support/page.tsx`
**Описание:**
- Разделы: Начало работы, Видеоуроки, Документация, FAQ
- Контактная информация поддержки и быстрые CTA

#### 18. `/(protected)/integrations/page.tsx` - Интеграции
**Назначение:** Редиректит на `/manage/[tenantId]/integrations`
**Файл:** `app/(protected)/integrations/page.tsx` (редирект), `app/(protected)/manage/[tenantId]/integrations/page.tsx`
**Описание:**
- Подключение Kommo CRM и проверка статуса синхронизации
- Кнопки обновления статуса и управление подключением

#### 19. `/(protected)/onboarding/page.tsx` - Онбординг
**Назначение:** Первичная настройка платформы для новой организации
**Файл:** `app/(protected)/onboarding/page.tsx` + `OnboardingClient.tsx`
**Описание:**
- Многошаговый процесс настройки (3 шага):
  1. Подключение CRM (Kommo)
  2. Настройка AI-агента
  3. Резюме и запуск
- Автоматический редирект на дашборд после завершения
- Показывается только если `onboardingState.isCompleted === false`

---

## РАБОЧИЕ СТРАНИЦЫ ПЛАТФОРМЫ (формат `/manage/[tenantId]/...`)

### ДАШБОРД

#### 20. `/manage/[tenantId]` - Дашборд (Главная страница платформы)
**Назначение:** Центральная страница с метриками и статистикой
**Файл:** `app/(protected)/manage/[tenantId]/page.tsx`
**Описание:**
- **Карточки статистики:**
  - Ответы ИИ за этот месяц (с изменением к прошлому месяцу)
  - Ответы ИИ за последние 7 дней
  - Ответы ИИ сегодня (с изменением к вчера)
  - Общее количество агентов
- **Графики:**
  - Линейный график "Ответы ИИ за этот месяц"
  - Линейный график "Ответы ИИ за день"
  - Столбчатый график "Активность за последние 7 дней"
- **Последние обновления:** Список недавних событий/уведомлений
- **Проверка онбординга:** Если не завершен → редирект на `/onboarding`

---

### УПРАВЛЕНИЕ АГЕНТАМИ

#### 21. `/manage/[tenantId]/ai-agents` - Список агентов ИИ
**Назначение:** Просмотр и управление списком всех AI-агентов организации
**Файл:** `app/(protected)/manage/[tenantId]/ai-agents/page.tsx`
**Компоненты:** `AgentsClient.tsx`
**Функционал:**
- Таблица со списком агентов
- **Колонки:** Название, Статус (активен/неактивен), Модель ИИ, Действия
- **Действия для каждого агента:**
  - Изменить → переход на страницу редактирования
  - Копировать → создание копии агента
  - Удалить → удаление агента (с подтверждением)
- **Поиск:** Поиск агентов по названию
- **Фильтрация:** Переключение столбцов (кнопка фильтра)
- **Массовые действия:** Выбор нескольких агентов чекбоксами
- **Пагинация:** Настройка количества элементов на странице
- **Кнопка "Создать":** Создание нового агента

#### 22. `/manage/[tenantId]/ai-agents/create` - Создание нового агента
**Назначение:** Форма создания нового AI-агента
**Файл:** `app/(protected)/manage/[tenantId]/ai-agents/create/page.tsx`
**Описание:**
- Форма с минимальными полями для создания агента
- После создания → редирект на страницу редактирования

#### 23. `/manage/[tenantId]/ai-agents/[id]/edit` - Редактирование агента
**Назначение:** Полная настройка и редактирование AI-агента
**Файл:** `app/(protected)/manage/[tenantId]/ai-agents/[id]/edit/page.tsx`
**Компоненты:** `AgentEditForm.tsx`
**Функционал:**
- **Breadcrumbs:** Агенты ИИ → Название агента → Редактирование
- **Вкладки:**
  1. **Основное:**
     - Название агента
     - Статус (активен/неактивен/черновик)
     - Модель ИИ
     - Инструкции для агента (большое textarea)
     - Приветственное сообщение
     - Описание
  2. **CRM (Сделки и контакты):**
     - Выбор полей сделок для обновления
     - Выбор полей контактов для обновления
     - Настройки триггеров (создание задач, обновление полей)
  3. **Интеграции:**
     - Таблица подключенных интеграций
     - Настройка каналов коммуникации
  4. **Дополнительно:**
     - Настройки модели ИИ
     - Язык агента
     - Настройки ответа (temperature, maxTokens, задержка, штрафы)
- **Кнопка "Удалить":** Удаление агента с подтверждением
- **Сохранение:** Кнопка сохранения изменений

#### 24. `/manage/[tenantId]/ai-agents/[id]/pipelines` - Настройка воронок для агента
**Назначение:** Настройка работы агента с воронками продаж из CRM
**Файл:** `app/(protected)/manage/[tenantId]/ai-agents/[id]/pipelines/page.tsx`
**Компоненты:** `PipelinesClient.tsx`
**Описание:**
- Выбор воронок из CRM (Kommo)
- Настройка этапов воронки для работы агента
- Правила работы на каждом этапе
- Настройка триггеров при переходе между этапами

#### 25. `/manage/[tenantId]/ai-agents/[id]/training` - Обучение агента
**Назначение:** Загрузка данных для обучения агента (база знаний, файлы)
**Файл:** `app/(protected)/manage/[tenantId]/ai-agents/[id]/training/page.tsx`
**Компоненты:** `AgentTrainingPage.tsx`, `FileUpload.tsx`
**Описание:**
- Загрузка файлов для обучения (PDF, DOCX, TXT и т.д.)
- Подключение базы знаний
- Обучение на примерах диалогов
- Просмотр загруженных материалов

---

### БАЗА ЗНАНИЙ

#### 26. `/manage/[tenantId]/knowledge-categories` - Категории базы знаний
**Назначение:** Управление категориями для организации базы знаний
**Файл:** `app/(protected)/manage/[tenantId]/knowledge-categories/page.tsx`
**Компоненты:** `CategoriesClient.tsx`
**Функционал:**
- Таблица категорий
- **Колонки:** Название, Подкатегорий, Статей, Действия
- **Поиск:** Поиск категорий
- **Фильтрация:** Фильтры по статусу
- **Действия:**
  - Создать новую категорию
  - Редактировать категорию
  - Удалить категорию
- **Счетчики:** Количество подкатегорий и статей в каждой категории

#### 27. `/manage/[tenantId]/knowledge-items` - Статьи базы знаний
**Назначение:** Управление статьями/материалами базы знаний
**Файл:** `app/(protected)/manage/[tenantId]/knowledge-items/page.tsx`
**Компоненты:** `ArticlesClient.tsx`
**Функционал:**
- Таблица статей
- **Колонки:** Название, Категория, Дата создания, Действия
- **Поиск:** Поиск статей
- **Фильтры:**
  - По категориям
  - По статусу
- **Отображение активных фильтров**
- **Действия:**
  - Создать новую статью
  - Редактировать статью
  - Удалить статью
- **Empty state:** Сообщение когда статей нет

---

### ТЕСТИРОВАНИЕ

#### 28. `/manage/[tenantId]/test-chat` - Тестовый чат
**Назначение:** Тестирование работы агентов в реальном времени
**Файл:** `app/(protected)/manage/[tenantId]/test-chat/page.tsx`
**Функционал:**
- **Боковая панель:** Список диалогов (чатов)
  - Создание нового чата
  - Выбор существующего чата
- **Основная область:**
  - Выбор агента для тестирования (dropdown)
  - История сообщений (user/assistant)
  - Поле ввода сообщения
  - Кнопка отправки
- **Функционал:**
  - Отправка сообщений агенту
  - Получение ответов от агента
  - История всех диалогов
  - Создание новых чатов

---

### НАСТРОЙКИ АККАУНТА

#### 29. `/manage/[tenantId]/account-settings` - Настройки аккаунта
**Назначение:** Настройки пользователя и организации
**Файл:** `app/(protected)/manage/[tenantId]/account-settings/page.tsx`
**Функционал:**
- **Вкладка "Общие":**
  - Переключатель "Останавливать агентов ИИ при ответе человека"
  - Описание: Если включить, агенты перестанут отвечать, как только человек отправит сообщение в этом чате
  - Кнопка "Сохранить изменения"
- **Профиль пользователя:**
  - Имя (read-only)
  - Email (read-only)
- **Сохранение настроек:** Отправка на сервер через API

---

### ТАРИФЫ И БИЛЛИНГ

#### 30. `/manage/[tenantId]/pricing` - Тарифные планы
**Назначение:** Управление подпиской и выбором тарифного плана
**Файл:** `app/(protected)/manage/[tenantId]/pricing/page.tsx`
**Компоненты:** `PricingClient.tsx`
**Функционал:**
- **Текущий план:**
  - Отображение текущего тарифа
  - Использование ответов ИИ (прогресс бар)
  - Дата следующего списания
  - Платежный цикл (ежемесячно/ежегодно)
- **Выбор плана:**
  - Выбор количества ответов ИИ (10k, 15k, 20k)
  - Переключение между ежемесячным/годовым биллингом
  - Карточки тарифов: Launch, Scale, Max
  - Описание возможностей каждого плана
  - Кнопка "Выбрать план"
- **FAQ секция:** Часто задаваемые вопросы о тарифах
- **30-дневная гарантия возврата денег**
- **Кнопки:**
  - Уведомления (боковая панель)
  - Управление подпиской

---

## СТАРЫЕ СТРАНИЦЫ (устаревшие, могут быть удалены или использоваться как fallback)

### 31. `/(protected)/agents/[id]/edit` - Старая страница редактирования
**Файл:** `app/(protected)/agents/[id]/edit/page.tsx`
**Статус:** Должна редиректить на `/manage/[tenantId]/ai-agents/[id]/edit`

### 32. `/(protected)/agents/[id]/pipelines` - Старая страница воронок
**Файл:** `app/(protected)/agents/[id]/pipelines/page.tsx`
**Статус:** Должна редиректить на `/manage/[tenantId]/ai-agents/[id]/pipelines`

### 33. `/(protected)/agents/[id]/training` - Старая страница обучения
**Файл:** `app/(protected)/agents/[id]/training/page.tsx`
**Статус:** Должна редиректить на `/manage/[tenantId]/ai-agents/[id]/training`

### 34. `/(protected)/agents/create` - Старая страница создания
**Файл:** `app/(protected)/agents/create/page.tsx`
**Статус:** Должна редиректить на `/manage/[tenantId]/ai-agents/create`

### 35. `/(protected)/agents/new` - Дублирующая страница создания
**Файл:** `app/(protected)/agents/new/page.tsx`
**Статус:** Должна редиректить на `/manage/[tenantId]/ai-agents/create`

### 36. `/(protected)/agents/[id]/page.tsx` - Старая страница просмотра агента
**Файл:** `app/(protected)/agents/[id]/page.tsx`
**Статус:** Должна редиректить на редактирование

### 37. `/(protected)/knowledge-base/categories/[id]/page.tsx` - Старая страница категории
**Статус:** Должна редиректить на новый формат

### 38. `/(protected)/knowledge-base/categories/new/page.tsx` - Старая страница создания категории
**Статус:** Должна редиректить на новый формат

### 39. `/(protected)/knowledge-base/articles/[id]/page.tsx` - Старая страница статьи
**Статус:** Должна редиректить на новый формат

### 40. `/(protected)/knowledge-base/articles/new/page.tsx` - Старая страница создания статьи
**Статус:** Должна редиректить на новый формат

---

## СЛУЖЕБНЫЕ СТРАНИЦЫ

### 41. `/admin` - Админ панель
**Назначение:** Административная панель для управления платформой
**Файл:** `app/admin/page.tsx`
**Доступ:** Только для администраторов
**Описание:**
- Статистика по всей платформе
- Управление пользователями и организациями
- Системные настройки

### 42. `/api-docs` - Документация API
**Назначение:** Документация REST API платформы
**Файл:** `app/api-docs/page.tsx`
**Описание:**
- Описание всех API endpoints
- Примеры запросов и ответов

### 43. `/graphql-playground` - GraphQL Playground
**Назначение:** Интерактивная среда для тестирования GraphQL запросов
**Файл:** `app/graphql-playground/page.tsx`
**Описание:**
- GraphQL схема
- Выполнение запросов и мутаций
- Документация типов

### 44. `/test-kommo` - Тестовая страница Kommo интеграции
**Назначение:** Тестирование интеграции с Kommo CRM
**Файл:** `app/test-kommo/page.tsx`
**Описание:**
- Тестовые запросы к Kommo API
- Проверка подключения
- Отладка синхронизации

### 45. `/integrations/kommo/oauth/callback` - OAuth callback для Kommo
**Назначение:** Обработка OAuth редиректа от Kommo после авторизации
**Файл:** `app/integrations/kommo/oauth/callback/page.tsx`
**Описание:**
- Получение authorization code
- Обмен на access token
- Сохранение подключения в базе
- Редирект обратно в настройки интеграции

---

## ЛОГИКА МАРШРУТИЗАЦИИ

### Принципы:
1. **Все страницы платформы используют формат `/manage/[tenantId]/...`**
2. **Старые пути автоматически редиректят на новые**
3. **Tenant-id получается из сессии пользователя**
4. **Если tenant-id не получен → редирект на `/login`**

### Последовательность после входа:
1. Пользователь вводит email/password на `/login`
2. После успешной авторизации вызывается `/api/auth/get-tenant-redirect`
3. Получается tenant-id из сессии
4. Редирект на `/manage/[tenantId]` (дашборд)
5. Если онбординг не завершен → редирект на `/onboarding`
6. Если онбординг завершен → отображается дашборд

### Проверка доступа:
- Все страницы в `(protected)` проверяют авторизацию
- Layout `(protected)/layout.tsx` проверяет сессию
- Layout `(protected)/manage/[tenantId]/layout.tsx` проверяет доступ к организации

---

## ИЕРАРХИЯ СТРАНИЦ

```
Публичные:
├── / (Landing)
├── /login
├── /register
├── /reset-password/*
└── /demo

Защищенные (платформа):
└── /manage/[tenantId]/
    ├── / (Dashboard)
    ├── /ai-agents
    │   ├── /create
    │   └── /[id]/
    │       ├── /edit
    │       ├── /pipelines
    │       └── /training
    ├── /test-chat
    ├── /knowledge-categories
    ├── /knowledge-items
    ├── /account-settings
    └── /pricing

Служебные:
├── /admin
├── /api-docs
├── /graphql-playground
└── /test-kommo
```

---

## ЗАМЕЧАНИЯ

1. **Старые пути (`/agents`, `/chat`, `/knowledge-base` и т.д.) должны быть удалены или все редиректят на новые**
2. **Все новые функции добавляются только в формат `/manage/[tenantId]/...`**
3. **Landing page (`/`) всегда публичная, не редиректит авторизованных**
4. **После входа пользователь всегда попадает на дашборд `/manage/[tenantId]`**
