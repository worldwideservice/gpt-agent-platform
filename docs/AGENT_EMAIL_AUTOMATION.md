# Автоматический ответ агента на входящие email в Kommo

## Описание

Реализована функциональность автоматической обработки входящих email в сделках Kommo и генерации ответов через AI-агента. Агент автоматически формирует и отправляет ответы на email от клиентов, когда сделка находится на этапе воронки, для которого настроен агент.

## Как это работает

### Процесс обработки

1. **Клиент пишет email в сделку Kommo**
   - Email приходит в сделку через интеграцию Kommo

2. **Kommo отправляет webhook**
   - Тип события: `messages` с подтипом `message_received`
   - Webhook содержит данные письма: `from`, `to`, `subject`, `text/html`

3. **Система обрабатывает webhook**
   - Извлекает данные письма из payload
   - Определяет `entity_id` (ID сделки) и `entity_type`
   - Фильтрует только входящие сообщения в сделках (`entity_type === 'leads'`)

4. **Проверка настроек агента**
   - Получает информацию о сделке из Kommo (`pipeline_id`, `status_id`)
   - Проверяет, есть ли агенты, настроенные для этого этапа воронки
   - Если агент не настроен - обработка прекращается

5. **Сбор контекста для агента**
   - Получает историю переписки из заметок сделки (последние 10 писем)
   - Собирает полный контекст:
     - Инструкции агента
     - Знания компании
     - Скрипты продаж для этапа
     - Ответы на возражения
     - Векторный поиск по базе знаний
     - Память о клиенте (если есть)

6. **Генерация ответа через LLM**
   - Использует настройки агента (модель, temperature, max_tokens)
   - Формирует системный промпт с полным контекстом
   - Генерирует ответ на основе письма клиента и истории переписки

7. **Отправка ответа**
   - Форматирует ответ в HTML
   - Отправляет email через `kommoApi.sendEmailFromLead()`
   - Письмо появляется в сделке как заметка типа `mail_message`

## Файлы

### Созданные файлы

- **`lib/services/agent-email-handler.ts`**
  - Основной сервис для обработки входящих email
  - Функция `handleIncomingEmailForAgent()` - главная функция обработки
  - Форматирование ответов в HTML

### Обновленные файлы

- **`lib/services/webhook-processor.ts`**
  - Улучшена функция `handleMessageEvent()`
  - Добавлена асинхронная обработка email через `handleIncomingEmailForAgentAsync()`
  - Обрабатывает только входящие сообщения (`message_received`)

- **`app/api/crm/webhook/route.ts`**
  - Улучшена функция `extractEventMetadata()`
  - Правильно определяет `entity_id`, `entity_type` и `eventSubtype` для событий `messages`
  - Поддерживает разные форматы payload от Kommo

- **`lib/crm/kommo.ts`**
  - Добавлен метод `getLead(leadId)` для получения информации о сделке по ID
  - Используется для определения `pipeline_id` и `status_id`

## Настройка агента

Для того, чтобы агент автоматически отвечал на email, необходимо:

1. **Создать агента** в системе
2. **Настроить агента для воронки и этапа**:
   - Перейти в настройки агента → "Воронки"
   - Выбрать воронку и этап(ы), на которых агент должен работать
   - Активировать настройку (`is_active = true`)

3. **Настроить инструкции агента** (опционально):
   - Добавить инструкции о том, как агент должен отвечать на письма
   - Настроить модель, temperature, max_tokens

4. **Загрузить знания в базу знаний** (опционально):
   - Агент будет использовать знания компании при формировании ответов
   - Можно добавить скрипты продаж для конкретных этапов
   - Можно добавить ответы на возражения

## Пример использования

### Пример payload от Kommo

```json
{
  "messages": {
    "add": [
      {
        "id": 12345,
        "entity_id": 67890,
        "entity_type": "leads",
        "created_at": 1234567890,
        "params": {
          "from": "client@example.com",
          "to": "sales@company.com",
          "subject": "Вопрос о продукте",
          "text": "Здравствуйте, у меня вопрос...",
          "html": "<p>Здравствуйте, у меня вопрос...</p>",
          "direction": "in"
        }
      }
    ]
  }
}
```

### Пример обработки

1. Webhook приходит в `/api/crm/webhook`
2. Система определяет: `eventType = 'messages'`, `eventSubtype = 'message_received'`
3. `handleMessageEvent()` обрабатывает событие
4. Если сделка `67890` находится на этапе, для которого настроен агент:
   - Агент получает письмо и историю переписки
   - Генерирует ответ через LLM
   - Отправляет ответ клиенту через Kommo

## Особенности реализации

- **Асинхронная обработка**: Email обрабатывается асинхронно, не блокируя webhook
- **Обработка ошибок**: Если обработка не удалась, событие не помечается как failed, просто логируется ошибка
- **История переписки**: Агент использует последние 10 писем из сделки для контекста
- **Память о клиенте**: Использует email как идентификатор клиента для извлечения памяти
- **HTML форматирование**: Ответ форматируется в HTML с автоматическим преобразованием markdown

## Логирование

Все действия логируются в консоль:
- `Processing incoming email in lead {leadId} from {from}`
- `Agent {agentId} successfully responded to email in lead {leadId}`
- `Failed to handle email in lead {leadId}: {error}`

## Будущие улучшения

- [ ] Приоритизация агентов (если несколько агентов настроены для этапа)
- [ ] Настройка задержки ответа (response_delay_seconds)
- [ ] Поддержка attachments в письмах
- [ ] Более продвинутое форматирование HTML (поддержка markdown)
- [ ] Возможность отключить автоматические ответы для конкретных сделок
- [ ] Метрики и аналитика ответов агента

