# ‚úÖ RAG –°–∏—Å—Ç–µ–º–∞ - –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üéØ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### 1. ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Knowledge Graph —Ç–∞–±–ª–∏—Ü—ã:**
  - `knowledge_graph_entities` - —Å—É—â–Ω–æ—Å—Ç–∏ (–ª—é–¥–∏, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
  - `knowledge_graph_relationships` - —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏
  - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

- **–£–ª—É—á—à–µ–Ω–∏—è `agent_assets`:**
  - –ü–æ–ª—è: `file_size`, `mime_type`, `chunks_count`, `processing_error`
  - –ò–Ω–¥–µ–∫—Å—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ —Ç–∏–ø—É

- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞:**
  - `match_knowledge_chunks` —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `article_id`

### 2. ‚úÖ API Endpoints
- `POST /api/agents/[id]/assets` - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
- `GET /api/agents/[id]/assets` - —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∞–≥–µ–Ω—Ç–∞
- `DELETE /api/agents/[id]/assets/[assetId]` - —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞

### 3. ‚úÖ Backend API (Fastify)
- `POST /jobs` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∏–ø–∞ `process-asset`

### 4. ‚úÖ Worker –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤
- –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤ (TXT, HTML, Markdown - –±–∞–∑–æ–≤—ã–π)
- –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ chunks (600 —Ç–æ–∫–µ–Ω–æ–≤, overlap 120)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings —á–µ—Ä–µ–∑ OpenRouter
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ chunks –≤ –ë–î —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤

### 5. ‚úÖ –°–µ—Ä–≤–∏—Å—ã
- `lib/services/file-parser.ts` - –ø–∞—Ä—Å–µ—Ä —Ñ–∞–π–ª–æ–≤ (–≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é)
- `lib/services/knowledge-graph.ts` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ —Å–≤—è–∑–µ–π
- `lib/repositories/agent-assets.ts` - —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏

### 6. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `docs/RAG_SYSTEM.md` - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- –≠—Ç–æ—Ç —Ñ–∞–π–ª - –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

## ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å:

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ:

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞:**
   ```bash
   cd services/worker
   npm install pdf-parse mammoth cheerio
   ```
   –ò –æ–±–Ω–æ–≤–∏—Ç—å `process-asset.ts` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫

2. **–°–æ–∑–¥–∞—Ç—å Storage bucket –≤ Supabase:**
   ```sql
   INSERT INTO storage.buckets (id, name, public)
   VALUES ('agent-assets', 'agent-assets', false);
   ```
   –ò –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (—Å–º. `docs/RAG_SYSTEM.md`)

3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   - `OPENROUTER_API_KEY` –≤ `services/worker/.env`
   - `BACKEND_API_URL` –≤ –∫–æ—Ä–Ω–µ–≤–æ–º `.env.local`

### üü° –í–∞–∂–Ω–æ:

4. **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** (TODO):
   - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞–≥–µ–Ω—Ç–∞
   - –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å —Å—Ç–∞—Ç—É—Å–∞–º–∏
   - –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤

5. **Knowledge Graph extraction** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   - –°–µ–π—á–∞—Å –ø—Ä–æ–ø—É—â–µ–Ω–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π worker job

6. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤:**
   - PDF (—Ç—Ä–µ–±—É–µ—Ç `pdf-parse`)
   - DOCX (—Ç—Ä–µ–±—É–µ—Ç `mammoth`)
   - HTML (—É–ª—É—á—à–∏—Ç—å —á–µ—Ä–µ–∑ `cheerio`)

## üìã –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–ø—É—Å–∫–∞:

- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î (`supabase/schema.sql`)
- [ ] –°–æ–∑–¥–∞—Ç—å Storage bucket `agent-assets`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è Storage
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ `services/worker`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –ø–∞—Ä—Å–µ—Ä–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `OPENROUTER_API_KEY` –≤ worker
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã (Next.js, API, Worker)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ API

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. **–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª:**
   ```bash
   curl -X POST http://localhost:3000/api/agents/{agentId}/assets \
     -H "Cookie: next-auth.session-token=..." \
     -F "file=@test.txt"
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
   ```bash
   curl http://localhost:3000/api/agents/{agentId}/assets
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å logs worker:**
   ```bash
   cd services/worker
   npm run dev
   # –î–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª –∏ —Å–æ–∑–¥–∞—Ç—å chunks
   ```

## üí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –°–æ–∑–¥–∞—Ç—å UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
2. –î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Knowledge Graph extraction (–æ—Ç–¥–µ–ª—å–Ω—ã–π job)
4. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–æ–≤
5. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä chunks –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `docs/RAG_SYSTEM.md`
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã: `docs/ARCHITECTURE.md`






