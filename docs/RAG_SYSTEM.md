# üîç RAG (Retrieval Augmented Generation) –°–∏—Å—Ç–µ–º–∞

–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤, —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö embeddings –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è Knowledge Graph –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã AI-–∞–≥–µ–Ω—Ç–æ–≤.

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

1. **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤** (`/api/agents/[id]/assets`)
   - –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ Supabase Storage
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞: PDF, DOCX, TXT, HTML, Markdown
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 MB

2. **–ü–∞—Ä—Å–µ—Ä —Ñ–∞–π–ª–æ–≤** (`lib/services/file-parser.ts`)
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞

3. **Worker –æ–±—Ä–∞–±–æ—Ç–∫–∏** (`services/worker/src/tasks/process-asset.ts`)
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ —Ñ–æ–Ω–µ
   - –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ chunks
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –¥–ª—è Knowledge Graph

4. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** (`lib/repositories/knowledge-search.ts`)
   - –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö chunks –ø–æ –∑–∞–ø—Ä–æ—Å—É
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ pgvector –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

5. **Knowledge Graph** (`lib/services/knowledge-graph.ts`)
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π (–ª—é–¥–∏, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
   - –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã:

#### `agent_assets`
–•—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö:
```sql
- id: uuid
- agent_id: uuid (—Å—Å—ã–ª–∫–∞ –Ω–∞ –∞–≥–µ–Ω—Ç–∞)
- org_id: uuid
- type: text ('file')
- source_name: text (–∏–º—è —Ñ–∞–π–ª–∞)
- storage_path: text (–ø—É—Ç—å –≤ Storage)
- status: 'pending' | 'processing' | 'completed' | 'failed'
- file_size: bigint
- mime_type: text
- chunks_count: integer
- processing_error: text
```

#### `knowledge_chunks`
Chunks –∏–∑ —Ñ–∞–π–ª–æ–≤ —Å embeddings:
```sql
- id: uuid
- agent_id: uuid (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —Ñ–∞–π–ª–æ–≤ –∞–≥–µ–Ω—Ç–∞)
- org_id: uuid
- asset_id: uuid (—Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª)
- article_id: uuid (—Å—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—å—é –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π)
- content: text (—Ç–µ–∫—Å—Ç chunk)
- embedding: vector(1536) (–≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)
- metadata: jsonb (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
```

#### `knowledge_graph_entities`
–°—É—â–Ω–æ—Å—Ç–∏ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
```sql
- id: uuid
- org_id: uuid
- agent_id: uuid (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- entity_type: 'person' | 'organization' | 'product' | 'service' | 'concept' | 'event'
- entity_name: text
- entity_value: text
- confidence: numeric(3,2) (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è)
- source_chunk_id: uuid
```

#### `knowledge_graph_relationships`
–°–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏:
```sql
- id: uuid
- org_id: uuid
- source_entity_id: uuid
- target_entity_id: uuid
- relationship_type: 'works_for' | 'provides' | 'uses' | 'related_to' | 'part_of'
- confidence: numeric(3,2)
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ API

```typescript
const formData = new FormData()
formData.append('file', fileBlob, 'document.pdf')

const response = await fetch(`/api/agents/${agentId}/assets`, {
  method: 'POST',
  body: formData,
})

const { data } = await response.json()
// data: { id, name, size, type, status: 'pending' }
```

### 2. –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏

–§–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏. –°—Ç–∞—Ç—É—Å—ã:
- `pending` - —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `processing` - –∏–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞
- `completed` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- `failed` - –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å–º. `processing_error`)

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —á–∞—Ç–µ

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç embedding –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ò—â–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ chunks —á–µ—Ä–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
3. –í–∫–ª—é—á–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ chunks –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM

```typescript
// –í /api/chat –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è searchKnowledgeBase
const chunks = await searchKnowledgeBase(orgId, userMessage, agentId, 5)
// chunks –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞

```bash
cd services/worker
npm install pdf-parse mammoth cheerio
```

### –°–æ–∑–¥–∞–Ω–∏–µ Storage bucket –≤ Supabase

```sql
-- –°–æ–∑–¥–∞–π—Ç–µ bucket –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤
INSERT INTO storage.buckets (id, name, public)
VALUES ('agent-assets', 'agent-assets', false);

-- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è bucket
CREATE POLICY "Users can upload agent assets"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'agent-assets' AND
  auth.uid() IS NOT NULL
);

CREATE POLICY "Users can read own agent assets"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'agent-assets' AND
  auth.uid() IS NOT NULL
);
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `OPENROUTER_API_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ embeddings.

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

1. **–ò–Ω–¥–µ–∫—Å—ã pgvector**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è IVFFlat –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
2. **–†–∞–∑–º–µ—Ä chunks**: 600 —Ç–æ–∫–µ–Ω–æ–≤ —Å overlap 120 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
3. **Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞**: Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 50 MB
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOCX, TXT, HTML, Markdown
- –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å embeddings: 1536 (OpenAI text-embedding-3-large)

## üéØ Knowledge Graph

Knowledge Graph –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤:
- LLM –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
import { getRelatedEntities } from '@/lib/services/knowledge-graph'

// –ü–æ–ª—É—á–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
const related = await getRelatedEntities(orgId, ['–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', '–ö–æ–º–ø–∞–Ω–∏—è ABC'], 10)
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–º–ø—Ç–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª
   ‚Üì
2. –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Supabase Storage
   ‚Üì
3. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ agent_assets (status: 'pending')
   ‚Üì
4. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ –≤ –æ—á–µ—Ä–µ–¥—å (Redis/BullMQ)
   ‚Üì
5. Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–∞–π–ª:
   a) –°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –∏–∑ Storage
   b) –ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç
   c) –†–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ chunks
   d) –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç embeddings
   e) –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏ (Knowledge Graph)
   f) –°–æ—Ö—Ä–∞–Ω—è–µ—Ç chunks –≤ –ë–î
   ‚Üì
6. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ 'completed'
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

1. **–ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤**: –¢—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫:
   - `pdf-parse` –¥–ª—è PDF
   - `mammoth` –¥–ª—è DOCX
   - `cheerio` –¥–ª—è HTML (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

2. **Knowledge Graph**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç:
   - –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `OPENROUTER_API_KEY`
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

3. **Storage**: –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ–∑–¥–∞—Ç—å bucket –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏

## üêõ Troubleshooting

### –§–∞–π–ª –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ worker: `cd services/worker && npm run dev`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redis –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ `OPENROUTER_API_KEY`

### Embeddings –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á OpenRouter
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã API
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥–µ–ª—å embeddings –¥–æ—Å—Ç—É–ø–Ω–∞

### Knowledge Graph –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ worker (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ LLM –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ–∫—Å—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–µ–Ω

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Supabase Storage Docs](https://supabase.com/docs/guides/storage)
- [pgvector Docs](https://github.com/pgvector/pgvector)
- [OpenRouter Embeddings](https://openrouter.ai/docs/embeddings)










