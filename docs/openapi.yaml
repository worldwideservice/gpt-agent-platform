openapi: 3.0.3
info:
  title: GPT Agent Platform API
  description: |
    REST API для платформы управления AI агентами с интеграцией CRM.

    ## Аутентификация

    API использует NextAuth.js для аутентификации. Для доступа к защищенным endpoints
    требуется валидная сессия (cookie-based authentication).

    ## Rate Limiting

    - **Authenticated users**: 100 запросов/минуту
    - **Anonymous users**: 20 запросов/минуту
    - **Auth endpoints**: 10 запросов/5 минут

    ## CSRF Protection

    Все state-changing операции (POST/PATCH/DELETE) требуют CSRF токен в заголовке `x-csrf-token`.
    Получить токен можно через `GET /api/csrf-token`.

  version: 1.0.5
  contact:
    name: API Support
    email: support@gpt-agent-platform.com
  license:
    name: Private

servers:
  - url: http://localhost:3000
    description: Development server
  - url: https://staging.gpt-agent-platform.com
    description: Staging server
  - url: https://gpt-agent-platform.com
    description: Production server

tags:
  - name: Authentication
    description: Аутентификация и авторизация
  - name: Agents
    description: Управление AI агентами
  - name: Chat
    description: Чат с AI агентами
  - name: Knowledge Base
    description: База знаний (категории и статьи)
  - name: Integrations
    description: Интеграции с CRM системами
  - name: Admin
    description: Административные endpoints (требуется admin роль)
  - name: Health
    description: Health checks и метрики

paths:
  # ==================== CSRF ====================
  /api/csrf-token:
    get:
      tags: [Authentication]
      summary: Получить CSRF токен
      description: Генерирует и возвращает CSRF токен для защиты от CSRF атак
      responses:
        '200':
          description: CSRF токен успешно сгенерирован
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  csrfToken:
                    type: string
                    example: "a8f3h2k9j4l6m1n5o7p2q3r8s9t4u6v1"

  # ==================== AGENTS ====================
  /api/agents:
    get:
      tags: [Agents]
      summary: Получить список агентов
      description: |
        Возвращает список AI агентов с поддержкой фильтрации, поиска и пагинации.

        **Новые фильтры (Задача 4.1):**
        - Фильтрация по модели AI
        - Фильтрация по дате создания (from/to)
      security:
        - sessionAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: Номер страницы
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 100
          description: Количество элементов на странице
        - name: search
          in: query
          schema:
            type: string
          description: Поиск по названию агента
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, draft]
          description: Фильтр по статусу
        - name: model
          in: query
          schema:
            type: string
          description: "Фильтр по AI модели (напр: gpt-4, claude-3-opus)"
        - name: dateFrom
          in: query
          schema:
            type: string
            format: date
          description: Фильтр по дате создания (от)
        - name: dateTo
          in: query
          schema:
            type: string
            format: date
          description: Фильтр по дате создания (до)
      responses:
        '200':
          description: Список агентов
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Agent'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

    post:
      tags: [Agents]
      summary: Создать нового агента
      security:
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentCreate'
      responses:
        '201':
          description: Агент успешно создан
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Agent'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/CSRFError'

  /api/agents/bulk:
    post:
      tags: [Agents]
      summary: Массовые операции над агентами
      description: |
        Выполняет массовые действия над несколькими агентами одновременно.

        **Новая функциональность (Задача 4.2):**
        - Bulk delete
        - Bulk activate/deactivate
        - Bulk update model
      security:
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - agentIds
              properties:
                action:
                  type: string
                  enum: [delete, activate, deactivate, updateModel]
                  description: Действие для выполнения
                agentIds:
                  type: array
                  items:
                    type: string
                  description: Массив ID агентов
                  minItems: 1
                  maxItems: 100
                model:
                  type: string
                  description: Новая модель (только для action=updateModel)
      responses:
        '200':
          description: Операция успешно выполнена
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  processed:
                    type: integer
                    description: Количество обработанных агентов
                  failed:
                    type: integer
                    description: Количество неудачных операций
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        agentId:
                          type: string
                        error:
                          type: string
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/agents/{id}:
    get:
      tags: [Agents]
      summary: Получить агента по ID
      security:
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Данные агента
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Agent'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [Agents]
      summary: Обновить агента
      security:
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentUpdate'
      responses:
        '200':
          description: Агент обновлен
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Agent'

    delete:
      tags: [Agents]
      summary: Удалить агента
      security:
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Агент удален
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ==================== CHAT ====================
  /api/chat:
    post:
      tags: [Chat]
      summary: Отправить сообщение агенту
      description: Отправляет сообщение AI агенту и получает ответ
      security:
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agentId
                - message
              properties:
                agentId:
                  type: string
                message:
                  type: string
                conversationId:
                  type: string
                  description: ID существующей беседы (опционально)
      responses:
        '200':
          description: Ответ от агента
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      response:
                        type: string
                      conversationId:
                        type: string
                      messageId:
                        type: string

  # ==================== ADMIN ====================
  /api/admin/dlq:
    get:
      tags: [Admin]
      summary: Получить задачи из Dead Letter Queue
      description: |
        Возвращает список неудачных задач из DLQ для анализа и retry.

        **Security (Задача 5.1):**
        - Требуется admin роль или admin email в whitelist
      security:
        - adminAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [waiting, completed, failed, all]
            default: all
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            maximum: 1000
      responses:
        '200':
          description: Список DLQ задач
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  stats:
                    type: object
                    properties:
                      waiting:
                        type: integer
                      failed:
                        type: integer
                      completed:
                        type: integer
                  jobs:
                    type: array
                    items:
                      type: object
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/AdminUnauthorized'

  /api/metrics:
    get:
      tags: [Admin, Health]
      summary: Получить Prometheus метрики
      description: |
        Возвращает метрики приложения в формате Prometheus.

        **Security (Задача 5.1):**
        - Требуется admin роль
      security:
        - adminAuth: []
      responses:
        '200':
          description: Prometheus метрики
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP nextjs_http_requests_total Total number of HTTP requests
                  # TYPE nextjs_http_requests_total counter
                  nextjs_http_requests_total{method="GET",route="/api/agents",status_code="200"} 150

  # ==================== HEALTH ====================
  /api/health:
    get:
      tags: [Health]
      summary: Health check
      description: Проверка работоспособности сервиса
      responses:
        '200':
          description: Сервис работает
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time

components:
  securitySchemes:
    sessionAuth:
      type: apiKey
      in: cookie
      name: next-auth.session-token
      description: NextAuth session cookie (автоматически устанавливается после login)

    adminAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Admin Bearer token или session с admin ролью.
        Также можно использовать admin email из ADMIN_EMAILS whitelist.

  parameters:
    CSRFToken:
      name: x-csrf-token
      in: header
      required: true
      schema:
        type: string
      description: CSRF токен (получить через GET /api/csrf-token)

  schemas:
    Agent:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        status:
          type: string
          enum: [active, inactive, draft]
        model:
          type: string
          example: "gpt-4-turbo"
        instructions:
          type: string
        temperature:
          type: number
          minimum: 0
          maximum: 2
        maxTokens:
          type: integer
          minimum: 128
          maximum: 8000
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        messagesTotal:
          type: integer
        lastActivityAt:
          type: string
          format: date-time
          nullable: true

    AgentCreate:
      type: object
      required:
        - name
        - model
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        model:
          type: string
        instructions:
          type: string
        temperature:
          type: number
          minimum: 0
          maximum: 2
          default: 0.7
        maxTokens:
          type: integer
          minimum: 128
          maximum: 8000
          default: 2000

    AgentUpdate:
      type: object
      properties:
        name:
          type: string
        status:
          type: string
          enum: [active, inactive, draft]
        model:
          type: string
        instructions:
          type: string
        temperature:
          type: number
        maxTokens:
          type: integer

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
        code:
          type: string
        details:
          type: array
          items:
            type: string

  responses:
    Unauthorized:
      description: Не авторизован
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error: "Не авторизовано"
            code: "UNAUTHORIZED"

    AdminUnauthorized:
      description: Требуется admin доступ
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error: "Unauthorized - Admin access required"
            code: "ADMIN_REQUIRED"

    BadRequest:
      description: Неверные параметры запроса
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error: "Некорректные данные"
            details: ["name is required", "temperature must be between 0 and 2"]

    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error: "Агент не найден"
            code: "NOT_FOUND"

    RateLimited:
      description: Превышен лимит запросов
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error: "Too many requests"
            code: "RATE_LIMIT_EXCEEDED"
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Максимальное количество запросов
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Оставшееся количество запросов
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Timestamp когда лимит сбросится

    CSRFError:
      description: Невалидный или отсутствующий CSRF токен
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error: "Invalid or missing CSRF token"
            code: "CSRF_VALIDATION_FAILED"
