# 🎓 Система обучения AI-агентов как штатных сотрудников

## 🎯 Цель

Обучить AI-агента полной информацией о компании, чтобы он мог:
- **Знать всю информацию о компании** - продукты, услуги, процессы, стратегия
- **Проводить продажи от 0 до 100** - от первого контакта до закрытия сделки
- **Иметь долгосрочную память (КАГ)** - запоминать факты, предпочтения, паттерны взаимодействий
- **Работать как штатный сотрудник** - использовать скрипты, отвечать на возражения, следовать процессам

## 📊 Архитектура системы

### Компоненты системы:

```
┌─────────────────────────────────────────────────────────────┐
│                    ОБУЧЕНИЕ АГЕНТА                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Структури-  │  │  Скрипты     │  │  Загрузка    │     │
│  │  рованные    │  │  продаж      │  │  файлов      │     │
│  │  знания      │  │              │  │  (RAG)        │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│         │                 │                   │            │
│         └─────────────────┼───────────────────┘            │
│                           │                                 │
│                  ┌─────────▼─────────┐                       │
│                  │  Company          │                       │
│                  │  Knowledge        │                       │
│                  │  (БД)            │                       │
│                  └─────────┬─────────┘                       │
│                            │                                 │
│                  ┌─────────▼─────────┐                       │
│                  │  Knowledge Graph   │                       │
│                  │  (Сущности +      │                       │
│                  │   Связи)          │                       │
│                  └─────────┬─────────┘                       │
│                            │                                 │
│                  ┌─────────▼─────────┐                       │
│                  │  Agent Context    │                       │
│                  │  Builder          │                       │
│                  │  (Сборка всех     │                       │
│                  │   источников)     │                       │
│                  └─────────┬─────────┘                       │
│                            │                                 │
│                  ┌─────────▼─────────┐                       │
│                  │  LLM (OpenRouter)  │                      │
│                  │  С осмысленным     │                      │
│                  │  ответом           │                      │
│                  └────────────────────┘                       │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         Долгосрочная память (Agent Memory)           │  │
│  │  - Факты о клиентах                                  │  │
│  │  - Предпочтения                                      │  │
│  │  - Успешные кейсы                                    │  │
│  │  - Паттерны взаимодействий                           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 📚 Типы знаний

### 1. **Структурированные знания** (`company_knowledge`)

Категории:
- **`company_info`** - информация о компании (миссия, ценности, история, команда)
- **`product`** - продукты компании (описание, характеристики, цены, преимущества)
- **`service`** - услуги компании (что предлагаем, как работаем, результаты)
- **`process`** - бизнес-процессы (как мы работаем, этапы, сроки)
- **`script`** - общие скрипты и шаблоны
- **`objection`** - типовые возражения и ответы

**Привязка к этапам воронки:**
- Можно привязать знание к конкретному этапу (`pipeline_stage_id`)
- Агент будет использовать знание только на этом этапе (или везде, если `pipeline_stage_id = null`)

**Приоритеты:**
- Высокоприоритетные знания включаются первыми
- Низкоприоритетные - если места в контексте достаточно

### 2. **Скрипты продаж** (`sales_scripts`)

Типы скриптов:
- **`greeting`** - приветствие, установление контакта
- **`qualification`** - квалификация клиента (потребности, бюджет, сроки)
- **`presentation`** - презентация продукта/услуги
- **`objection_handling`** - работа с возражениями
- **`closing`** - закрытие сделки

**Персонализация:**
- Переменные в скриптах: `{{clientName}}`, `{{productName}}`, `{{price}}`
- Условия применения: тип клиента, сегмент, источник лида

**Эффективность:**
- Система отслеживает успешность скриптов
- Более эффективные скрипты используются чаще

### 3. **Обработка возражений** (`objection_responses`)

Типы возражений:
- **`price`** - "Слишком дорого"
- **`timing`** - "Не сейчас", "Подумаю"
- **`need`** - "Не нужно", "Не вижу ценности"
- **`competitor`** - "У конкурентов лучше/дешевле"
- **`trust`** - "Не доверяю", "Нужно посоветоваться"

**Контекстные ответы:**
- Разные ответы для разных типов клиентов
- Учитывается этап воронки

### 4. **Загрузка файлов** (`agent_assets`)

Процесс:
1. Загрузка файла → Supabase Storage
2. Worker парсит → извлекает текст
3. Разбивка на chunks → генерация embeddings
4. Сохранение в `knowledge_chunks`
5. Автоматическое извлечение Knowledge Graph

**Результат:**
- Векторный поиск по всем документам
- Knowledge Graph для понимания связей
- Интеграция в общий контекст агента

### 5. **Knowledge Graph** (автоматически)

**Сущности:**
- Люди, организации, продукты, услуги, процессы, концепции
- Автоматически извлекаются из всех источников

**Связи:**
- Кто работает где
- Какие продукты предоставляет компания
- Какие процессы используются
- Зависимости и отношения

**Использование:**
- Агент понимает контекст лучше
- Может находить связи между понятиями
- Улучшает качество ответов

### 6. **Долгосрочная память** (`agent_memory`)

Типы памяти:
- **`fact`** - факты о клиенте ("Клиент Иван любит получать ответы быстро")
- **`preference`** - предпочтения ("Предпочитает общаться по email")
- **`interaction_pattern`** - паттерны ("Всегда задает вопрос о цене в начале")
- **`success_case`** - успешные кейсы ("Клиент купил после упоминания X")
- **`failure_case`** - неудачные попытки ("Не покупал когда упоминали Y")

**Важность:**
- Высокоприоритетные факты всегда в контексте
- Низкоприоритетные - по необходимости

**Валидация:**
- Человек может проверить и подтвердить факты
- Можно удалить неправильные воспоминания

## 🔄 Как работает обучение

### Процесс обработки запроса:

```
1. Пользователь задает вопрос
   ↓
2. Определяется этап воронки (если есть сделка в CRM)
   ↓
3. Agent Context Builder собирает контекст:
   a) Знания компании (для этапа или глобальные)
   b) Скрипты продаж (для текущего этапа)
   c) Ответы на возражения (если обнаружено возражение)
   d) Векторный поиск по всем документам
   e) Knowledge Graph (связанные сущности)
   f) Долгосрочная память (о клиенте)
   g) Инструкции агента
   ↓
4. LLM генерирует ответ с полным контекстом
   ↓
5. Ответ агента сохраняется
   ↓
6. Система извлекает важные факты в память (опционально)
```

### Примеры контекста:

**На этапе "Квалификация":**
- Скрипты квалификации
- Информация о продуктах/услугах (для презентации)
- Процессы работы
- Ответы на типовые вопросы

**При работе с возражением "Цена":**
- Специфические ответы на возражения о цене
- Кейсы успешных продаж
- Альтернативные варианты
- Ценность продукта

**При закрытии сделки:**
- Скрипты закрытия
- Следующие шаги процесса
- Документы для подписания
- Что делать после продажи

## 💡 Рекомендации по обучению

### 1. Структурированные знания

**Что добавить:**
- ✅ Информация о компании (миссия, ценности, достижения)
- ✅ Все продукты с описанием, ценами, преимуществами
- ✅ Все услуги с процессом оказания, результатами
- ✅ Бизнес-процессы (как работаем, сроки, этапы)
- ✅ Часто задаваемые вопросы и ответы

**Приоритеты:**
- Высокий (80-100): критичная информация, которая должна быть всегда
- Средний (40-79): важная информация для контекста
- Низкий (0-39): дополнительная информация

**Связь с этапами:**
- Привязывайте знания к этапам воронки для релевантного контекста
- Глобальные знания доступны везде

### 2. Скрипты продаж

**Для каждого этапа:**
- Приветствие: установление контакта, знакомство
- Квалификация: выяснение потребностей, бюджета, сроков
- Презентация: демонстрация продукта/услуги
- Работа с возражениями: ответы на сомнения
- Закрытие: завершение сделки, договоренности

**Лучшие практики:**
- Используйте переменные для персонализации
- Тестируйте и улучшайте скрипты
- Отслеживайте эффективность

### 3. Загрузка файлов

**Что загружать:**
- Презентации компании
- Документы о продуктах (спецификации, прайсы)
- Регламенты и процессы
- Кейсы и отзывы клиентов
- Обучение и инструкции для сотрудников
- FAQ и документация

**Автоматическая обработка:**
- Файлы автоматически парсятся и разбиваются на chunks
- Генерируются embeddings для векторного поиска
- Извлекается Knowledge Graph

### 4. Knowledge Graph

**Автоматическое извлечение:**
- Происходит при обработке файлов
- Можно запустить вручную для существующих документов
- Постоянно пополняется новой информацией

**Проверка:**
- Периодически проверяйте извлеченные сущности
- Исправляйте ошибки
- Добавляйте важные связи вручную

## 🚀 Запуск обучения

### Через интерфейс:

1. **Перейдите в обучение агента:**
   ```
   /agents/[id]/training
   ```

2. **Добавьте структурированные знания:**
   - Категория → Название → Содержание
   - Приоритет и привязка к этапу (опционально)

3. **Загрузите файлы:**
   - Перетащите документы компании
   - Дождитесь обработки (статус в списке файлов)

4. **Добавьте скрипты продаж:**
   - Для каждого этапа воронки
   - С учетом типа клиента

5. **Настройте обработку возражений:**
   - Тип возражения → Ответ

### Через API:

```typescript
// Добавить знание
POST /api/agents/[id]/knowledge
{
  "category": "product",
  "title": "Наш продукт X",
  "content": "Подробное описание...",
  "priority": 90,
  "pipelineStageId": null,
  "isGlobal": true
}

// Загрузить файл
POST /api/agents/[id]/assets
FormData: file

// Получить знания для контекста
GET /api/agents/[id]/knowledge?stageId=[stageId]
```

## 📈 Мониторинг эффективности

### Метрики:
- **Usage count** - сколько раз использовалось знание/скрипт
- **Effectiveness score** - насколько эффективно (на основе результатов)
- **Memory importance** - важность фактов в памяти

### Улучшение:
- Анализируйте какие знания/скрипты используются чаще
- Улучшайте эффективные скрипты
- Удаляйте неиспользуемые знания
- Обновляйте информацию регулярно

## ✅ Результат

После обучения агент будет:
- ✅ Знать всю информацию о компании
- ✅ Использовать правильные скрипты на каждом этапе
- ✅ Правильно отвечать на возражения
- ✅ Помнить важные факты о клиентах
- ✅ Понимать связи между понятиями (Knowledge Graph)
- ✅ Давать осмысленные ответы на основе всех источников знаний

**Агент становится полноценным штатным сотрудником с полным доступом ко всем знаниям компании!** 🎯









