#!/bin/bash

# ============================================
# –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á–∏ –∏ —Å–æ–∑–¥–∞–µ—Ç —à–∞–±–ª–æ–Ω—ã .env —Ñ–∞–π–ª–æ–≤
# ============================================

set -e

echo "üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

# ============================================
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π
# ============================================

echo "üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π..."

AUTH_SECRET=$(openssl rand -base64 32 | tr -d '\n' | cut -c1-32)
ENCRYPTION_KEY=$(openssl rand -base64 32 | tr -d '\n')
WEBHOOK_SECRET=$(openssl rand -base64 32 | tr -d '\n' | cut -c1-32)

echo "‚úÖ AUTH_SECRET —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${AUTH_SECRET}"
echo "‚úÖ ENCRYPTION_KEY —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${ENCRYPTION_KEY}"
echo "‚úÖ WEBHOOK_SECRET —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${WEBHOOK_SECRET}"
echo ""

# ============================================
# –°–æ–∑–¥–∞–Ω–∏–µ .env.local (–∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞)
# ============================================

echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ .env.local..."

if [ ! -f .env.local ]; then
  cat > .env.local << EOF
# ============================================
# –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–û
# –°–æ–∑–¥–∞–Ω–æ: $(date)
# ============================================

# ============================================
# Supabase Configuration
# ‚ö†Ô∏è –ó–ê–ü–û–õ–ù–ò–¢–ï –†–ï–ê–õ–¨–ù–´–ú–ò –ó–ù–ê–ß–ï–ù–ò–Ø–ú–ò –∏–∑ Supabase Dashboard
# ============================================
NEXT_PUBLIC_SUPABASE_URL="https://<project-id>.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="<anon-key-–∑–¥–µ—Å—å>"
SUPABASE_SERVICE_ROLE_KEY="<service-role-key-–∑–¥–µ—Å—å>"
SUPABASE_DEFAULT_ORGANIZATION_ID="<uuid-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏>"

# ============================================
# Authentication (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ)
# ============================================
AUTH_SECRET="${AUTH_SECRET}"
NEXTAUTH_SECRET="${AUTH_SECRET}"

# ============================================
# Application URLs
# ============================================
BACKEND_API_URL="http://localhost:4000"
NEXT_PUBLIC_APP_URL="http://localhost:3000"

# ============================================
# OpenRouter (–¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM)
# ‚ö†Ô∏è –ü–û–õ–£–ß–ò–¢–ï –∫–ª—é—á –Ω–∞ https://openrouter.ai/keys
# ============================================
OPENROUTER_API_KEY="sk-or-v1-<–≤–∞—à-–∫–ª—é—á-–∑–¥–µ—Å—å>"

# ============================================
# Kommo CRM (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ============================================
KOMMO_OAUTH_REDIRECT_BASE="http://localhost:3000/integrations/kommo/oauth/callback"
KOMMO_WEBHOOK_SECRET="${WEBHOOK_SECRET}"
EOF
  echo "‚úÖ .env.local —Å–æ–∑–¥–∞–Ω"
else
  echo "‚ö†Ô∏è  .env.local —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º"
  echo "   –î–æ–±–∞–≤—å—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ –≤—Ä—É—á–Ω—É—é:"
  echo "   AUTH_SECRET=${AUTH_SECRET}"
  echo "   NEXTAUTH_SECRET=${AUTH_SECRET}"
fi

echo ""

# ============================================
# –°–æ–∑–¥–∞–Ω–∏–µ services/api/.env
# ============================================

echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ services/api/.env..."

mkdir -p services/api

if [ ! -f services/api/.env ]; then
  cat > services/api/.env << EOF
# ============================================
# BACKEND API - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# –°–æ–∑–¥–∞–Ω–æ: $(date)
# ============================================

# ============================================
# Supabase Configuration
# ‚ö†Ô∏è –ó–ê–ü–û–õ–ù–ò–¢–ï –†–ï–ê–õ–¨–ù–´–ú–ò –ó–ù–ê–ß–ï–ù–ò–Ø–ú–ò –∏–∑ Supabase Dashboard
# ============================================
SUPABASE_URL="https://<project-id>.supabase.co"
SUPABASE_SERVICE_ROLE_KEY="<service-role-key-–∑–¥–µ—Å—å>"

# ============================================
# Redis Configuration
# ============================================
REDIS_URL="redis://localhost:6379"

# ============================================
# Encryption Key (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ)
# ============================================
ENCRYPTION_KEY="${ENCRYPTION_KEY}"

# ============================================
# OpenRouter (–¥–ª—è LLM)
# ‚ö†Ô∏è –ü–û–õ–£–ß–ò–¢–ï –∫–ª—é—á –Ω–∞ https://openrouter.ai/keys
# ============================================
OPENROUTER_API_KEY="sk-or-v1-<–≤–∞—à-–∫–ª—é—á-–∑–¥–µ—Å—å>"

# ============================================
# Kommo CRM Configuration
# ============================================
KOMMO_OAUTH_REDIRECT_BASE="http://localhost:3000/integrations/kommo/oauth/callback"
KOMMO_WEBHOOK_SECRET="${WEBHOOK_SECRET}"
EOF
  echo "‚úÖ services/api/.env —Å–æ–∑–¥–∞–Ω"
else
  echo "‚ö†Ô∏è  services/api/.env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º"
  echo "   –î–æ–±–∞–≤—å—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –≤—Ä—É—á–Ω—É—é:"
  echo "   ENCRYPTION_KEY=${ENCRYPTION_KEY}"
fi

echo ""

# ============================================
# –°–æ–∑–¥–∞–Ω–∏–µ services/worker/.env
# ============================================

echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ services/worker/.env..."

mkdir -p services/worker

if [ ! -f services/worker/.env ]; then
  cat > services/worker/.env << EOF
# ============================================
# WORKER - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# –°–æ–∑–¥–∞–Ω–æ: $(date)
# ============================================

# ============================================
# Supabase Configuration
# ‚ö†Ô∏è –ó–ê–ü–û–õ–ù–ò–¢–ï –†–ï–ê–õ–¨–ù–´–ú–ò –ó–ù–ê–ß–ï–ù–ò–Ø–ú–ò –∏–∑ Supabase Dashboard
# ============================================
SUPABASE_URL="https://<project-id>.supabase.co"
SUPABASE_SERVICE_ROLE_KEY="<service-role-key-–∑–¥–µ—Å—å>"

# ============================================
# Redis Configuration
# ============================================
REDIS_URL="redis://localhost:6379"

# ============================================
# Encryption Key (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ)
# –û–î–ò–ù–ê–ö–û–í–´–ô —Å services/api/.env
# ============================================
ENCRYPTION_KEY="${ENCRYPTION_KEY}"

# ============================================
# Job Queue Configuration
# ============================================
JOB_QUEUE_NAME="agent-jobs"
JOB_CONCURRENCY="5"

# ============================================
# OpenRouter (–¥–ª—è LLM)
# ‚ö†Ô∏è –ü–û–õ–£–ß–ò–¢–ï –∫–ª—é—á –Ω–∞ https://openrouter.ai/keys
# ============================================
OPENROUTER_API_KEY="sk-or-v1-<–≤–∞—à-–∫–ª—é—á-–∑–¥–µ—Å—å>"
EOF
  echo "‚úÖ services/worker/.env —Å–æ–∑–¥–∞–Ω"
else
  echo "‚ö†Ô∏è  services/worker/.env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º"
  echo "   –î–æ–±–∞–≤—å—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –≤—Ä—É—á–Ω—É—é:"
  echo "   ENCRYPTION_KEY=${ENCRYPTION_KEY}"
fi

echo ""

# ============================================
# –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
# ============================================

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏"
echo ""
echo "üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo ""
echo "1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö:"
echo "   - .env.local"
echo "   - services/api/.env"
echo "   - services/worker/.env"
echo ""
echo "2. –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á–∏ –∏–∑ Supabase Dashboard:"
echo "   https://supabase.com/dashboard -> Settings -> API"
echo ""
echo "3. –ü–æ–ª—É—á–∏—Ç–µ OpenRouter API –∫–ª—é—á:"
echo "   https://openrouter.ai/keys"
echo ""
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É:"
echo "   npm run check:env"
echo ""
echo "5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Redis (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω):"
echo "   docker run -d -p 6379:6379 redis"
echo "   –∏–ª–∏: redis-server"
echo ""
echo "6. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –≤ Supabase Dashboard:"
echo "   SQL Editor -> –í—Å—Ç–∞–≤–∏—Ç—å scripts/apply-all-setup.sql -> Run"
echo ""

