#!/usr/bin/env node
/**
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –ø–æ–∫—Ä—ã—Ç–∏—è
 * DevOps –ø–æ–¥—Ö–æ–¥: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
 */

const fs = require('fs')
const path = require('path')

/**
 * –ü–∞—Ä—Å–∏—Ç TypeScript —Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏/–∫–ª–∞—Å—Å—ã
 */
function parseExports(content) {
  const exports = []

  // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–æ–≤
  const patterns = [
    // export function funcName
    /export\s+(?:async\s+)?function\s+(\w+)/g,
    // export const funcName =
    /export\s+const\s+(\w+)\s*=/g,
    // export class ClassName
    /export\s+class\s+(\w+)/g,
    // export { name }
    /export\s*{\s*(\w+)/g,
  ]

  patterns.forEach(pattern => {
    let match
    while ((match = pattern.exec(content)) !== null) {
      exports.push(match[1])
    }
  })

  return [...new Set(exports)] // Remove duplicates
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω —Ç–µ—Å—Ç–∞
 */
function generateTestTemplate(filePath, exports) {
  const relativePath = path.relative(process.cwd(), filePath)
  const fileName = path.basename(filePath, '.ts')
  const importPath = relativePath.replace(/^lib\//, '@/lib/')

  let template = `/**
 * Unit tests for ${fileName}
 * Generated by scripts/generate-test-template.js
 */

import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'
`

  // Add imports for the module under test
  if (exports.length > 0) {
    template += `import { ${exports.join(', ')} } from '${importPath}'\n`
  } else {
    template += `import * as ${fileName}Module from '${importPath}'\n`
  }

  template += `
// Mock dependencies
vi.mock('@/lib/supabase/admin', () => ({
  getSupabaseServiceRoleClient: vi.fn(() => ({
    from: vi.fn(() => ({
      select: vi.fn(() => ({ data: [], error: null })),
      insert: vi.fn(() => ({ data: {}, error: null })),
      update: vi.fn(() => ({ data: {}, error: null })),
      delete: vi.fn(() => ({ data: {}, error: null })),
    })),
  })),
}))

describe('${fileName}', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  afterEach(() => {
    vi.restoreAllMocks()
  })

`

  // Generate test stubs for each export
  exports.forEach(exportName => {
    template += `  describe('${exportName}', () => {
    it('should handle happy path', () => {
      // TODO: Implement test
      expect(true).toBe(true)
    })

    it('should handle error case', () => {
      // TODO: Implement error handling test
      expect(true).toBe(true)
    })

    it('should validate input', () => {
      // TODO: Implement input validation test
      expect(true).toBe(true)
    })
  })

`
  })

  template += `})
`

  return template
}

/**
 * Main function
 */
function main() {
  const args = process.argv.slice(2)

  if (args.length === 0) {
    console.error('Usage: node scripts/generate-test-template.js <file-path>')
    console.error('Example: node scripts/generate-test-template.js lib/services/agents.ts')
    process.exit(1)
  }

  const filePath = args[0]

  if (!fs.existsSync(filePath)) {
    console.error(`File not found: ${filePath}`)
    process.exit(1)
  }

  console.log(`üîç Analyzing ${filePath}...`)

  const content = fs.readFileSync(filePath, 'utf-8')
  const exports = parseExports(content)

  console.log(`  Found ${exports.length} exports: ${exports.join(', ') || 'none'}`)

  // Generate test template
  const template = generateTestTemplate(filePath, exports)

  // Determine output path
  const relativePath = path.relative('lib', filePath)
  const testDir = path.join('tests', 'unit', path.dirname(relativePath))
  const testFileName = path.basename(filePath, '.ts') + '.test.ts'
  const testPath = path.join(testDir, testFileName)

  // Create directory if it doesn't exist
  if (!fs.existsSync(testDir)) {
    fs.mkdirSync(testDir, { recursive: true })
    console.log(`  Created directory: ${testDir}`)
  }

  // Check if test file already exists
  if (fs.existsSync(testPath)) {
    console.log(`\n‚ö†Ô∏è  Test file already exists: ${testPath}`)
    console.log('   Overwrite? (y/n): ')

    // For automation, skip overwrite check
    if (process.env.AUTO_OVERWRITE !== 'true') {
      console.log('   Skipping (set AUTO_OVERWRITE=true to force)')
      return
    }
  }

  // Write test file
  fs.writeFileSync(testPath, template, 'utf-8')

  console.log(`\n‚úÖ Test template generated: ${testPath}`)
  console.log('\nüìã Next steps:')
  console.log(`  1. Open ${testPath}`)
  console.log('  2. Replace TODO comments with actual tests')
  console.log('  3. Run tests: npx vitest run ' + testPath)
  console.log('  4. Check coverage: VITEST_COVERAGE=true npx vitest run')
}

main()
