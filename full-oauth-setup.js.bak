#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const https = require('https');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
const CONFIG = {
  clientId: '2a5c1463-43dd-4ccc-abd0-79516f785e57',
  clientSecret: '6FhlKjCZehELKIShuUQcPHdrF9uUHKLQosf0tDsSvdTuUoahVz3EO44xzVinlbh7',
  redirectUri: 'https://gpt-agent-kwid-43ii46hai-world-wide-services-62780b79.vercel.app/integrations/kommo/oauth/callback',
  domain: 'kwid'
};

console.log('üöÄ –ü–û–õ–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê KOMMO OAUTH\n');
console.log('='.repeat(50));

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const req = https.request(url, options, (res) => {
      let data = '';
      res.on('data', (chunk) => data += chunk);
      res.on('end', () => {
        try {
          const json = JSON.parse(data);
          resolve({ status: res.statusCode, data: json });
        } catch (e) {
          resolve({ status: res.statusCode, data, raw: true });
        }
      });
    });
    req.on('error', reject);
    if (options.body) req.write(options.body);
    req.end();
  });
}

// –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
async function checkExistingTokens() {
  console.log('üìã –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤...');

  const envPath = path.join(__dirname, '.env.local');
  if (!fs.existsSync(envPath)) {
    console.log('‚ùå –§–∞–π–ª .env.local –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return false;
  }

  const envContent = fs.readFileSync(envPath, 'utf8');
  const accessToken = envContent.match(/KOMMO_TEST_ACCESS_TOKEN=(.+)/)?.[1];

  if (!accessToken) {
    console.log('‚ùå –¢–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ .env.local');
    return false;
  }

  console.log('‚úÖ –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º...');

  try {
    const response = await makeRequest(`https://${CONFIG.domain}.amocrm.ru/api/v4/users`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.status === 200) {
      console.log('‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–∫–µ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç!');
      return true;
    } else {
      console.log('‚ùå –¢–æ–∫–µ–Ω—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–µ');
      return false;
    }
  } catch (error) {
    console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤:', error.message);
    return false;
  }
}

// –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ OAuth URL
function generateOAuthUrl() {
  console.log('\nüìã –®–ê–ì 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è OAuth URL...');

  const params = new URLSearchParams({
    client_id: CONFIG.clientId,
    redirect_uri: CONFIG.redirectUri,
    scope: 'crm:read crm:write leads:read leads:write contacts:read contacts:write tasks:read tasks:write',
    state: `auto_setup_${Date.now()}`,
    response_type: 'code'
  });

  const oauthUrl = `https://kommo.com/oauth?${params.toString()}`;
  console.log('‚úÖ OAuth URL —Å–æ–∑–¥–∞–Ω');
  console.log('üîó', oauthUrl);

  return oauthUrl;
}

// –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ authorization code
async function getAuthorizationCode(oauthUrl) {
  console.log('\nüìã –®–ê–ì 3: –ü–æ–ª—É—á–µ–Ω–∏–µ authorization code');

  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  console.log('\nüîó –û—Ç–∫—Ä—ã–≤–∞—é –±—Ä–∞—É–∑–µ—Ä —Å OAuth URL...');
  try {
    const { exec } = require('child_process');
    if (process.platform === 'darwin') {
      exec(`open "${oauthUrl}"`);
    } else if (process.platform === 'linux') {
      exec(`xdg-open "${oauthUrl}"`);
    } else {
      exec(`start "${oauthUrl}"`);
    }
    console.log('‚úÖ –ë—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä—ã—Ç');
  } catch (error) {
    console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
    console.log('üîó –û—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', oauthUrl);
  }

  console.log('\nüéØ –î–ï–ô–°–¢–í–ò–Ø:');
  console.log('1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Kommo (–µ—Å–ª–∏ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—ã—à–µ)');
  console.log('2. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é');
  console.log('3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ü–û–õ–ù–´–ô URL –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
  console.log('4. –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ —Å—é–¥–∞');

  return new Promise((resolve) => {
    console.log('\nüìù –í—Å—Ç–∞–≤—å—Ç–µ URL –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:');

    process.stdin.setEncoding('utf8');
    process.stdin.on('data', (data) => {
      const url = data.toString().trim();
      if (url.includes('code=')) {
        const code = url.match(/code=([^&]+)/)?.[1];
        if (code) {
          console.log('‚úÖ –ö–æ–¥ –∏–∑–≤–ª–µ—á–µ–Ω:', code.substring(0, 20) + '...');
          resolve(code);
        } else {
          console.log('‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:');
        }
      } else {
        console.log('‚ùå URL –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç code, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:');
      }
    });
  });
}

// –®–∞–≥ 4: –û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã
async function exchangeCodeForTokens(code) {
  console.log('\nüìã –®–ê–ì 4: –û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã...');

  try {
    const response = await makeRequest('https://kommo.com/oauth/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        client_id: CONFIG.clientId,
        client_secret: CONFIG.clientSecret,
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: CONFIG.redirectUri,
      }).toString()
    });

    if (response.status === 200 && response.data.access_token) {
      console.log('‚úÖ –¢–æ–∫–µ–Ω—ã –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
      console.log('üîë Access Token:', response.data.access_token.substring(0, 20) + '...');
      if (response.data.refresh_token) {
        console.log('üîÑ Refresh Token:', response.data.refresh_token.substring(0, 20) + '...');
      }
      return response.data;
    } else {
      console.log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤:', response.data);
      return null;
    }
  } catch (error) {
    console.log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:', error.message);
    return null;
  }
}

// –®–∞–≥ 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env.local
function updateEnvFile(tokens) {
  console.log('\nüìã –®–ê–ì 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env.local...');

  const envPath = path.join(__dirname, '.env.local');
  let envContent = '';

  if (fs.existsSync(envPath)) {
    envContent = fs.readFileSync(envPath, 'utf8');
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  const lines = envContent.split('\n');
  const updatedLines = [];
  let accessTokenUpdated = false;
  let refreshTokenUpdated = false;

  for (const line of lines) {
    if (line.startsWith('KOMMO_TEST_ACCESS_TOKEN=')) {
      updatedLines.push(`KOMMO_TEST_ACCESS_TOKEN=${tokens.access_token}`);
      accessTokenUpdated = true;
    } else if (line.startsWith('KOMMO_TEST_REFRESH_TOKEN=')) {
      updatedLines.push(`KOMMO_TEST_REFRESH_TOKEN=${tokens.refresh_token || ''}`);
      refreshTokenUpdated = true;
    } else {
      updatedLines.push(line);
    }
  }

  if (!accessTokenUpdated) {
    updatedLines.push(`KOMMO_TEST_ACCESS_TOKEN=${tokens.access_token}`);
  }
  if (!refreshTokenUpdated) {
    updatedLines.push(`KOMMO_TEST_REFRESH_TOKEN=${tokens.refresh_token || ''}`);
  }

  fs.writeFileSync(envPath, updatedLines.join('\n'), 'utf8');
  console.log('‚úÖ –§–∞–π–ª .env.local –æ–±–Ω–æ–≤–ª–µ–Ω!');
}

// –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
async function testTokens() {
  console.log('\nüìã –®–ê–ì 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤...');

  const envPath = path.join(__dirname, '.env.local');
  const envContent = fs.readFileSync(envPath, 'utf8');
  const accessToken = envContent.match(/KOMMO_TEST_ACCESS_TOKEN=(.+)/)?.[1];

  if (!accessToken) {
    console.log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env.local');
    return false;
  }

  try {
    const response = await makeRequest(`https://${CONFIG.domain}.amocrm.ru/api/v4/users`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.status === 200) {
      console.log('‚úÖ –¢–æ–∫–µ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç! API –¥–æ—Å—Ç—É–ø–µ–Ω');
      return true;
    } else {
      console.log('‚ùå –¢–æ–∫–µ–Ω—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, —Å—Ç–∞—Ç—É—Å:', response.status);
      return false;
    }
  } catch (error) {
    console.log('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error.message);
    return false;
  }
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async function main() {
  try {
    // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
    const tokensWorking = await checkExistingTokens();
    if (tokensWorking) {
      console.log('\nüéâ –¢–æ–∫–µ–Ω—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç! –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.');
      return;
    }

    // –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è OAuth URL
    const oauthUrl = generateOAuthUrl();

    // –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
    const code = await getAuthorizationCode(oauthUrl);

    // –®–∞–≥ 4: –û–±–º–µ–Ω –Ω–∞ —Ç–æ–∫–µ–Ω—ã
    const tokens = await exchangeCodeForTokens(code);
    if (!tokens) {
      console.log('\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
      return;
    }

    // –®–∞–≥ 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env
    updateEnvFile(tokens);

    // –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    const testResult = await testTokens();

    if (testResult) {
      console.log('\nüéâ –£–°–ü–ï–•! Kommo –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞!');
      console.log('\nüöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å:');
      console.log('npx tsx test-kommo.ts');
    } else {
      console.log('\n‚ùå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å, –Ω–æ —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
    }

  } catch (error) {
    console.log('\nüí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error.message);
  }
}

// –ó–∞–ø—É—Å–∫
if (require.main === module) {
  main();
}
