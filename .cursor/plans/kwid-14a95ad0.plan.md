<!-- 14a95ad0-bd7a-4258-bff0-310129cc8b7e a713905b-21ff-477d-88fb-260c0fd4a12b -->
# План создания реплики Kwid

## Приоритет: Страница за страницей, модуль за модулем

### Методология выполнения (MSP + Playwright)
- Каждую задачу вести через MSP-оркестратор: фиксировать начальное состояние, шаги и результаты (логи Supabase/Vercel, скриншоты при необходимости).
- После изменений обновлять или добавлять Playwright-сценарии, подтверждающие новый функционал.
- Прогон обязательных команд:
  - `npm run lint`
  - `npm run build`
  - `PWTEST_WEB_SERVER_TIMEOUT=300000 npx playwright test --project=chromium --tests=<целевые спек-файлы>`
- Для API/регистрации использовать curl или Postman и прикладывать ответ.
- Любые изменения в Supabase сопровождать миграциями (`supabase/migrations`) и логировать шаги в MSP-записи.
- Перед закрытием задачи — фиксация отчёта: что изменено, какие тесты/команды запускались, скриншот/лог успешного сценария.
- Использовать подготовленный браузерный профиль/аккаунт (есть доступ к Supabase, Kommo, Kwid и Vercel). Все проверки UI (в том числе Playwright headed-режим) выполняются под этими учётными данными, чтобы иметь доступ ко всем сервисам и деплою. Если требуется новый деплой — открывать Vercel и запускать его из той же сессии.

### ФАЗА 0: Инфраструктура и Supabase *(уже выполнено, оставить как чек-лист на будущее)*

> Поскольку регистрация и логин уже работают, эти действия отмечаем как пройденные. Блок сохраняем, чтобы оркестратор мог быстро свериться при повторной настройке или на новом окружении.

#### Задача 0.1: Настроить переменные окружения
- Убедиться что в окружении заданы реальные значения:
  - `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
  - `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY` (должны совпадать с серверными)
  - `NEXTAUTH_SECRET`, `OPENROUTER_API_KEY`, `JWT_SECRET`, `ENCRYPTION_KEY`
  - `SUPABASE_DEFAULT_ORGANIZATION_ID` (опционально, после создания первой организации)
- Прогнать `npm run check:env` — команда должна завершиться без ошибок.

#### Задача 0.2: Применить схему и миграции Supabase
- Через Supabase CLI (`supabase db push`) или вручную в SQL Editor выполнить:
  - `supabase/schema.sql`
  - все файлы из `supabase/migrations/`
  - при необходимости — `supabase/seed.sql` (демо-данные).
- Создать storage bucket `agent-assets` и применить `scripts/create-storage-bucket.sql`.
- Убедиться, что функции и RLS-политики (`scripts/setup-production-database.sql`) активны.

#### Задача 0.3: Проверить регистрацию и вход
- Запустить `npm run dev` (или открыть продакшен URL) и выполнить POST `/api/auth/register` с тестовыми данными.
- Убедиться, что в Supabase появляются записи в `users`, `organizations`, `organization_members`.
- Проверить вход (`/login`) и работу protected-страниц `/manage/{tenantId}` — не должно быть `Failed to fetch`.
- Если получаетcя ошибка, сохранить лог из Supabase (Database → Logs) и устранить причину.

#### Задача 0.4: Финальная проверка перед деплоем
- `npm run build`
- При активном dev-сервере: `PWTEST_WEB_SERVER_TIMEOUT=300000 npx playwright test` или запустить критичные спеки (`tests/navigation-links.spec.ts`, `tests/tenant-navigation.spec.ts`).
- Сформировать короткий отчёт: какая команда выполнялась, какое состояние Supabase, подтверждение успешной регистрации/логина.

### ФАЗА 1: Страница интеграций агента (`/agents/[id]/available-integrations`)

#### Задача 1.1: Создать страницу списка интеграций (100% копия Kwid)

**URL:** `/manage/{tenantId}/ai-agents/{agentId}/available-integrations`

**Что нужно сделать:**

1. Создать страницу `app/(protected)/manage/[tenantId]/ai-agents/[id]/available-integrations/page.tsx`
2. Создать компонент `components/integrations/AvailableIntegrationsTable.tsx`:

- Таблица с колонками: Интеграция, Установлено, Активно, Actions
- Строки для каждой интеграции (Kommo, Google Calendar, и т.д.)
- Для установленных: зеленые галочки в колонках "Установлено" и "Активно", кнопка "Настройки"
- Для не установленных: серые крестики, кнопка "Установить"
- Поиск по интеграциям
- Навигационные табы как в Kwid (Основные, Сделки и контакты, Триггеры, Цепочки, Интеграции, Дополнительно)

**Файлы для изменения:**

- `app/(protected)/manage/[tenantId]/ai-agents/[id]/available-integrations/page.tsx` (создать)
- `components/integrations/AvailableIntegrationsTable.tsx` (создать)
- `components/integrations/IntegrationsTable.tsx` (возможно обновить)

**UI элементы (100% идентично Kwid):**

- Breadcrumb: "Агенты ИИ > {Название агента} > Интеграции"
- Заголовок "Интеграции"
- Табы навигации (те же что в AgentEditForm)
- Поиск с иконкой лупы
- Таблица с идентичным дизайном
- Иконки для статусов (галочки/крестики)
- Кнопки "Настройки" и "Установить" с правильными иконками
- ➕ После реализации: добавить/обновить Playwright-сценарий (например, `tests/tenant-navigation.spec.ts`) и прогнать `PWTEST_WEB_SERVER_TIMEOUT=300000 npx playwright test --grep \"Интеграции\"`.

#### Задача 1.2: Страница настроек интеграции Kommo

**URL:** `/manage/{tenantId}/ai-agents/{agentId}/integrations/{integrationId}/edit`

**Что нужно сделать:**

1. Создать страницу `app/(protected)/manage/[tenantId]/ai-agents/[id]/integrations/[integrationId]/edit/page.tsx`
2. Создать компонент `components/integrations/KommoIntegrationSettings.tsx`:

- Секция "Общие настройки":
- Switch "Активно" (включен/выключен) с описанием
- Кнопка "Синхронизировать настройки CRM" с иконкой refresh
- Кнопки внизу: "Сохранить изменения" (синяя), "Отменить" (серая)
- Табы навигации (те же что в AgentEditForm)

**Файлы для изменения:**

- `app/(protected)/manage/[tenantId]/ai-agents/[id]/integrations/[integrationId]/edit/page.tsx` (создать)
- `components/integrations/KommoIntegrationSettings.tsx` (создать)

**Функциональность:**

- Переключение активности интеграции (сохранение в БД)
- Кнопка "Синхронизировать настройки CRM" - вызывает синхронизацию воронок, полей, каналов из Kommo
- API endpoint для синхронизации: `/api/agents/[id]/integrations/[integrationId]/sync`

**UI элементы (100% идентично Kwid):**

- Breadcrumb: "Агенты ИИ > {Название агента} > Интеграции > Kommo"
- Заголовок "Kommo"
- Табы навигации
- Белая карточка с заголовком "Общие настройки"
- Switch "Активно" в правильном стиле
- Кнопка синхронизации с иконкой
- Кнопки внизу страницы
- ➕ После реализации: обновить Playwright-тест, который проверяет переключение активности/синхронизацию, и приложить MSP-отчёт со скриншотом.

#### Задача 1.3: Функционал подключения CRM на странице интеграций

**Что нужно сделать:**

1. Если Kommo не установлена - добавить функционал установки:

- При нажатии "Установить" открывается модалка или переход на страницу подключения
- Форма подключения через OAuth (кнопка "Подключить Kommo")
- После успешного подключения - редирект обратно на страницу интеграций

2. Два метода подключения (временно):

- Метод 1: Прямой OAuth flow (как сейчас работает)
- Метод 2: Ручной ввод Client ID/Secret (для тестирования)

**Файлы для изменения:**

- `components/integrations/AvailableIntegrationsTable.tsx` (добавить обработчик "Установить")
- `app/api/agents/[id]/integrations/[integrationId]/install/route.ts` (создать)
- `components/integrations/InstallKommoModal.tsx` (создать, опционально)

### ФАЗА 2: Проверка и тестирование страницы интеграций

#### Задача 2.1: Визуальное сравнение

- Сделать скриншот страницы интеграций в Kwid
- Сделать скриншот нашей страницы
- Сравнить: таблица, стили, иконки, кнопки, цвета, отступы
- Исправить все расхождения

#### Задача 2.2: Функциональное тестирование

- Проверить работу поиска
- Проверить установку/удаление интеграций
- Проверить переключение активности
- Проверить синхронизацию CRM
- Проверить навигацию по табам

### ФАЗА 3: Остальные модули (следующие итерации)

После завершения страницы интеграций переходим к:

- Вкладка "Основные" в настройках агента
- Вкладка "Сделки и контакты"
- Вкладка "Триггеры"
- Вкладка "Цепочки"
- Функционал отправки email через сделки

## Технические детали

### Компоненты для создания/обновления:

- `components/integrations/AvailableIntegrationsTable.tsx`
- `components/integrations/KommoIntegrationSettings.tsx`
- `components/integrations/InstallKommoModal.tsx` (опционально)

### API Endpoints для создания:

- `GET /api/agents/[id]/integrations` - список интеграций агента
- `POST /api/agents/[id]/integrations/[integrationId]/install` - установка интеграции
- `POST /api/agents/[id]/integrations/[integrationId]/sync` - синхронизация CRM
- `PATCH /api/agents/[id]/integrations/[integrationId]` - обновление настроек (активность)

### База данных:

- Проверить структуру таблицы `agent_integrations` (если нет - создать миграцию)
- Поля: `id`, `agent_id`, `integration_type` (kommo, google_calendar, etc), `is_installed`, `is_active`, `settings` (JSONB)

### Стили и компоненты:

- Использовать существующие Kwid компоненты (`KwidButton`, `KwidTable`, `KwidTabs`, etc)
- Стили должны точно совпадать с Kwid (проверить через браузер и скриншоты)

## Дополнительные важные детали

### Иконки и стили:

- Использовать те же иконки что в Kwid (проверить через browser snapshot)
- Иконка для "Установлено" - зеленая галочка (CheckCircle)
- Иконка для "Не установлено" - серый крестик (XCircle)
- Иконка для кнопки "Синхронизировать" - RefreshCw или аналогичная
- Иконка для кнопки "Настройки" - Settings (gear)
- Иконка для кнопки "Установить" - Link2 или Plus

### Breadcrumbs:

- Реализовать компонент `components/navigation/Breadcrumbs.tsx` если нет
- Формат: "Агенты ИИ > {Название агента} > Интеграции"
- Каждый элемент - кликабельная ссылка
- Использовать иконки разделителей как в Kwid

### Состояния загрузки:

- Кнопка "Синхронизировать настройки CRM" - показать spinner при загрузке
- Кнопка "Установить" - disabled состояние при установке
- Таблица - skeleton loader при загрузке списка интеграций

### Обработка ошибок:

- Toast уведомления при ошибках установки/синхронизации
- Валидация OAuth callback
- Обработка истекших токенов при синхронизации

### URL структура (проверить в Kwid):

- Страница интеграций: `/manage/{tenantId}/ai-agents/{agentId}/available-integrations`
- Настройки интеграции: `/manage/{tenantId}/ai-agents/{agentId}/integrations/{integrationId}/edit`
- Убедиться что URL структура точно совпадает с Kwid

### Табы навигации:

- Использовать те же табы что в `AgentEditForm`: Основные, Сделки и контакты, Триггеры, Цепочки, Интеграции, Дополнительно
- Активный таб - "Интеграции"
- Табы должны вести на соответствующие разделы редактирования агента

### Изучение документации Kommo:

- Изучить документацию Kommo по отправке email через API
- Проверить метод `note_type: 'mail_message'` - поддерживает ли реальную отправку или только создание заметок
- Если нужен другой метод - изучить альтернативы через Kommo API
- Добавить в план реализацию после завершения базовых страниц

## Примечания

1. **Приоритет**: Завершить страницу интеграций полностью перед переходом к следующей
2. **Метод работы**: Страница за страницей, с визуальным сравнением через скриншоты
3. **Два метода подключения CRM**: Временно оставить оба метода, убрать один из них позже когда все будет работать
4. **Email функционал**: Будет реализован после завершения базовых страниц, после изучения документации Kommo
5. **Детальное сравнение**: При создании каждой страницы делать детальные скриншоты Kwid и сравнивать каждый элемент (цвета, отступы, размеры шрифтов)

### To-dos

- [ ] Создать страницу /manage/[tenantId]/ai-agents/[id]/available-integrations с таблицей интеграций (100% копия Kwid)
- [ ] Создать компонент AvailableIntegrationsTable с таблицей (Интеграция, Установлено, Активно, Actions)
- [ ] Создать страницу настроек Kommo /manage/[tenantId]/ai-agents/[id]/integrations/[integrationId]/edit с секцией Общие настройки
- [ ] Реализовать кнопку Синхронизировать настройки CRM с функционалом синхронизации воронок, полей, каналов
- [ ] Добавить функционал установки Kommo с двумя методами (OAuth и ручной ввод) на странице интеграций
- [ ] Создать API endpoints для работы с интеграциями (GET, POST, PATCH)
- [ ] Сделать скриншоты страниц в Kwid и нашем сервисе, сравнить и исправить все расхождения
- [ ] Протестировать весь функционал страницы интеграций (поиск, установка, синхронизация, навигация)
